// Styles
import './VRangeSlider.sass';
// Components
import VSlider from '../VSlider';
// Helpers
import { addOnceEventListener, createRange, deepEqual, passiveSupported, } from '../../util/helpers';
/* @vue/component */
export default VSlider.extend({
    name: 'v-range-slider',
    props: {
        value: {
            type: Array,
            default: () => ([0, 0]),
        },
    },
    data() {
        return {
            activeThumb: null,
            lazyValue: this.value,
        };
    },
    computed: {
        classes() {
            return {
                ...VSlider.options.computed.classes.call(this),
                'v-input--range-slider': true,
            };
        },
        internalValue: {
            get() {
                return this.lazyValue;
            },
            set(val) {
                // Round value to ensure the
                // entire slider range can
                // be selected with step
                let value = val.map((v = 0) => this.roundValue(Math.min(Math.max(v, this.minValue), this.maxValue)));
                // Switch values if range and wrong order
                if (value[0] > value[1] || value[1] < value[0]) {
                    if (this.activeThumb !== null) {
                        const toFocus = this.activeThumb === 1 ? 0 : 1;
                        const el = this.$refs[`thumb_${toFocus}`];
                        el.focus();
                    }
                    value = [value[1], value[0]];
                }
                this.lazyValue = value;
                if (!deepEqual(value, this.value))
                    this.$emit('input', value);
                this.validate();
            },
        },
        inputWidth() {
            return this.internalValue.map((v) => (this.roundValue(v) - this.minValue) / (this.maxValue - this.minValue) * 100);
        },
    },
    methods: {
        getTrackStyle(startLength, endLength, startPadding = 0, endPadding = 0) {
            const startDir = this.vertical ? this.$vuetify.rtl ? 'top' : 'bottom' : this.$vuetify.rtl ? 'right' : 'left';
            const endDir = this.vertical ? 'height' : 'width';
            const start = `calc(${startLength}% + ${startPadding}px)`;
            const end = `calc(${endLength}% + ${endPadding}px)`;
            return {
                transition: this.trackTransition,
                [startDir]: start,
                [endDir]: end,
            };
        },
        getIndexOfClosestValue(arr, v) {
            if (Math.abs(arr[0] - v) < Math.abs(arr[1] - v))
                return 0;
            else
                return 1;
        },
        genInput() {
            return createRange(2).map(i => {
                const input = VSlider.options.methods.genInput.call(this);
                input.data = input.data || {};
                input.data.attrs = input.data.attrs || {};
                input.data.attrs.value = this.internalValue[i];
                input.data.attrs.id = `input-${i ? 'max' : 'min'}-${this._uid}`;
                return input;
            });
        },
        genTrackContainer() {
            const children = [];
            const padding = this.isDisabled ? 10 : 0;
            const sections = [
                {
                    class: 'v-slider__track-background',
                    color: this.computedTrackColor,
                    styles: [0, this.inputWidth[0], 0, -padding],
                },
                {
                    class: this.isDisabled ? 'v-slider__track-background' : 'v-slider__track-fill',
                    color: this.isDisabled ? this.computedTrackColor : this.computedTrackFillColor,
                    styles: [this.inputWidth[0], Math.abs(this.inputWidth[1] - this.inputWidth[0]), padding, padding * -2],
                },
                {
                    class: 'v-slider__track-background',
                    color: this.computedTrackColor,
                    styles: [this.inputWidth[1], Math.abs(100 - this.inputWidth[1]), padding, -padding],
                },
            ];
            if (this.$vuetify.rtl)
                sections.reverse();
            children.push(...sections.map(section => this.$createElement('div', this.setBackgroundColor(section.color, {
                staticClass: section.class,
                style: this.getTrackStyle(...section.styles),
            }))));
            return this.$createElement('div', {
                staticClass: 'v-slider__track-container',
                ref: 'track',
            }, children);
        },
        genChildren() {
            return [
                this.genInput(),
                this.genTrackContainer(),
                this.genSteps(),
                createRange(2).map(index => {
                    const value = this.internalValue[index];
                    const onFocus = (e) => {
                        this.isFocused = true;
                        this.activeThumb = index;
                        this.$emit('focus', e);
                    };
                    const onBlur = (e) => {
                        this.isFocused = false;
                        this.activeThumb = null;
                        this.$emit('blur', e);
                    };
                    const valueWidth = this.inputWidth[index];
                    const isActive = this.isActive && this.activeThumb === index;
                    const isFocused = this.isFocused && this.activeThumb === index;
                    return this.genThumbContainer(value, valueWidth, isActive, isFocused, onFocus, onBlur, `thumb_${index}`);
                }),
            ];
        },
        reevaluateSelected(value) {
            this.activeThumb = this.getIndexOfClosestValue(this.internalValue, value);
            const refName = `thumb_${this.activeThumb}`;
            const thumbRef = this.$refs[refName];
            thumbRef.focus();
        },
        onSliderMouseDown(e) {
            const value = this.parseMouseMove(e);
            this.reevaluateSelected(value);
            this.oldValue = this.internalValue;
            this.isActive = true;
            if (e.target?.matches('.v-slider__thumb-container, .v-slider__thumb-container *')) {
                this.thumbPressed = true;
                const domRect = e.target.getBoundingClientRect();
                const touch = 'touches' in e ? e.touches[0] : e;
                this.startOffset = this.vertical
                    ? touch.clientY - (domRect.top + domRect.height / 2)
                    : touch.clientX - (domRect.left + domRect.width / 2);
            }
            else {
                this.startOffset = 0;
                window.clearTimeout(this.mouseTimeout);
                this.mouseTimeout = window.setTimeout(() => {
                    this.thumbPressed = true;
                }, 300);
            }
            const mouseUpOptions = passiveSupported ? { passive: true, capture: true } : true;
            const mouseMoveOptions = passiveSupported ? { passive: true } : false;
            const isTouchEvent = 'touches' in e;
            this.onMouseMove(e);
            this.app.addEventListener(isTouchEvent ? 'touchmove' : 'mousemove', this.onMouseMove, mouseMoveOptions);
            addOnceEventListener(this.app, isTouchEvent ? 'touchend' : 'mouseup', this.onSliderMouseUp, mouseUpOptions);
            this.$emit('start', this.internalValue);
        },
        onSliderClick(e) {
            if (!this.isActive) {
                if (this.noClick) {
                    this.noClick = false;
                    return;
                }
                const value = this.parseMouseMove(e);
                this.reevaluateSelected(value);
                this.setInternalValue(value);
                this.$emit('change', this.internalValue);
            }
        },
        onMouseMove(e) {
            const value = this.parseMouseMove(e);
            if (e.type === 'mousemove') {
                this.thumbPressed = true;
            }
            if (this.activeThumb === null) {
                this.activeThumb = this.getIndexOfClosestValue(this.internalValue, value);
            }
            this.setInternalValue(value);
        },
        onKeyDown(e) {
            if (this.activeThumb === null)
                return;
            const value = this.parseKeyDown(e, this.internalValue[this.activeThumb]);
            if (value == null)
                return;
            this.setInternalValue(value);
            this.$emit('change', this.internalValue);
        },
        setInternalValue(value) {
            this.internalValue = this.internalValue.map((v, i) => {
                if (i === this.activeThumb)
                    return value;
                else
                    return Number(v);
            });
        },
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlJhbmdlU2xpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvVlJhbmdlU2xpZGVyL1ZSYW5nZVNsaWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTO0FBQ1QsT0FBTyxxQkFBcUIsQ0FBQTtBQUU1QixhQUFhO0FBQ2IsT0FBTyxPQUFPLE1BQU0sWUFBWSxDQUFBO0FBRWhDLFVBQVU7QUFDVixPQUFPLEVBQ0wsb0JBQW9CLEVBQ3BCLFdBQVcsRUFDWCxTQUFTLEVBQ1QsZ0JBQWdCLEdBQ2pCLE1BQU0sb0JBQW9CLENBQUE7QUFLM0Isb0JBQW9CO0FBQ3BCLGVBQWUsT0FBTyxDQUFDLE1BQU0sQ0FBQztJQUM1QixJQUFJLEVBQUUsZ0JBQWdCO0lBRXRCLEtBQUssRUFBRTtRQUNMLEtBQUssRUFBRTtZQUNMLElBQUksRUFBRSxLQUFLO1lBQ1gsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDc0I7S0FDaEQ7SUFFRCxJQUFJO1FBQ0YsT0FBTztZQUNMLFdBQVcsRUFBRSxJQUFxQjtZQUNsQyxTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUs7U0FDdEIsQ0FBQTtJQUNILENBQUM7SUFFRCxRQUFRLEVBQUU7UUFDUixPQUFPO1lBQ0wsT0FBTztnQkFDTCxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO2dCQUM5Qyx1QkFBdUIsRUFBRSxJQUFJO2FBQzlCLENBQUE7UUFDSCxDQUFDO1FBQ0QsYUFBYSxFQUFFO1lBQ2IsR0FBRztnQkFDRCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUE7WUFDdkIsQ0FBQztZQUNELEdBQUcsQ0FBRSxHQUFhO2dCQUNoQiw0QkFBNEI7Z0JBQzVCLDBCQUEwQjtnQkFDMUIsd0JBQXdCO2dCQUN4QixJQUFJLEtBQUssR0FBRyxHQUFH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O1FBQzlCLENBQUM7UUFDRCxTQUFTLENBQUUsQ0FBZ0I7WUFDekIsSUFBSSxJQUFJLENBQUMsV0FBVyxLQUFLLElBQUk7Z0JBQUUsT0FBTTtZQUVyQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFBO1lBRXhFLElBQUksS0FBSyxJQUFJLElBQUk7Z0JBQUUsT0FBTTtZQUV6QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUE7WUFDNUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFBO1FBQzFDLENBQUM7UUFDRCxnQkFBZ0IsQ0FBRSxLQUFhO1lBQzdCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFTLEVBQUUsQ0FBUyxFQUFFLEVBQUU7Z0JBQ25FLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxXQUFXO29CQUFFLE9BQU8sS0FBSyxDQUFBOztvQkFDbkMsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDdkIsQ0FBQyxDQUFDLENBQUE7UUFDSixDQUFDO0tBQ0Y7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTdHlsZXNcbmltcG9ydCAnLi9WUmFuZ2VTbGlkZXIuc2FzcydcblxuLy8gQ29tcG9uZW50c1xuaW1wb3J0IFZTbGlkZXIgZnJvbSAnLi4vVlNsaWRlcidcblxuLy8gSGVscGVyc1xuaW1wb3J0IHtcbiAgYWRkT25jZUV2ZW50TGlzdGVuZXIsXG4gIGNyZWF0ZVJhbmdlLFxuICBkZWVwRXF1YWwsXG4gIHBhc3NpdmVTdXBwb3J0ZWQsXG59IGZyb20gJy4uLy4uL3V0aWwvaGVscGVycydcblxuLy8gVHlwZXNcbmltcG9ydCB7IFByb3BWYWxpZGF0b3IgfSBmcm9tICd2dWUvdHlwZXMvb3B0aW9ucydcblxuLyogQHZ1ZS9jb21wb25lbnQgKi9cbmV4cG9ydCBkZWZhdWx0IFZTbGlkZXIuZXh0ZW5kKHtcbiAgbmFtZTogJ3YtcmFuZ2Utc2xpZGVyJyxcblxuICBwcm9wczoge1xuICAgIHZhbHVlOiB7XG4gICAgICB0eXBlOiBBcnJheSxcbiAgICAgIGRlZmF1bHQ6ICgpID0+IChbMCwgMF0pLFxuICAgIH0gYXMgdW5rbm93biBhcyBQcm9wVmFsaWRhdG9yPFtudW1iZXIsIG51bWJlcl0+LFxuICB9LFxuXG4gIGRhdGEgKCkge1xuICAgIHJldHVybiB7XG4gICAgICBhY3RpdmVUaHVtYjogbnVsbCBhcyBudWxsIHwgbnVtYmVyLFxuICAgICAgbGF6eVZhbHVlOiB0aGlzLnZhbHVlLFxuICAgIH1cbiAgfSxcblxuICBjb21wdXRlZDoge1xuICAgIGNsYXNzZXMgKCk6IG9iamVjdCB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5WU2xpZGVyLm9wdGlvbnMuY29tcHV0ZWQuY2xhc3Nlcy5jYWxsKHRoaXMpLFxuICAgICAgICAndi1pbnB1dC0tcmFuZ2Utc2xpZGVyJzogdHJ1ZSxcbiAgICAgIH1cbiAgICB9LFxuICAgIGludGVybmFsVmFsdWU6IHtcbiAgICAgIGdldCAoKTogbnVtYmVyW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5sYXp5VmFsdWVcbiAgICAgIH0sXG4gICAgICBzZXQgKHZhbDogbnVtYmVyW10pIHtcbiAgICAgICAgLy8gUm91bmQgdmFsdWUgdG8gZW5zdXJlIHRoZVxuICAgICAgICAvLyBlbnRpcmUgc2xpZGVyIHJhbmdlIGNhblxuICAgICAgICAvLyBiZSBzZWxlY3RlZCB3aXRoIHN0ZXBcbiAgICAgICAgbGV0IHZhbHVlID0gdmFsLm1hcCgodiA9IDApID0+IHRoaXMucm91bmRWYWx1ZShNYXRoLm1pbihNYXRoLm1heCh2LCB0aGlzLm1pblZhbHVlKSwgdGhpcy5tYXhWYWx1ZSkpKVxuXG4gICAgICAgIC8vIFN3aXRjaCB2YWx1ZXMgaWYgcmFuZ2UgYW5kIHdyb25nIG9yZGVyXG4gICAgICAgIGlmICh2YWx1ZVswXSA+IHZhbHVlWzFdIHx8IHZhbHVlWzFdIDwgdmFsdWVbMF0pIHtcbiAgICAgICAgICBpZiAodGhpcy5hY3RpdmVUaHVtYiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgY29uc3QgdG9Gb2N1cyA9IHRoaXMuYWN0aXZlVGh1bWIgPT09IDEgPyAwIDogMVxuICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLiRyZWZzW2B0aHVtYl8ke3RvRm9jdXN9YF0gYXMgSFRNTEVsZW1lbnRcbiAgICAgICAgICAgIGVsLmZvY3VzKClcbiAgICAgICAgICB9XG4gICAgICAgICAgdmFsdWUgPSBbdmFsdWVbMV0sIHZhbHVlWzBdXVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5sYXp5VmFsdWUgPSB2YWx1ZVxuICAgICAgICBpZiAoIWRlZXBFcXVhbCh2YWx1ZSwgdGhpcy52YWx1ZSkpIHRoaXMuJGVtaXQoJ2lucHV0JywgdmFsdWUpXG5cbiAgICAgICAgdGhpcy52YWxpZGF0ZSgpXG4gICAgICB9LFxuICAgIH0sXG4gICAgaW5wdXRXaWR0aCAoKTogbnVtYmVyW10ge1xuICAgICAgcmV0dXJuIHRoaXMuaW50ZXJuYWxWYWx1ZS5tYXAoKHY6IG51bWJlcikgPT4gKFxuICAgICAgICB0aGlzLnJvdW5kVmFsdWUodikgLSB0aGlzLm1pblZhbHVlKSAvICh0aGlzLm1heFZhbHVlIC0gdGhpcy5taW5WYWx1ZSkgKiAxMDBcbiAgICAgIClcbiAgICB9LFxuICB9LFxuXG4gIG1ldGhvZHM6IHtcbiAgICBnZXRUcmFja1N0eWxlIChzdGFydExlbmd0aDogbnVtYmVyLCBlbmRMZW5ndGg6IG51bWJlciwgc3RhcnRQYWRkaW5nID0gMCwgZW5kUGFkZGluZyA9IDApIHtcbiAgICAgIGNvbnN0IHN0YXJ0RGlyID0gdGhpcy52ZXJ0aWNhbCA/IHRoaXMuJHZ1ZXRpZnkucnRsID8gJ3RvcCcgOiAnYm90dG9tJyA6IHRoaXMuJHZ1ZXRpZnkucnRsID8gJ3JpZ2h0JyA6ICdsZWZ0J1xuICAgICAgY29uc3QgZW5kRGlyID0gdGhpcy52ZXJ0aWNhbCA/ICdoZWlnaHQnIDogJ3dpZHRoJ1xuXG4gICAgICBjb25zdCBzdGFydCA9IGBjYWxjKCR7c3RhcnRMZW5ndGh9JSArICR7c3RhcnRQYWRkaW5nfXB4KWBcbiAgICAgIGNvbnN0IGVuZCA9IGBjYWxjKCR7ZW5kTGVuZ3RofSUgKyAke2VuZFBhZGRpbmd9cHgpYFxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICB0cmFuc2l0aW9uOiB0aGlzLnRyYWNrVHJhbnNpdGlvbixcbiAgICAgICAgW3N0YXJ0RGlyXTogc3RhcnQsXG4gICAgICAgIFtlbmREaXJdOiBlbmQsXG4gICAgICB9XG4gICAgfSxcbiAgICBnZXRJbmRleE9mQ2xvc2VzdFZhbHVlIChhcnI6IG51bWJlcltdLCB2OiBudW1iZXIpIHtcbiAgICAgIGlmIChNYXRoLmFicyhhcnJbMF0gLSB2KSA8IE1hdGguYWJzKGFyclsxXSAtIHYpKSByZXR1cm4gMFxuICAgICAgZWxzZSByZXR1cm4gMVxuICAgIH0sXG4gICAgZ2VuSW5wdXQgKCkge1xuICAgICAgcmV0dXJuIGNyZWF0ZVJhbmdlKDIpLm1hcChpID0+IHtcbiAgICAgICAgY29uc3QgaW5wdXQgPSBWU2xpZGVyLm9wdGlvbnMubWV0aG9kcy5nZW5JbnB1dC5jYWxsKHRoaXMpXG5cbiAgICAgICAgaW5wdXQuZGF0YSA9IGlucHV0LmRhdGEgfHwge31cbiAgICAgICAgaW5wdXQuZGF0YS5hdHRycyA9IGlucHV0LmRhdGEuYXR0cnMgfHwge31cbiAgICAgICAgaW5wdXQuZGF0YS5hdHRycy52YWx1ZSA9IHRoaXMuaW50ZXJuYWxWYWx1ZVtpXVxuICAgICAgICBpbnB1dC5kYXRhLmF0dHJzLmlkID0gYGlucHV0LSR7aSA/ICdtYXgnIDogJ21pbid9LSR7dGhpcy5fdWlkfWBcblxuICAgICAgICByZXR1cm4gaW5wdXRcbiAgICAgIH0pXG4gICAgfSxcbiAgICBnZW5UcmFja0NvbnRhaW5lciAoKSB7XG4gICAgICBjb25zdCBjaGlsZHJlbiA9IFtdXG5cbiAgICAgIGNvbnN0IHBhZGRpbmcgPSB0aGlzLmlzRGlzYWJsZWQgPyAxMCA6IDBcbiAgICAgIGNvbnN0IHNlY3Rpb25zOiB7IGNsYXNzOiBzdHJpbmcsIGNvbG9yOiBzdHJpbmcgfCB1bmRlZmluZWQsIHN0eWxlczogW251bWJlciwgbnVtYmVyLCBudW1iZXIsIG51bWJlcl0gfVtdID0gW1xuICAgICAgICB7XG4gICAgICAgICAgY2xhc3M6ICd2LXNsaWRlcl9fdHJhY2stYmFja2dyb3VuZCcsXG4gICAgICAgICAgY29sb3I6IHRoaXMuY29tcHV0ZWRUcmFja0NvbG9yLFxuICAgICAgICAgIHN0eWxlczogWzAsIHRoaXMuaW5wdXRXaWR0aFswXSwgMCwgLXBhZGRpbmddLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgY2xhc3M6IHRoaXMuaXNEaXNhYmxlZCA/ICd2LXNsaWRlcl9fdHJhY2stYmFja2dyb3VuZCcgOiAndi1zbGlkZXJfX3RyYWNrLWZpbGwnLFxuICAgICAgICAgIGNvbG9yOiB0aGlzLmlzRGlzYWJsZWQgPyB0aGlzLmNvbXB1dGVkVHJhY2tDb2xvciA6IHRoaXMuY29tcHV0ZWRUcmFja0ZpbGxDb2xvcixcbiAgICAgICAgICBzdHlsZXM6IFt0aGlzLmlucHV0V2lkdGhbMF0sIE1hdGguYWJzKHRoaXMuaW5wdXRXaWR0aFsxXSAtIHRoaXMuaW5wdXRXaWR0aFswXSksIHBhZGRpbmcsIHBhZGRpbmcgKiAtMl0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBjbGFzczogJ3Ytc2xpZGVyX190cmFjay1iYWNrZ3JvdW5kJyxcbiAgICAgICAgICBjb2xvcjogdGhpcy5jb21wdXRlZFRyYWNrQ29sb3IsXG4gICAgICAgICAgc3R5bGVzOiBbdGhpcy5pbnB1dFdpZHRoWzFdLCBNYXRoLmFicygxMDAgLSB0aGlzLmlucHV0V2lkdGhbMV0pLCBwYWRkaW5nLCAtcGFkZGluZ10sXG4gICAgICAgIH0sXG4gICAgICBdXG5cbiAgICAgIGlmICh0aGlzLiR2dWV0aWZ5LnJ0bCkgc2VjdGlvbnMucmV2ZXJzZSgpXG5cbiAgICAgIGNoaWxkcmVuLnB1c2goLi4uc2VjdGlvbnMubWFwKHNlY3Rpb24gPT4gdGhpcy4kY3JlYXRlRWxlbWVudCgnZGl2JywgdGhpcy5zZXRCYWNrZ3JvdW5kQ29sb3Ioc2VjdGlvbi5jb2xvciwge1xuICAgICAgICBzdGF0aWNDbGFzczogc2VjdGlvbi5jbGFzcyxcbiAgICAgICAgc3R5bGU6IHRoaXMuZ2V0VHJhY2tTdHlsZSguLi5zZWN0aW9uLnN0eWxlcyksXG4gICAgICB9KSkpKVxuXG4gICAgICByZXR1cm4gdGhpcy4kY3JlYXRlRWxlbWVudCgnZGl2Jywge1xuICAgICAgICBzdGF0aWNDbGFzczogJ3Ytc2xpZGVyX190cmFjay1jb250YWluZXInLFxuICAgICAgICByZWY6ICd0cmFjaycsXG4gICAgICB9LCBjaGlsZHJlbilcbiAgICB9LFxuICAgIGdlbkNoaWxkcmVuICgpIHtcbiAgICAgIHJldHVybiBbXG4gICAgICAgIHRoaXMuZ2VuSW5wdXQoKSxcbiAgICAgICAgdGhpcy5nZW5UcmFja0NvbnRhaW5lcigpLFxuICAgICAgICB0aGlzLmdlblN0ZXBzKCksXG4gICAgICAgIGNyZWF0ZVJhbmdlKDIpLm1hcChpbmRleCA9PiB7XG4gICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmludGVybmFsVmFsdWVbaW5kZXhdXG4gICAgICAgICAgY29uc3Qgb25Gb2N1cyA9IChlOiBFdmVudCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5pc0ZvY3VzZWQgPSB0cnVlXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZVRodW1iID0gaW5kZXhcblxuICAgICAgICAgICAgdGhpcy4kZW1pdCgnZm9jdXMnLCBlKVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IG9uQmx1ciA9IChlOiBFdmVudCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5pc0ZvY3VzZWQgPSBmYWxzZVxuICAgICAgICAgICAgdGhpcy5hY3RpdmVUaHVtYiA9IG51bGxcblxuICAgICAgICAgICAgdGhpcy4kZW1pdCgnYmx1cicsIGUpXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgdmFsdWVXaWR0aCA9IHRoaXMuaW5wdXRXaWR0aFtpbmRleF1cbiAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IHRoaXMuaXNBY3RpdmUgJiYgdGhpcy5hY3RpdmVUaHVtYiA9PT0gaW5kZXhcbiAgICAgICAgICBjb25zdCBpc0ZvY3VzZWQgPSB0aGlzLmlzRm9jdXNlZCAmJiB0aGlzLmFjdGl2ZVRodW1iID09PSBpbmRleFxuXG4gICAgICAgICAgcmV0dXJuIHRoaXMuZ2VuVGh1bWJDb250YWluZXIodmFsdWUsIHZhbHVlV2lkdGgsIGlzQWN0aXZlLCBpc0ZvY3VzZWQsIG9uRm9jdXMsIG9uQmx1ciwgYHRodW1iXyR7aW5kZXh9YClcbiAgICAgICAgfSksXG4gICAgICBdXG4gICAgfSxcbiAgICByZWV2YWx1YXRlU2VsZWN0ZWQgKHZhbHVlOiBudW1iZXIpIHtcbiAgICAgIHRoaXMuYWN0aXZlVGh1bWIgPSB0aGlzLmdldEluZGV4T2ZDbG9zZXN0VmFsdWUodGhpcy5pbnRlcm5hbFZhbHVlLCB2YWx1ZSlcbiAgICAgIGNvbnN0IHJlZk5hbWUgPSBgdGh1bWJfJHt0aGlzLmFjdGl2ZVRodW1ifWBcbiAgICAgIGNvbnN0IHRodW1iUmVmID0gdGhpcy4kcmVmc1tyZWZOYW1lXSBhcyBIVE1MRWxlbWVudFxuICAgICAgdGh1bWJSZWYuZm9jdXMoKVxuICAgIH0sXG4gICAgb25TbGlkZXJNb3VzZURvd24gKGU6IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50KSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IHRoaXMucGFyc2VNb3VzZU1vdmUoZSlcblxuICAgICAgdGhpcy5yZWV2YWx1YXRlU2VsZWN0ZWQodmFsdWUpXG5cbiAgICAgIHRoaXMub2xkVmFsdWUgPSB0aGlzLmludGVybmFsVmFsdWVcbiAgICAgIHRoaXMuaXNBY3RpdmUgPSB0cnVlXG5cbiAgICAgIGlmICgoZS50YXJnZXQgYXMgRWxlbWVudCk/Lm1hdGNoZXMoJy52LXNsaWRlcl9fdGh1bWItY29udGFpbmVyLCAudi1zbGlkZXJfX3RodW1iLWNvbnRhaW5lciAqJykpIHtcbiAgICAgICAgdGhpcy50aHVtYlByZXNzZWQgPSB0cnVlXG4gICAgICAgIGNvbnN0IGRvbVJlY3QgPSAoZS50YXJnZXQgYXMgRWxlbWVudCkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcbiAgICAgICAgY29uc3QgdG91Y2ggPSAndG91Y2hlcycgaW4gZSA/IGUudG91Y2hlc1swXSA6IGVcbiAgICAgICAgdGhpcy5zdGFydE9mZnNldCA9IHRoaXMudmVydGljYWxcbiAgICAgICAgICA/IHRvdWNoLmNsaWVudFkgLSAoZG9tUmVjdC50b3AgKyBkb21SZWN0LmhlaWdodCAvIDIpXG4gICAgICAgICAgOiB0b3VjaC5jbGllbnRYIC0gKGRvbVJlY3QubGVmdCArIGRvbVJlY3Qud2lkdGggLyAyKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zdGFydE9mZnNldCA9IDBcbiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLm1vdXNlVGltZW91dClcbiAgICAgICAgdGhpcy5tb3VzZVRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy50aHVtYlByZXNzZWQgPSB0cnVlXG4gICAgICAgIH0sIDMwMClcbiAgICAgIH1cblxuICAgICAgY29uc3QgbW91c2VVcE9wdGlvbnMgPSBwYXNzaXZlU3VwcG9ydGVkID8geyBwYXNzaXZlOiB0cnVlLCBjYXB0dXJlOiB0cnVlIH0gOiB0cnVlXG4gICAgICBjb25zdCBtb3VzZU1vdmVPcHRpb25zID0gcGFzc2l2ZVN1cHBvcnRlZCA/IHsgcGFzc2l2ZTogdHJ1ZSB9IDogZmFsc2VcblxuICAgICAgY29uc3QgaXNUb3VjaEV2ZW50ID0gJ3RvdWNoZXMnIGluIGVcblxuICAgICAgdGhpcy5vbk1vdXNlTW92ZShlKVxuICAgICAgdGhpcy5hcHAuYWRkRXZlbnRMaXN0ZW5lcihpc1RvdWNoRXZlbnQgPyAndG91Y2htb3ZlJyA6ICdtb3VzZW1vdmUnLCB0aGlzLm9uTW91c2VNb3ZlLCBtb3VzZU1vdmVPcHRpb25zKVxuICAgICAgYWRkT25jZUV2ZW50TGlzdGVuZXIodGhpcy5hcHAsIGlzVG91Y2hFdmVudCA/ICd0b3VjaGVuZCcgOiAnbW91c2V1cCcsIHRoaXMub25TbGlkZXJNb3VzZVVwLCBtb3VzZVVwT3B0aW9ucylcblxuICAgICAgdGhpcy4kZW1pdCgnc3RhcnQnLCB0aGlzLmludGVybmFsVmFsdWUpXG4gICAgfSxcbiAgICBvblNsaWRlckNsaWNrIChlOiBNb3VzZUV2ZW50KSB7XG4gICAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHtcbiAgICAgICAgaWYgKHRoaXMubm9DbGljaykge1xuICAgICAgICAgIHRoaXMubm9DbGljayA9IGZhbHNlXG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMucGFyc2VNb3VzZU1vdmUoZSlcblxuICAgICAgICB0aGlzLnJlZXZhbHVhdGVTZWxlY3RlZCh2YWx1ZSlcblxuICAgICAgICB0aGlzLnNldEludGVybmFsVmFsdWUodmFsdWUpXG5cbiAgICAgICAgdGhpcy4kZW1pdCgnY2hhbmdlJywgdGhpcy5pbnRlcm5hbFZhbHVlKVxuICAgICAgfVxuICAgIH0sXG4gICAgb25Nb3VzZU1vdmUgKGU6IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50KSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IHRoaXMucGFyc2VNb3VzZU1vdmUoZSlcblxuICAgICAgaWYgKGUudHlwZSA9PT0gJ21vdXNlbW92ZScpIHtcbiAgICAgICAgdGhpcy50aHVtYlByZXNzZWQgPSB0cnVlXG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmFjdGl2ZVRodW1iID09PSBudWxsKSB7XG4gICAgICAgIHRoaXMuYWN0aXZlVGh1bWIgPSB0aGlzLmdldEluZGV4T2ZDbG9zZXN0VmFsdWUodGhpcy5pbnRlcm5hbFZhbHVlLCB2YWx1ZSlcbiAgICAgIH1cblxuICAgICAgdGhpcy5zZXRJbnRlcm5hbFZhbHVlKHZhbHVlKVxuICAgIH0sXG4gICAgb25LZXlEb3duIChlOiBLZXlib2FyZEV2ZW50KSB7XG4gICAgICBpZiAodGhpcy5hY3RpdmVUaHVtYiA9PT0gbnVsbCkgcmV0dXJuXG5cbiAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5wYXJzZUtleURvd24oZSwgdGhpcy5pbnRlcm5hbFZhbHVlW3RoaXMuYWN0aXZlVGh1bWJdKVxuXG4gICAgICBpZiAodmFsdWUgPT0gbnVsbCkgcmV0dXJuXG5cbiAgICAgIHRoaXMuc2V0SW50ZXJuYWxWYWx1ZSh2YWx1ZSlcbiAgICAgIHRoaXMuJGVtaXQoJ2NoYW5nZScsIHRoaXMuaW50ZXJuYWxWYWx1ZSlcbiAgICB9LFxuICAgIHNldEludGVybmFsVmFsdWUgKHZhbHVlOiBudW1iZXIpIHtcbiAgICAgIHRoaXMuaW50ZXJuYWxWYWx1ZSA9IHRoaXMuaW50ZXJuYWxWYWx1ZS5tYXAoKHY6IG51bWJlciwgaTogbnVtYmVyKSA9PiB7XG4gICAgICAgIGlmIChpID09PSB0aGlzLmFjdGl2ZVRodW1iKSByZXR1cm4gdmFsdWVcbiAgICAgICAgZWxzZSByZXR1cm4gTnVtYmVyKHYpXG4gICAgICB9KVxuICAgIH0sXG4gIH0sXG59KVxuIl19