// Styles
import '../VTextField/VTextField.sass';
import './VOtpInput.sass';
// Extensions
import VInput from '../VInput';
import VTextField from '../VTextField/VTextField';
// Directives
import ripple from '../../directives/ripple';
// Utilities
import { convertToUnit, keyCodes } from '../../util/helpers';
import { breaking } from '../../util/console';
// Types
import mixins from '../../util/mixins';
const baseMixins = mixins(VInput);
/* @vue/component */
export default baseMixins.extend().extend({
    name: 'v-otp-input',
    directives: {
        ripple,
    },
    inheritAttrs: false,
    props: {
        length: {
            type: [Number, String],
            default: 6,
        },
        type: {
            type: String,
            default: 'text',
        },
        plain: Boolean,
    },
    data: () => ({
        initialValue: null,
        isBooted: false,
        otp: [],
    }),
    computed: {
        outlined() {
            return !this.plain;
        },
        classes() {
            return {
                ...VInput.options.computed.classes.call(this),
                ...VTextField.options.computed.classes.call(this),
                'v-otp-input--plain': this.plain,
            };
        },
    },
    watch: {
        isFocused: 'updateValue',
        value(val) {
            this.lazyValue = val;
            this.otp = val?.split('') || [];
        },
    },
    created() {
        /* istanbul ignore next */
        if (this.$attrs.hasOwnProperty('browser-autocomplete')) {
            breaking('browser-autocomplete', 'autocomplete', this);
        }
        this.otp = this.internalValue?.split('') || [];
    },
    mounted() {
        requestAnimationFrame(() => (this.isBooted = true));
    },
    methods: {
        /** @public */
        focus(e, otpIdx) {
            this.onFocus(e, otpIdx || 0);
        },
        genInputSlot(otpIdx) {
            return this.$createElement('div', this.setBackgroundColor(this.backgroundColor, {
                staticClass: 'v-input__slot',
                style: { height: convertToUnit(this.height) },
                on: {
                    click: () => this.onClick(otpIdx),
                    mousedown: (e) => this.onMouseDown(e, otpIdx),
                    mouseup: (e) => this.onMouseUp(e, otpIdx),
                },
            }), [this.genDefaultSlot(otpIdx)]);
        },
        genControl(otpIdx) {
            return this.$createElement('div', {
                staticClass: 'v-input__control',
            }, [
                this.genInputSlot(otpIdx),
            ]);
        },
        genDefaultSlot(otpIdx) {
            return [
                this.genFieldset(),
                this.genTextFieldSlot(otpIdx),
            ];
        },
        genContent() {
            return Array.from({ length: +this.length }, (_, i) => {
                return this.$createElement('div', this.setTextColor(this.validationState, {
                    staticClass: 'v-input',
                    class: this.classes,
                }), [this.genControl(i)]);
            });
        },
        genFieldset() {
            return this.$createElement('fieldset', {
                attrs: {
                    'aria-hidden': true,
                },
            }, [this.genLegend()]);
        },
        genLegend() {
            const span = this.$createElement('span', {
                domProps: { innerHTML: '&#8203;' },
            });
            return this.$createElement('legend', {
                style: {
                    width: '0px',
                },
            }, [span]);
        },
        genInput(otpIdx) {
            const listeners = Object.assign({}, this.listeners$);
            delete listeners.change; // Change should not be bound externally
            return this.$createElement('input', {
                style: {},
                domProps: {
                    value: this.otp[otpIdx],
                    min: this.type === 'number' ? 0 : null,
                },
                attrs: {
                    ...this.attrs$,
                    autocomplete: 'one-time-code',
                    disabled: this.isDisabled,
                    readonly: this.isReadonly,
                    type: this.type,
                    id: `${this.computedId}--${otpIdx}`,
                    class: `otp-field-box--${otpIdx}`,
                },
                on: Object.assign(listeners, {
                    blur: this.onBlur,
                    input: (e) => this.onInput(e, otpIdx),
                    focus: (e) => this.onFocus(e, otpIdx),
                    keydown: this.onKeyDown,
                    keyup: (e) => this.onKeyUp(e, otpIdx),
                }),
                ref: 'input',
                refInFor: true,
            });
        },
        genTextFieldSlot(otpIdx) {
            return this.$createElement('div', {
                staticClass: 'v-text-field__slot',
            }, [
                this.genInput(otpIdx),
            ]);
        },
        onBlur(e) {
            this.isFocused = false;
            e && this.$nextTick(() => this.$emit('blur', e));
        },
        onClick(otpIdx) {
            if (this.isFocused || this.isDisabled || !this.$refs.input[otpIdx])
                return;
            this.onFocus(undefined, otpIdx);
        },
        onFocus(e, otpIdx) {
            e?.preventDefault();
            e?.stopPropagation();
            const elements = this.$refs.input;
            const ref = this.$refs.input && elements[otpIdx || 0];
            if (!ref)
                return;
            if (document.activeElement !== ref) {
                ref.focus();
                return ref.select();
            }
            if (!this.isFocused) {
                this.isFocused = true;
                ref.select();
                e && this.$emit('focus', e);
            }
        },
        onInput(e, index) {
            const maxCursor = +this.length - 1;
            const target = e.target;
            const value = target.value;
            const inputDataArray = value?.split('') || [];
            const newOtp = [...this.otp];
            for (let i = 0; i < inputDataArray.length; i++) {
                const appIdx = index + i;
                if (appIdx > maxCursor)
                    break;
                newOtp[appIdx] = inputDataArray[i].toString();
            }
            if (!inputDataArray.length) {
                newOtp.splice(index, 1);
            }
            this.otp = newOtp;
            this.internalValue = this.otp.join('');
            if (index + inputDataArray.length >= +this.length) {
                this.onCompleted();
                this.clearFocus(index);
            }
            else if (inputDataArray.length) {
                this.changeFocus(index + inputDataArray.length);
            }
        },
        clearFocus(index) {
            const input = this.$refs.input[index];
            input.blur();
        },
        onKeyDown(e) {
            if (e.keyCode === keyCodes.enter) {
                this.$emit('change', this.internalValue);
            }
            this.$emit('keydown', e);
        },
        onMouseDown(e, otpIdx) {
            // Prevent input from being blurred
            if (e.target !== this.$refs.input[otpIdx]) {
                e.preventDefault();
                e.stopPropagation();
            }
            VInput.options.methods.onMouseDown.call(this, e);
        },
        onMouseUp(e, otpIdx) {
            if (this.hasMouseDown)
                this.focus(e, otpIdx);
            VInput.options.methods.onMouseUp.call(this, e);
        },
        changeFocus(index) {
            this.onFocus(undefined, index || 0);
        },
        updateValue(val) {
            // Sets validationState from validatable
            this.hasColor = val;
            if (val) {
                this.initialValue = this.lazyValue;
            }
            else if (this.initialValue !== this.lazyValue) {
                this.$emit('change', this.lazyValue);
            }
        },
        onKeyUp(event, index) {
            event.preventDefault();
            const eventKey = event.key;
            if (['Tab', 'Shift', 'Meta', 'Control', 'Alt'].includes(eventKey)) {
                return;
            }
            if (['Delete'].includes(eventKey)) {
                return;
            }
            if (eventKey === 'ArrowLeft' || (eventKey === 'Backspace' && !this.otp[index])) {
                return index > 0 && this.changeFocus(index - 1);
            }
            if (eventKey === 'ArrowRight') {
                return index + 1 < +this.length && this.changeFocus(index + 1);
            }
        },
        onCompleted() {
            const rsp = this.otp.join('');
            if (rsp.length === +this.length) {
                this.$emit('finish', rsp);
            }
        },
    },
    render(h) {
        return h('div', {
            staticClass: 'v-otp-input',
            class: this.themeClasses,
        }, this.genContent());
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVk90cElucHV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvVk90cElucHV0L1ZPdHBJbnB1dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTO0FBQ1QsT0FBTywrQkFBK0IsQ0FBQTtBQUN0QyxPQUFPLGtCQUFrQixDQUFBO0FBRXpCLGFBQWE7QUFDYixPQUFPLE1BQU0sTUFBTSxXQUFXLENBQUE7QUFDOUIsT0FBTyxVQUFVLE1BQU0sMEJBQTBCLENBQUE7QUFDakQsYUFBYTtBQUNiLE9BQU8sTUFBTSxNQUFNLHlCQUF5QixDQUFBO0FBRTVDLFlBQVk7QUFDWixPQUFPLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxNQUFNLG9CQUFvQixDQUFBO0FBQzVELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQTtBQUU3QyxRQUFRO0FBQ1IsT0FBTyxNQUFNLE1BQU0sbUJBQW1CLENBQUE7QUFHdEMsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUN2QixNQUFNLENBQ1AsQ0FBQTtBQVFELG9CQUFvQjtBQUNwQixlQUFlLFVBQVUsQ0FBQyxNQUFNLEVBQVcsQ0FBQyxNQUFNLENBQUM7SUFDakQsSUFBSSxFQUFFLGFBQWE7SUFFbkIsVUFBVSxFQUFFO1FBQ1YsTUFBTTtLQUNQO0lBRUQsWUFBWSxFQUFFLEtBQUs7SUFFbkIsS0FBSyxFQUFFO1FBQ0wsTUFBTSxFQUFFO1lBQ04sSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztZQUN0QixPQUFPLEVBQUUsQ0FBQztTQUNYO1FBQ0QsSUFBSSxFQUFFO1lBQ0osSUFBSSxFQUFFLE1BQU07WUFDWixPQUFPLEVBQUUsTUFBTTtTQUNoQjtRQUNELEtBQUssRUFBRSxPQUFPO0tBQ2Y7SUFFRCxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNYLFlBQVksRUFBRSxJQUFJO1FBQ2xCLFFBQVEsRUFBRSxLQUFLO1FBQ2YsR0FB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QUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFBO2FBQ2hEO1lBQ0QsSUFBSSxRQUFRLEtBQUssWUFBWSxFQUFFO2dCQUM3QixPQUFPLEtBQUssR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFBO2FBQy9EO1FBQ0gsQ0FBQztRQUNELFdBQVc7WUFDVCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUM3QixJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUMvQixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQTthQUMxQjtRQUNILENBQUM7S0FDRjtJQUNELE1BQU0sQ0FBRSxDQUFDO1FBQ1AsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFO1lBQ2QsV0FBVyxFQUFFLGFBQWE7WUFDMUIsS0FBSyxFQUFFLElBQUksQ0FBQyxZQUFZO1NBQ3pCLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUE7SUFDdkIsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIFN0eWxlc1xuaW1wb3J0ICcuLi9WVGV4dEZpZWxkL1ZUZXh0RmllbGQuc2FzcydcbmltcG9ydCAnLi9WT3RwSW5wdXQuc2FzcydcblxuLy8gRXh0ZW5zaW9uc1xuaW1wb3J0IFZJbnB1dCBmcm9tICcuLi9WSW5wdXQnXG5pbXBvcnQgVlRleHRGaWVsZCBmcm9tICcuLi9WVGV4dEZpZWxkL1ZUZXh0RmllbGQnXG4vLyBEaXJlY3RpdmVzXG5pbXBvcnQgcmlwcGxlIGZyb20gJy4uLy4uL2RpcmVjdGl2ZXMvcmlwcGxlJ1xuXG4vLyBVdGlsaXRpZXNcbmltcG9ydCB7IGNvbnZlcnRUb1VuaXQsIGtleUNvZGVzIH0gZnJvbSAnLi4vLi4vdXRpbC9oZWxwZXJzJ1xuaW1wb3J0IHsgYnJlYWtpbmcgfSBmcm9tICcuLi8uLi91dGlsL2NvbnNvbGUnXG5cbi8vIFR5cGVzXG5pbXBvcnQgbWl4aW5zIGZyb20gJy4uLy4uL3V0aWwvbWl4aW5zJ1xuaW1wb3J0IHsgVk5vZGUgfSBmcm9tICd2dWUnXG5cbmNvbnN0IGJhc2VNaXhpbnMgPSBtaXhpbnMoXG4gIFZJbnB1dCxcbilcblxuaW50ZXJmYWNlIG9wdGlvbnMgZXh0ZW5kcyBJbnN0YW5jZVR5cGU8dHlwZW9mIGJhc2VNaXhpbnM+IHtcbiAgJHJlZnM6IHtcbiAgICBpbnB1dDogSFRNTElucHV0RWxlbWVudFtdXG4gIH1cbn1cblxuLyogQHZ1ZS9jb21wb25lbnQgKi9cbmV4cG9ydCBkZWZhdWx0IGJhc2VNaXhpbnMuZXh0ZW5kPG9wdGlvbnM+KCkuZXh0ZW5kKHtcbiAgbmFtZTogJ3Ytb3RwLWlucHV0JyxcblxuICBkaXJlY3RpdmVzOiB7XG4gICAgcmlwcGxlLFxuICB9LFxuXG4gIGluaGVyaXRBdHRyczogZmFsc2UsXG5cbiAgcHJvcHM6IHtcbiAgICBsZW5ndGg6IHtcbiAgICAgIHR5cGU6IFtOdW1iZXIsIFN0cmluZ10sXG4gICAgICBkZWZhdWx0OiA2LFxuICAgIH0sXG4gICAgdHlwZToge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZGVmYXVsdDogJ3RleHQnLFxuICAgIH0sXG4gICAgcGxhaW46IEJvb2xlYW4sXG4gIH0sXG5cbiAgZGF0YTogKCkgPT4gKHtcbiAgICBpbml0aWFsVmFsdWU6IG51bGwsXG4gICAgaXNCb290ZWQ6IGZhbHNlLFxuICAgIG90cDogW10gYXMgc3RyaW5nW10sXG4gIH0pLFxuXG4gIGNvbXB1dGVkOiB7XG4gICAgb3V0bGluZWQgKCk6IEJvb2xlYW4ge1xuICAgICAgcmV0dXJuICF0aGlzLnBsYWluXG4gICAgfSxcbiAgICBjbGFzc2VzICgpOiBvYmplY3Qge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uVklucHV0Lm9wdGlvbnMuY29tcHV0ZWQuY2xhc3Nlcy5jYWxsKHRoaXMpLFxuICAgICAgICAuLi5WVGV4dEZpZWxkLm9wdGlvbnMuY29tcHV0ZWQuY2xhc3Nlcy5jYWxsKHRoaXMpLFxuICAgICAgICAndi1vdHAtaW5wdXQtLXBsYWluJzogdGhpcy5wbGFpbixcbiAgICAgIH1cbiAgICB9LFxuICB9LFxuXG4gIHdhdGNoOiB7XG4gICAgaXNGb2N1c2VkOiAndXBkYXRlVmFsdWUnLFxuICAgIHZhbHVlICh2YWwpIHtcbiAgICAgIHRoaXMubGF6eVZhbHVlID0gdmFsXG4gICAgICB0aGlzLm90cCA9IHZhbD8uc3BsaXQoJycpIHx8IFtdXG4gICAgfSxcbiAgfSxcblxuICBjcmVhdGVkICgpIHtcbiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgIGlmICh0aGlzLiRhdHRycy5oYXNPd25Qcm9wZXJ0eSgnYnJvd3Nlci1hdXRvY29tcGxldGUnKSkge1xuICAgICAgYnJlYWtpbmcoJ2Jyb3dzZXItYXV0b2NvbXBsZXRlJywgJ2F1dG9jb21wbGV0ZScsIHRoaXMpXG4gICAgfVxuXG4gICAgdGhpcy5vdHAgPSB0aGlzLmludGVybmFsVmFsdWU/LnNwbGl0KCcnKSB8fCBbXVxuICB9LFxuXG4gIG1vdW50ZWQgKCkge1xuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiAodGhpcy5pc0Jvb3RlZCA9IHRydWUpKVxuICB9LFxuXG4gIG1ldGhvZHM6IHtcbiAgICAvKiogQHB1YmxpYyAqL1xuICAgIGZvY3VzIChlOiBFdmVudCwgb3RwSWR4OiBudW1iZXIpIHtcbiAgICAgIHRoaXMub25Gb2N1cyhlLCBvdHBJZHggfHwgMClcbiAgICB9LFxuICAgIGdlbklucHV0U2xvdCAob3RwSWR4OiBudW1iZXIpIHtcbiAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCdkaXYnLCB0aGlzLnNldEJhY2tncm91bmRDb2xvcih0aGlzLmJhY2tncm91bmRDb2xvciwge1xuICAgICAgICBzdGF0aWNDbGFzczogJ3YtaW5wdXRfX3Nsb3QnLFxuICAgICAgICBzdHlsZTogeyBoZWlnaHQ6IGNvbnZlcnRUb1VuaXQodGhpcy5oZWlnaHQpIH0sXG4gICAgICAgIG9uOiB7XG4gICAgICAgICAgY2xpY2s6ICgpID0+IHRoaXMub25DbGljayhvdHBJZHgpLFxuICAgICAgICAgIG1vdXNlZG93bjogKGU6IEV2ZW50KSA9PiB0aGlzLm9uTW91c2VEb3duKGUsIG90cElkeCksXG4gICAgICAgICAgbW91c2V1cDogKGU6IEV2ZW50KSA9PiB0aGlzLm9uTW91c2VVcChlLCBvdHBJZHgpLFxuICAgICAgICB9LFxuICAgICAgfSksIFt0aGlzLmdlbkRlZmF1bHRTbG90KG90cElkeCldKVxuICAgIH0sXG4gICAgZ2VuQ29udHJvbCAob3RwSWR4OiBudW1iZXIpIHtcbiAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCdkaXYnLCB7XG4gICAgICAgIHN0YXRpY0NsYXNzOiAndi1pbnB1dF9fY29udHJvbCcsXG4gICAgICB9LCBbXG4gICAgICAgIHRoaXMuZ2VuSW5wdXRTbG90KG90cElkeCksXG4gICAgICBdKVxuICAgIH0sXG4gICAgZ2VuRGVmYXVsdFNsb3QgKG90cElkeDogbnVtYmVyKSB7XG4gICAgICByZXR1cm4gW1xuICAgICAgICB0aGlzLmdlbkZpZWxkc2V0KCksXG4gICAgICAgIHRoaXMuZ2VuVGV4dEZpZWxkU2xvdChvdHBJZHgpLFxuICAgICAgXVxuICAgIH0sXG4gICAgZ2VuQ29udGVudCAoKSB7XG4gICAgICByZXR1cm4gQXJyYXkuZnJvbSh7IGxlbmd0aDogK3RoaXMubGVuZ3RoIH0sIChfLCBpKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCdkaXYnLCB0aGlzLnNldFRleHRDb2xvcih0aGlzLnZhbGlkYXRpb25TdGF0ZSwge1xuICAgICAgICAgIHN0YXRpY0NsYXNzOiAndi1pbnB1dCcsXG4gICAgICAgICAgY2xhc3M6IHRoaXMuY2xhc3NlcyxcbiAgICAgICAgfSksIFt0aGlzLmdlbkNvbnRyb2woaSldKVxuICAgICAgfSlcbiAgICB9LFxuICAgIGdlbkZpZWxkc2V0ICgpIHtcbiAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCdmaWVsZHNldCcsIHtcbiAgICAgICAgYXR0cnM6IHtcbiAgICAgICAgICAnYXJpYS1oaWRkZW4nOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSwgW3RoaXMuZ2VuTGVnZW5kKCldKVxuICAgIH0sXG4gICAgZ2VuTGVnZW5kICgpIHtcbiAgICAgIGNvbnN0IHNwYW4gPSB0aGlzLiRjcmVhdGVFbGVtZW50KCdzcGFuJywge1xuICAgICAgICBkb21Qcm9wczogeyBpbm5lckhUTUw6ICcmIzgyMDM7JyB9LFxuICAgICAgfSlcblxuICAgICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ2xlZ2VuZCcsIHtcbiAgICAgICAgc3R5bGU6IHtcbiAgICAgICAgICB3aWR0aDogJzBweCcsXG4gICAgICAgIH0sXG4gICAgICB9LCBbc3Bhbl0pXG4gICAgfSxcbiAgICBnZW5JbnB1dCAob3RwSWR4OiBudW1iZXIpIHtcbiAgICAgIGNvbnN0IGxpc3RlbmVycyA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMubGlzdGVuZXJzJClcbiAgICAgIGRlbGV0ZSBsaXN0ZW5lcnMuY2hhbmdlIC8vIENoYW5nZSBzaG91bGQgbm90IGJlIGJvdW5kIGV4dGVybmFsbHlcblxuICAgICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ2lucHV0Jywge1xuICAgICAgICBzdHlsZToge30sXG4gICAgICAgIGRvbVByb3BzOiB7XG4gICAgICAgICAgdmFsdWU6IHRoaXMub3RwW290cElkeF0sXG4gICAgICAgICAgbWluOiB0aGlzLnR5cGUgPT09ICdudW1iZXInID8gMCA6IG51bGwsXG4gICAgICAgIH0sXG4gICAgICAgIGF0dHJzOiB7XG4gICAgICAgICAgLi4udGhpcy5hdHRycyQsXG4gICAgICAgICAgYXV0b2NvbXBsZXRlOiAnb25lLXRpbWUtY29kZScsXG4gICAgICAgICAgZGlzYWJsZWQ6IHRoaXMuaXNEaXNhYmxlZCxcbiAgICAgICAgICByZWFkb25seTogdGhpcy5pc1JlYWRvbmx5LFxuICAgICAgICAgIHR5cGU6IHRoaXMudHlwZSxcbiAgICAgICAgICBpZDogYCR7dGhpcy5jb21wdXRlZElkfS0tJHtvdHBJZHh9YCxcbiAgICAgICAgICBjbGFzczogYG90cC1maWVsZC1ib3gtLSR7b3RwSWR4fWAsXG4gICAgICAgIH0sXG4gICAgICAgIG9uOiBPYmplY3QuYXNzaWduKGxpc3RlbmVycywge1xuICAgICAgICAgIGJsdXI6IHRoaXMub25CbHVyLFxuICAgICAgICAgIGlucHV0OiAoZTogRXZlbnQpID0+IHRoaXMub25JbnB1dChlLCBvdHBJZHgpLFxuICAgICAgICAgIGZvY3VzOiAoZTogRXZlbnQpID0+IHRoaXMub25Gb2N1cyhlLCBvdHBJZHgpLFxuICAgICAgICAgIGtleWRvd246IHRoaXMub25LZXlEb3duLFxuICAgICAgICAgIGtleXVwOiAoZTogS2V5Ym9hcmRFdmVudCkgPT4gdGhpcy5vbktleVVwKGUsIG90cElkeCksXG4gICAgICAgIH0pLFxuICAgICAgICByZWY6ICdpbnB1dCcsXG4gICAgICAgIHJlZkluRm9yOiB0cnVlLFxuICAgICAgfSlcbiAgICB9LFxuICAgIGdlblRleHRGaWVsZFNsb3QgKG90cElkeDogbnVtYmVyKTogVk5vZGUge1xuICAgICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ2RpdicsIHtcbiAgICAgICAgc3RhdGljQ2xhc3M6ICd2LXRleHQtZmllbGRfX3Nsb3QnLFxuICAgICAgfSwgW1xuICAgICAgICB0aGlzLmdlbklucHV0KG90cElkeCksXG4gICAgICBdKVxuICAgIH0sXG4gICAgb25CbHVyIChlPzogRXZlbnQpIHtcbiAgICAgIHRoaXMuaXNGb2N1c2VkID0gZmFsc2VcbiAgICAgIGUgJiYgdGhpcy4kbmV4dFRpY2soKCkgPT4gdGhpcy4kZW1pdCgnYmx1cicsIGUpKVxuICAgIH0sXG4gICAgb25DbGljayAob3RwSWR4OiBudW1iZXIpIHtcbiAgICAgIGlmICh0aGlzLmlzRm9jdXNlZCB8fCB0aGlzLmlzRGlzYWJsZWQgfHwgIXRoaXMuJHJlZnMuaW5wdXRbb3RwSWR4XSkgcmV0dXJuXG5cbiAgICAgIHRoaXMub25Gb2N1cyh1bmRlZmluZWQsIG90cElkeClcbiAgICB9LFxuICAgIG9uRm9jdXMgKGU/OiBFdmVudCwgb3RwSWR4PzogbnVtYmVyKSB7XG4gICAgICBlPy5wcmV2ZW50RGVmYXVsdCgpXG4gICAgICBlPy5zdG9wUHJvcGFnYXRpb24oKVxuICAgICAgY29uc3QgZWxlbWVudHMgPSB0aGlzLiRyZWZzLmlucHV0IGFzIEhUTUxJbnB1dEVsZW1lbnRbXVxuICAgICAgY29uc3QgcmVmID0gdGhpcy4kcmVmcy5pbnB1dCAmJiBlbGVtZW50c1tvdHBJZHggfHwgMF1cbiAgICAgIGlmICghcmVmKSByZXR1cm5cblxuICAgICAgaWYgKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgIT09IHJlZikge1xuICAgICAgICByZWYuZm9jdXMoKVxuICAgICAgICByZXR1cm4gcmVmLnNlbGVjdCgpXG4gICAgICB9XG5cbiAgICAgIGlmICghdGhpcy5pc0ZvY3VzZWQpIHtcbiAgICAgICAgdGhpcy5pc0ZvY3VzZWQgPSB0cnVlXG4gICAgICAgIHJlZi5zZWxlY3QoKVxuICAgICAgICBlICYmIHRoaXMuJGVtaXQoJ2ZvY3VzJywgZSlcbiAgICAgIH1cbiAgICB9LFxuICAgIG9uSW5wdXQgKGU6IEV2ZW50LCBpbmRleDogbnVtYmVyKSB7XG4gICAgICBjb25zdCBtYXhDdXJzb3IgPSArdGhpcy5sZW5ndGggLSAxXG5cbiAgICAgIGNvbnN0IHRhcmdldCA9IGUudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnRcbiAgICAgIGNvbnN0IHZhbHVlID0gdGFyZ2V0LnZhbHVlXG4gICAgICBjb25zdCBpbnB1dERhdGFBcnJheSA9IHZhbHVlPy5zcGxpdCgnJykgfHwgW11cblxuICAgICAgY29uc3QgbmV3T3RwOiBzdHJpbmdbXSA9IFsuLi50aGlzLm90cF1cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5wdXREYXRhQXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgYXBwSWR4ID0gaW5kZXggKyBpXG4gICAgICAgIGlmIChhcHBJZHggPiBtYXhDdXJzb3IpIGJyZWFrXG4gICAgICAgIG5ld090cFthcHBJZHhdID0gaW5wdXREYXRhQXJyYXlbaV0udG9TdHJpbmcoKVxuICAgICAgfVxuICAgICAgaWYgKCFpbnB1dERhdGFBcnJheS5sZW5ndGgpIHtcbiAgICAgICAgbmV3T3RwLnNwbGljZShpbmRleCwgMSlcbiAgICAgIH1cblxuICAgICAgdGhpcy5vdHAgPSBuZXdPdHBcbiAgICAgIHRoaXMuaW50ZXJuYWxWYWx1ZSA9IHRoaXMub3RwLmpvaW4oJycpXG5cbiAgICAgIGlmIChpbmRleCArIGlucHV0RGF0YUFycmF5Lmxlbmd0aCA+PSArdGhpcy5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5vbkNvbXBsZXRlZCgpXG4gICAgICAgIHRoaXMuY2xlYXJGb2N1cyhpbmRleClcbiAgICAgIH0gZWxzZSBpZiAoaW5wdXREYXRhQXJyYXkubGVuZ3RoKSB7XG4gICAgICAgIHRoaXMuY2hhbmdlRm9jdXMoaW5kZXggKyBpbnB1dERhdGFBcnJheS5sZW5ndGgpXG4gICAgICB9XG4gICAgfSxcbiAgICBjbGVhckZvY3VzIChpbmRleDogbnVtYmVyKSB7XG4gICAgICBjb25zdCBpbnB1dCA9IHRoaXMuJHJlZnMuaW5wdXRbaW5kZXhdIGFzIEhUTUxJbnB1dEVsZW1lbnRcbiAgICAgIGlucHV0LmJsdXIoKVxuICAgIH0sXG4gICAgb25LZXlEb3duIChlOiBLZXlib2FyZEV2ZW50KSB7XG4gICAgICBpZiAoZS5rZXlDb2RlID09PSBrZXlDb2Rlcy5lbnRlcikge1xuICAgICAgICB0aGlzLiRlbWl0KCdjaGFuZ2UnLCB0aGlzLmludGVybmFsVmFsdWUpXG4gICAgICB9XG5cbiAgICAgIHRoaXMuJGVtaXQoJ2tleWRvd24nLCBlKVxuICAgIH0sXG4gICAgb25Nb3VzZURvd24gKGU6IEV2ZW50LCBvdHBJZHg6IG51bWJlcikge1xuICAgICAgLy8gUHJldmVudCBpbnB1dCBmcm9tIGJlaW5nIGJsdXJyZWRcbiAgICAgIGlmIChlLnRhcmdldCAhPT0gdGhpcy4kcmVmcy5pbnB1dFtvdHBJZHhdKSB7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKVxuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpXG4gICAgICB9XG5cbiAgICAgIFZJbnB1dC5vcHRpb25zLm1ldGhvZHMub25Nb3VzZURvd24uY2FsbCh0aGlzLCBlKVxuICAgIH0sXG4gICAgb25Nb3VzZVVwIChlOiBFdmVudCwgb3RwSWR4OiBudW1iZXIpIHtcbiAgICAgIGlmICh0aGlzLmhhc01vdXNlRG93bikgdGhpcy5mb2N1cyhlLCBvdHBJZHgpXG5cbiAgICAgIFZJbnB1dC5vcHRpb25zLm1ldGhvZHMub25Nb3VzZVVwLmNhbGwodGhpcywgZSlcbiAgICB9LFxuICAgIGNoYW5nZUZvY3VzIChpbmRleDogbnVtYmVyKSB7XG4gICAgICB0aGlzLm9uRm9jdXModW5kZWZpbmVkLCBpbmRleCB8fCAwKVxuICAgIH0sXG4gICAgdXBkYXRlVmFsdWUgKHZhbDogYm9vbGVhbikge1xuICAgICAgLy8gU2V0cyB2YWxpZGF0aW9uU3RhdGUgZnJvbSB2YWxpZGF0YWJsZVxuICAgICAgdGhpcy5oYXNDb2xvciA9IHZhbFxuXG4gICAgICBpZiAodmFsKSB7XG4gICAgICAgIHRoaXMuaW5pdGlhbFZhbHVlID0gdGhpcy5sYXp5VmFsdWVcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5pbml0aWFsVmFsdWUgIT09IHRoaXMubGF6eVZhbHVlKSB7XG4gICAgICAgIHRoaXMuJGVtaXQoJ2NoYW5nZScsIHRoaXMubGF6eVZhbHVlKVxuICAgICAgfVxuICAgIH0sXG4gICAgb25LZXlVcCAoZXZlbnQ6IEtleWJvYXJkRXZlbnQsIGluZGV4OiBudW1iZXIpIHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KClcbiAgICAgIGNvbnN0IGV2ZW50S2V5ID0gZXZlbnQua2V5XG4gICAgICBpZiAoWydUYWInLCAnU2hpZnQnLCAnTWV0YScsICdDb250cm9sJywgJ0FsdCddLmluY2x1ZGVzKGV2ZW50S2V5KSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGlmIChbJ0RlbGV0ZSddLmluY2x1ZGVzKGV2ZW50S2V5KSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGlmIChldmVudEtleSA9PT0gJ0Fycm93TGVmdCcgfHwgKGV2ZW50S2V5ID09PSAnQmFja3NwYWNlJyAmJiAhdGhpcy5vdHBbaW5kZXhdKSkge1xuICAgICAgICByZXR1cm4gaW5kZXggPiAwICYmIHRoaXMuY2hhbmdlRm9jdXMoaW5kZXggLSAxKVxuICAgICAgfVxuICAgICAgaWYgKGV2ZW50S2V5ID09PSAnQXJyb3dSaWdodCcpIHtcbiAgICAgICAgcmV0dXJuIGluZGV4ICsgMSA8ICt0aGlzLmxlbmd0aCAmJiB0aGlzLmNoYW5nZUZvY3VzKGluZGV4ICsgMSlcbiAgICAgIH1cbiAgICB9LFxuICAgIG9uQ29tcGxldGVkICgpIHtcbiAgICAgIGNvbnN0IHJzcCA9IHRoaXMub3RwLmpvaW4oJycpXG4gICAgICBpZiAocnNwLmxlbmd0aCA9PT0gK3RoaXMubGVuZ3RoKSB7XG4gICAgICAgIHRoaXMuJGVtaXQoJ2ZpbmlzaCcsIHJzcClcbiAgICAgIH1cbiAgICB9LFxuICB9LFxuICByZW5kZXIgKGgpOiBWTm9kZSB7XG4gICAgcmV0dXJuIGgoJ2RpdicsIHtcbiAgICAgIHN0YXRpY0NsYXNzOiAndi1vdHAtaW5wdXQnLFxuICAgICAgY2xhc3M6IHRoaXMudGhlbWVDbGFzc2VzLFxuICAgIH0sIHRoaXMuZ2VuQ29udGVudCgpKVxuICB9LFxufSlcbiJdfQ==