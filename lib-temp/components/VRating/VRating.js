// Styles
import './VRating.sass';
// Components
import VIcon from '../VIcon';
// Mixins
import Colorable from '../../mixins/colorable';
import Delayable from '../../mixins/delayable';
import Sizeable from '../../mixins/sizeable';
import Rippleable from '../../mixins/rippleable';
import Themeable from '../../mixins/themeable';
// Utilities
import { createRange } from '../../util/helpers';
import mixins from '../../util/mixins';
/* @vue/component */
export default mixins(Colorable, Delayable, Rippleable, Sizeable, Themeable).extend({
    name: 'v-rating',
    props: {
        backgroundColor: {
            type: String,
            default: 'accent',
        },
        color: {
            type: String,
            default: 'primary',
        },
        clearable: Boolean,
        dense: Boolean,
        emptyIcon: {
            type: String,
            default: '$ratingEmpty',
        },
        fullIcon: {
            type: String,
            default: '$ratingFull',
        },
        halfIcon: {
            type: String,
            default: '$ratingHalf',
        },
        halfIncrements: Boolean,
        hover: Boolean,
        length: {
            type: [Number, String],
            default: 5,
        },
        readonly: Boolean,
        size: [Number, String],
        value: {
            type: Number,
            default: 0,
        },
        iconLabel: {
            type: String,
            default: '$vuetify.rating.ariaLabel.icon',
        },
    },
    data() {
        return {
            hoverIndex: -1,
            internalValue: this.value,
        };
    },
    computed: {
        directives() {
            if (this.readonly || !this.ripple)
                return [];
            return [{
                    name: 'ripple',
                    value: { circle: true },
                }];
        },
        iconProps() {
            const { dark, large, light, medium, small, size, xLarge, xSmall, } = this.$props;
            return {
                dark,
                large,
                light,
                medium,
                size,
                small,
                xLarge,
                xSmall,
            };
        },
        isHovering() {
            return this.hover && this.hoverIndex >= 0;
        },
    },
    watch: {
        internalValue(val) {
            val !== this.value && this.$emit('input', val);
        },
        value(val) {
            this.internalValue = val;
        },
    },
    methods: {
        createClickFn(i) {
            return (e) => {
                if (this.readonly)
                    return;
                const newValue = this.genHoverIndex(e, i);
                if (this.clearable && this.internalValue === newValue) {
                    this.internalValue = 0;
                }
                else {
                    this.internalValue = newValue;
                }
            };
        },
        createProps(i) {
            const props = {
                index: i,
                value: this.internalValue,
                click: this.createClickFn(i),
                isFilled: Math.floor(this.internalValue) > i,
                isHovered: Math.floor(this.hoverIndex) > i,
            };
            if (this.halfIncrements) {
                props.isHalfHovered = !props.isHovered && (this.hoverIndex - i) % 1 > 0;
                props.isHalfFilled = !props.isFilled && (this.internalValue - i) % 1 > 0;
            }
            return props;
        },
        genHoverIndex(e, i) {
            let isHalf = this.isHalfEvent(e);
            if (this.halfIncrements &&
                this.$vuetify.rtl) {
                isHalf = !isHalf;
            }
            return i + (isHalf ? 0.5 : 1);
        },
        getIconName(props) {
            const isFull = this.isHovering ? props.isHovered : props.isFilled;
            const isHalf = this.isHovering ? props.isHalfHovered : props.isHalfFilled;
            return isFull ? this.fullIcon : isHalf ? this.halfIcon : this.emptyIcon;
        },
        getColor(props) {
            if (this.isHovering) {
                if (props.isHovered || props.isHalfHovered)
                    return this.color;
            }
            else {
                if (props.isFilled || props.isHalfFilled)
                    return this.color;
            }
            return this.backgroundColor;
        },
        isHalfEvent(e) {
            if (this.halfIncrements) {
                const rect = e.target && e.target.getBoundingClientRect();
                if (rect && (e.pageX - rect.left) < rect.width / 2)
                    return true;
            }
            return false;
        },
        onMouseEnter(e, i) {
            this.runDelay('open', () => {
                this.hoverIndex = this.genHoverIndex(e, i);
            });
        },
        onMouseLeave() {
            this.runDelay('close', () => (this.hoverIndex = -1));
        },
        genItem(i) {
            const props = this.createProps(i);
            if (this.$scopedSlots.item)
                return this.$scopedSlots.item(props);
            const listeners = {
                click: props.click,
            };
            if (this.hover) {
                listeners.mouseenter = (e) => this.onMouseEnter(e, i);
                listeners.mouseleave = this.onMouseLeave;
                if (this.halfIncrements) {
                    listeners.mousemove = (e) => this.onMouseEnter(e, i);
                }
            }
            return this.$createElement(VIcon, this.setTextColor(this.getColor(props), {
                attrs: {
                    'aria-label': this.$vuetify.lang.t(this.iconLabel, i + 1, Number(this.length)),
                },
                directives: this.directives,
                props: this.iconProps,
                on: listeners,
            }), [this.getIconName(props)]);
        },
    },
    render(h) {
        const children = createRange(Number(this.length)).map(i => this.genItem(i));
        return h('div', {
            staticClass: 'v-rating',
            class: {
                'v-rating--readonly': this.readonly,
                'v-rating--dense': this.dense,
            },
        }, children);
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlJhdGluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1ZSYXRpbmcvVlJhdGluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTO0FBQ1QsT0FBTyxnQkFBZ0IsQ0FBQTtBQUV2QixhQUFhO0FBQ2IsT0FBTyxLQUFLLE1BQU0sVUFBVSxDQUFBO0FBRTVCLFNBQVM7QUFDVCxPQUFPLFNBQVMsTUFBTSx3QkFBd0IsQ0FBQTtBQUM5QyxPQUFPLFNBQVMsTUFBTSx3QkFBd0IsQ0FBQTtBQUM5QyxPQUFPLFFBQVEsTUFBTSx1QkFBdUIsQ0FBQTtBQUM1QyxPQUFPLFVBQVUsTUFBTSx5QkFBeUIsQ0FBQTtBQUNoRCxPQUFPLFNBQVMsTUFBTSx3QkFBd0IsQ0FBQTtBQUU5QyxZQUFZO0FBQ1osT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG9CQUFvQixDQUFBO0FBQ2hELE9BQU8sTUFBTSxNQUFNLG1CQUFtQixDQUFBO0FBZXRDLG9CQUFvQjtBQUNwQixlQUFlLE1BQU0sQ0FDbkIsU0FBUyxFQUNULFNBQVMsRUFDVCxVQUFVLEVBQ1YsUUFBUSxFQUNSLFNBQVMsQ0FDVixDQUFDLE1BQU0sQ0FBQztJQUNQLElBQUksRUFBRSxVQUFVO0lBRWhCLEtBQUssRUFBRTtRQUNMLGVBQWUsRUFBRTtZQUNmLElBQUksRUFBRSxNQUFNO1lBQ1osT0FBTyxFQUFFLFFBQVE7U0FDbEI7UUFDRCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU8sRUFBRSxTQUFTO1NBQ25CO1FBQ0QsU0FBUyxFQUFFLE9BQU87UUFDbEIsS0FBSyxFQUFFLE9BQU87UUFDZCxTQUFTLEVBQUU7WUFDVCxJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU8sRUFBRSxjQUFjO1NBQ3hCO1FBQ0QsUUFBUSxFQUFFO1lBQ1IsSUFBSSxFQUFFLE1BQU07WUFDWixPQUFPLEVBQUUsYUFBYTtTQUN2QjtRQUNELFFBQVEsRUFBRTtZ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RUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ2hDLENBQUM7S0FDRjtJQUVELE1BQU0sQ0FBRSxDQUFDO1FBQ1AsTUFBTSxRQUFRLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFFM0UsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFO1lBQ2QsV0FBVyxFQUFFLFVBQVU7WUFDdkIsS0FBSyxFQUFFO2dCQUNMLG9CQUFvQixFQUFFLElBQUksQ0FBQyxRQUFRO2dCQUNuQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsS0FBSzthQUM5QjtTQUNGLEVBQUUsUUFBUSxDQUFDLENBQUE7SUFDZCxDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU3R5bGVzXG5pbXBvcnQgJy4vVlJhdGluZy5zYXNzJ1xuXG4vLyBDb21wb25lbnRzXG5pbXBvcnQgVkljb24gZnJvbSAnLi4vVkljb24nXG5cbi8vIE1peGluc1xuaW1wb3J0IENvbG9yYWJsZSBmcm9tICcuLi8uLi9taXhpbnMvY29sb3JhYmxlJ1xuaW1wb3J0IERlbGF5YWJsZSBmcm9tICcuLi8uLi9taXhpbnMvZGVsYXlhYmxlJ1xuaW1wb3J0IFNpemVhYmxlIGZyb20gJy4uLy4uL21peGlucy9zaXplYWJsZSdcbmltcG9ydCBSaXBwbGVhYmxlIGZyb20gJy4uLy4uL21peGlucy9yaXBwbGVhYmxlJ1xuaW1wb3J0IFRoZW1lYWJsZSBmcm9tICcuLi8uLi9taXhpbnMvdGhlbWVhYmxlJ1xuXG4vLyBVdGlsaXRpZXNcbmltcG9ydCB7IGNyZWF0ZVJhbmdlIH0gZnJvbSAnLi4vLi4vdXRpbC9oZWxwZXJzJ1xuaW1wb3J0IG1peGlucyBmcm9tICcuLi8uLi91dGlsL21peGlucydcblxuLy8gVHlwZXNcbmltcG9ydCB7IFZOb2RlLCBWTm9kZURpcmVjdGl2ZSwgVk5vZGVDaGlsZHJlbiB9IGZyb20gJ3Z1ZSdcblxudHlwZSBJdGVtU2xvdFByb3BzID0ge1xuICBpbmRleDogbnVtYmVyXG4gIHZhbHVlOiBudW1iZXJcbiAgaXNGaWxsZWQ6IGJvb2xlYW5cbiAgaXNIYWxmRmlsbGVkPzogYm9vbGVhbiB8IHVuZGVmaW5lZFxuICBpc0hvdmVyZWQ6IGJvb2xlYW5cbiAgaXNIYWxmSG92ZXJlZD86IGJvb2xlYW4gfCB1bmRlZmluZWRcbiAgY2xpY2s6IEZ1bmN0aW9uXG59XG5cbi8qIEB2dWUvY29tcG9uZW50ICovXG5leHBvcnQgZGVmYXVsdCBtaXhpbnMoXG4gIENvbG9yYWJsZSxcbiAgRGVsYXlhYmxlLFxuICBSaXBwbGVhYmxlLFxuICBTaXplYWJsZSxcbiAgVGhlbWVhYmxlXG4pLmV4dGVuZCh7XG4gIG5hbWU6ICd2LXJhdGluZycsXG5cbiAgcHJvcHM6IHtcbiAgICBiYWNrZ3JvdW5kQ29sb3I6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGRlZmF1bHQ6ICdhY2NlbnQnLFxuICAgIH0sXG4gICAgY29sb3I6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGRlZmF1bHQ6ICdwcmltYXJ5JyxcbiAgICB9LFxuICAgIGNsZWFyYWJsZTogQm9vbGVhbixcbiAgICBkZW5zZTogQm9vbGVhbixcbiAgICBlbXB0eUljb246IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGRlZmF1bHQ6ICckcmF0aW5nRW1wdHknLFxuICAgIH0sXG4gICAgZnVsbEljb246IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGRlZmF1bHQ6ICckcmF0aW5nRnVsbCcsXG4gICAgfSxcbiAgICBoYWxmSWNvbjoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZGVmYXVsdDogJyRyYXRpbmdIYWxmJyxcbiAgICB9LFxuICAgIGhhbGZJbmNyZW1lbnRzOiBCb29sZWFuLFxuICAgIGhvdmVyOiBCb29sZWFuLFxuICAgIGxlbmd0aDoge1xuICAgICAgdHlwZTogW051bWJlciwgU3RyaW5nXSxcbiAgICAgIGRlZmF1bHQ6IDUsXG4gICAgfSxcbiAgICByZWFkb25seTogQm9vbGVhbixcbiAgICBzaXplOiBbTnVtYmVyLCBTdHJpbmddLFxuICAgIHZhbHVlOiB7XG4gICAgICB0eXBlOiBOdW1iZXIsXG4gICAgICBkZWZhdWx0OiAwLFxuICAgIH0sXG4gICAgaWNvbkxhYmVsOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICBkZWZhdWx0OiAnJHZ1ZXRpZnkucmF0aW5nLmFyaWFMYWJlbC5pY29uJyxcbiAgICB9LFxuICB9LFxuXG4gIGRhdGEgKCkge1xuICAgIHJldHVybiB7XG4gICAgICBob3ZlckluZGV4OiAtMSxcbiAgICAgIGludGVybmFsVmFsdWU6IHRoaXMudmFsdWUsXG4gICAgfVxuICB9LFxuXG4gIGNvbXB1dGVkOiB7XG4gICAgZGlyZWN0aXZlcyAoKTogVk5vZGVEaXJlY3RpdmVbXSB7XG4gICAgICBpZiAodGhpcy5yZWFkb25seSB8fCAhdGhpcy5yaXBwbGUpIHJldHVybiBbXVxuXG4gICAgICByZXR1cm4gW3tcbiAgICAgICAgbmFtZTogJ3JpcHBsZScsXG4gICAgICAgIHZhbHVlOiB7IGNpcmNsZTogdHJ1ZSB9LFxuICAgICAgfSBhcyBWTm9kZURpcmVjdGl2ZV1cbiAgICB9LFxuICAgIGljb25Qcm9wcyAoKTogb2JqZWN0IHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgZGFyayxcbiAgICAgICAgbGFyZ2UsXG4gICAgICAgIGxpZ2h0LFxuICAgICAgICBtZWRpdW0sXG4gICAgICAgIHNtYWxsLFxuICAgICAgICBzaXplLFxuICAgICAgICB4TGFyZ2UsXG4gICAgICAgIHhTbWFsbCxcbiAgICAgIH0gPSB0aGlzLiRwcm9wc1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBkYXJrLFxuICAgICAgICBsYXJnZSxcbiAgICAgICAgbGlnaHQsXG4gICAgICAgIG1lZGl1bSxcbiAgICAgICAgc2l6ZSxcbiAgICAgICAgc21hbGwsXG4gICAgICAgIHhMYXJnZSxcbiAgICAgICAgeFNtYWxsLFxuICAgICAgfVxuICAgIH0sXG4gICAgaXNIb3ZlcmluZyAoKTogYm9vbGVhbiB7XG4gICAgICByZXR1cm4gdGhpcy5ob3ZlciAmJiB0aGlzLmhvdmVySW5kZXggPj0gMFxuICAgIH0sXG4gIH0sXG5cbiAgd2F0Y2g6IHtcbiAgICBpbnRlcm5hbFZhbHVlICh2YWwpIHtcbiAgICAgIHZhbCAhPT0gdGhpcy52YWx1ZSAmJiB0aGlzLiRlbWl0KCdpbnB1dCcsIHZhbClcbiAgICB9LFxuICAgIHZhbHVlICh2YWwpIHtcbiAgICAgIHRoaXMuaW50ZXJuYWxWYWx1ZSA9IHZhbFxuICAgIH0sXG4gIH0sXG5cbiAgbWV0aG9kczoge1xuICAgIGNyZWF0ZUNsaWNrRm4gKGk6IG51bWJlcik6IEZ1bmN0aW9uIHtcbiAgICAgIHJldHVybiAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5yZWFkb25seSkgcmV0dXJuXG5cbiAgICAgICAgY29uc3QgbmV3VmFsdWUgPSB0aGlzLmdlbkhvdmVySW5kZXgoZSwgaSlcbiAgICAgICAgaWYgKHRoaXMuY2xlYXJhYmxlICYmIHRoaXMuaW50ZXJuYWxWYWx1ZSA9PT0gbmV3VmFsdWUpIHtcbiAgICAgICAgICB0aGlzLmludGVybmFsVmFsdWUgPSAwXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5pbnRlcm5hbFZhbHVlID0gbmV3VmFsdWVcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG4gICAgY3JlYXRlUHJvcHMgKGk6IG51bWJlcik6IEl0ZW1TbG90UHJvcHMge1xuICAgICAgY29uc3QgcHJvcHM6IEl0ZW1TbG90UHJvcHMgPSB7XG4gICAgICAgIGluZGV4OiBpLFxuICAgICAgICB2YWx1ZTogdGhpcy5pbnRlcm5hbFZhbHVlLFxuICAgICAgICBjbGljazogdGhpcy5jcmVhdGVDbGlja0ZuKGkpLFxuICAgICAgICBpc0ZpbGxlZDogTWF0aC5mbG9vcih0aGlzLmludGVybmFsVmFsdWUpID4gaSxcbiAgICAgICAgaXNIb3ZlcmVkOiBNYXRoLmZsb29yKHRoaXMuaG92ZXJJbmRleCkgPiBpLFxuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5oYWxmSW5jcmVtZW50cykge1xuICAgICAgICBwcm9wcy5pc0hhbGZIb3ZlcmVkID0gIXByb3BzLmlzSG92ZXJlZCAmJiAodGhpcy5ob3ZlckluZGV4IC0gaSkgJSAxID4gMFxuICAgICAgICBwcm9wcy5pc0hhbGZGaWxsZWQgPSAhcHJvcHMuaXNGaWxsZWQgJiYgKHRoaXMuaW50ZXJuYWxWYWx1ZSAtIGkpICUgMSA+IDBcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHByb3BzXG4gICAgfSxcbiAgICBnZW5Ib3ZlckluZGV4IChlOiBNb3VzZUV2ZW50LCBpOiBudW1iZXIpIHtcbiAgICAgIGxldCBpc0hhbGYgPSB0aGlzLmlzSGFsZkV2ZW50KGUpXG5cbiAgICAgIGlmIChcbiAgICAgICAgdGhpcy5oYWxmSW5jcmVtZW50cyAmJlxuICAgICAgICB0aGlzLiR2dWV0aWZ5LnJ0bFxuICAgICAgKSB7XG4gICAgICAgIGlzSGFsZiA9ICFpc0hhbGZcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGkgKyAoaXNIYWxmID8gMC41IDogMSlcbiAgICB9LFxuICAgIGdldEljb25OYW1lIChwcm9wczogSXRlbVNsb3RQcm9wcyk6IHN0cmluZyB7XG4gICAgICBjb25zdCBpc0Z1bGwgPSB0aGlzLmlzSG92ZXJpbmcgPyBwcm9wcy5pc0hvdmVyZWQgOiBwcm9wcy5pc0ZpbGxlZFxuICAgICAgY29uc3QgaXNIYWxmID0gdGhpcy5pc0hvdmVyaW5nID8gcHJvcHMuaXNIYWxmSG92ZXJlZCA6IHByb3BzLmlzSGFsZkZpbGxlZFxuXG4gICAgICByZXR1cm4gaXNGdWxsID8gdGhpcy5mdWxsSWNvbiA6IGlzSGFsZiA/IHRoaXMuaGFsZkljb24gOiB0aGlzLmVtcHR5SWNvblxuICAgIH0sXG4gICAgZ2V0Q29sb3IgKHByb3BzOiBJdGVtU2xvdFByb3BzKTogc3RyaW5nIHtcbiAgICAgIGlmICh0aGlzLmlzSG92ZXJpbmcpIHtcbiAgICAgICAgaWYgKHByb3BzLmlzSG92ZXJlZCB8fCBwcm9wcy5pc0hhbGZIb3ZlcmVkKSByZXR1cm4gdGhpcy5jb2xvclxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHByb3BzLmlzRmlsbGVkIHx8IHByb3BzLmlzSGFsZkZpbGxlZCkgcmV0dXJuIHRoaXMuY29sb3JcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuYmFja2dyb3VuZENvbG9yXG4gICAgfSxcbiAgICBpc0hhbGZFdmVudCAoZTogTW91c2VFdmVudCk6IGJvb2xlYW4ge1xuICAgICAgaWYgKHRoaXMuaGFsZkluY3JlbWVudHMpIHtcbiAgICAgICAgY29uc3QgcmVjdCA9IGUudGFyZ2V0ICYmIChlLnRhcmdldCBhcyBIVE1MRWxlbWVudCkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcbiAgICAgICAgaWYgKHJlY3QgJiYgKGUucGFnZVggLSByZWN0LmxlZnQpIDwgcmVjdC53aWR0aCAvIDIpIHJldHVybiB0cnVlXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH0sXG4gICAgb25Nb3VzZUVudGVyIChlOiBNb3VzZUV2ZW50LCBpOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgIHRoaXMucnVuRGVsYXkoJ29wZW4nLCAoKSA9PiB7XG4gICAgICAgIHRoaXMuaG92ZXJJbmRleCA9IHRoaXMuZ2VuSG92ZXJJbmRleChlLCBpKVxuICAgICAgfSlcbiAgICB9LFxuICAgIG9uTW91c2VMZWF2ZSAoKTogdm9pZCB7XG4gICAgICB0aGlzLnJ1bkRlbGF5KCdjbG9zZScsICgpID0+ICh0aGlzLmhvdmVySW5kZXggPSAtMSkpXG4gICAgfSxcbiAgICBnZW5JdGVtIChpOiBudW1iZXIpOiBWTm9kZSB8IFZOb2RlQ2hpbGRyZW4gfCBzdHJpbmcge1xuICAgICAgY29uc3QgcHJvcHMgPSB0aGlzLmNyZWF0ZVByb3BzKGkpXG5cbiAgICAgIGlmICh0aGlzLiRzY29wZWRTbG90cy5pdGVtKSByZXR1cm4gdGhpcy4kc2NvcGVkU2xvdHMuaXRlbShwcm9wcylcblxuICAgICAgY29uc3QgbGlzdGVuZXJzOiBSZWNvcmQ8c3RyaW5nLCBGdW5jdGlvbj4gPSB7XG4gICAgICAgIGNsaWNrOiBwcm9wcy5jbGljayxcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMuaG92ZXIpIHtcbiAgICAgICAgbGlzdGVuZXJzLm1vdXNlZW50ZXIgPSAoZTogTW91c2VFdmVudCkgPT4gdGhpcy5vbk1vdXNlRW50ZXIoZSwgaSlcbiAgICAgICAgbGlzdGVuZXJzLm1vdXNlbGVhdmUgPSB0aGlzLm9uTW91c2VMZWF2ZVxuXG4gICAgICAgIGlmICh0aGlzLmhhbGZJbmNyZW1lbnRzKSB7XG4gICAgICAgICAgbGlzdGVuZXJzLm1vdXNlbW92ZSA9IChlOiBNb3VzZUV2ZW50KSA9PiB0aGlzLm9uTW91c2VFbnRlcihlLCBpKVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KFZJY29uLCB0aGlzLnNldFRleHRDb2xvcih0aGlzLmdldENvbG9yKHByb3BzKSwge1xuICAgICAgICBhdHRyczoge1xuICAgICAgICAgICdhcmlhLWxhYmVsJzogdGhpcy4kdnVldGlmeS5sYW5nLnQodGhpcy5pY29uTGFiZWwsIGkgKyAxLCBOdW1iZXIodGhpcy5sZW5ndGgpKSxcbiAgICAgICAgfSxcbiAgICAgICAgZGlyZWN0aXZlczogdGhpcy5kaXJlY3RpdmVzLFxuICAgICAgICBwcm9wczogdGhpcy5pY29uUHJvcHMsXG4gICAgICAgIG9uOiBsaXN0ZW5lcnMsXG4gICAgICB9KSwgW3RoaXMuZ2V0SWNvbk5hbWUocHJvcHMpXSlcbiAgICB9LFxuICB9LFxuXG4gIHJlbmRlciAoaCk6IFZOb2RlIHtcbiAgICBjb25zdCBjaGlsZHJlbiA9IGNyZWF0ZVJhbmdlKE51bWJlcih0aGlzLmxlbmd0aCkpLm1hcChpID0+IHRoaXMuZ2VuSXRlbShpKSlcblxuICAgIHJldHVybiBoKCdkaXYnLCB7XG4gICAgICBzdGF0aWNDbGFzczogJ3YtcmF0aW5nJyxcbiAgICAgIGNsYXNzOiB7XG4gICAgICAgICd2LXJhdGluZy0tcmVhZG9ubHknOiB0aGlzLnJlYWRvbmx5LFxuICAgICAgICAndi1yYXRpbmctLWRlbnNlJzogdGhpcy5kZW5zZSxcbiAgICAgIH0sXG4gICAgfSwgY2hpbGRyZW4pXG4gIH0sXG59KVxuIl19