// Mixins
import DatePickerTable from './mixins/date-picker-table';
// Utils
import { weekNumber } from '../../util/dateTimeUtils';
import { pad, createNativeLocaleFormatter, monthChange } from './util';
import { createRange } from '../../util/helpers';
import mixins from '../../util/mixins';
export default mixins(DatePickerTable
/* @vue/component */
).extend({
    name: 'v-date-picker-date-table',
    props: {
        firstDayOfWeek: {
            type: [String, Number],
            default: 0,
        },
        localeFirstDayOfYear: {
            type: [String, Number],
            default: 0,
        },
        showAdjacentMonths: Boolean,
        showWeek: Boolean,
        weekdayFormat: Function,
    },
    computed: {
        formatter() {
            return this.format || createNativeLocaleFormatter(this.currentLocale, { day: 'numeric', timeZone: 'UTC' }, { start: 8, length: 2 });
        },
        weekdayFormatter() {
            return this.weekdayFormat || createNativeLocaleFormatter(this.currentLocale, { weekday: 'narrow', timeZone: 'UTC' });
        },
        weekDays() {
            const first = parseInt(this.firstDayOfWeek, 10);
            return this.weekdayFormatter
                ? createRange(7).map(i => this.weekdayFormatter(`2017-01-${first + i + 15}`)) // 2017-01-15 is Sunday
                : createRange(7).map(i => ['S', 'M', 'T', 'W', 'T', 'F', 'S'][(i + first) % 7]);
        },
    },
    methods: {
        calculateTableDate(delta) {
            return monthChange(this.tableDate, Math.sign(delta || 1));
        },
        genTHead() {
            const days = this.weekDays.map(day => this.$createElement('th', day));
            if (this.showWeek) {
                days.unshift(this.$createElement('th'));
            }
            return this.$createElement('thead', this.genTR(days));
        },
        // Returns number of the days from the firstDayOfWeek to the first day of the current month
        weekDaysBeforeFirstDayOfTheMonth() {
            const firstDayOfTheMonth = new Date(`${this.displayedYear}-${pad(this.displayedMonth + 1)}-01T00:00:00+00:00`);
            const weekDay = firstDayOfTheMonth.getUTCDay();
            return (weekDay - parseInt(this.firstDayOfWeek) + 7) % 7;
        },
        getWeekNumber(dayInMonth) {
            return weekNumber(this.displayedYear, this.displayedMonth, dayInMonth, parseInt(this.firstDayOfWeek), parseInt(this.localeFirstDayOfYear));
        },
        genWeekNumber(weekNumber) {
            return this.$createElement('td', [
                this.$createElement('small', {
                    staticClass: 'v-date-picker-table--date__week',
                }, String(weekNumber).padStart(2, '0')),
            ]);
        },
        // eslint-disable-next-line max-statements
        genTBody() {
            const children = [];
            const daysInMonth = new Date(this.displayedYear, this.displayedMonth + 1, 0).getDate();
            let rows = [];
            let day = this.weekDaysBeforeFirstDayOfTheMonth();
            if (this.showWeek) {
                rows.push(this.genWeekNumber(this.getWeekNumber(1)));
            }
            const prevMonthYear = this.displayedMonth ? this.displayedYear : this.displayedYear - 1;
            const prevMonth = (this.displayedMonth + 11) % 12;
            const firstDayFromPreviousMonth = new Date(this.displayedYear, this.displayedMonth, 0).getDate();
            const cellsInRow = this.showWeek ? 8 : 7;
            while (day--) {
                const date = `${prevMonthYear}-${pad(prevMonth + 1)}-${pad(firstDayFromPreviousMonth - day)}`;
                rows.push(this.$createElement('td', this.showAdjacentMonths ? [
                    this.genButton(date, true, 'date', this.formatter, true),
                ] : []));
            }
            for (day = 1; day <= daysInMonth; day++) {
                const date = `${this.displayedYear}-${pad(this.displayedMonth + 1)}-${pad(day)}`;
                rows.push(this.$createElement('td', [
                    this.genButton(date, true, 'date', this.formatter),
                ]));
                if (rows.length % cellsInRow === 0) {
                    children.push(this.genTR(rows));
                    rows = [];
                    if (this.showWeek && (day < daysInMonth || this.showAdjacentMonths)) {
                        rows.push(this.genWeekNumber(this.getWeekNumber(day + 7)));
                    }
                }
            }
            const nextMonthYear = this.displayedMonth === 11 ? this.displayedYear + 1 : this.displayedYear;
            const nextMonth = (this.displayedMonth + 1) % 12;
            let nextMonthDay = 1;
            while (rows.length < cellsInRow) {
                const date = `${nextMonthYear}-${pad(nextMonth + 1)}-${pad(nextMonthDay++)}`;
                rows.push(this.$createElement('td', this.showAdjacentMonths ? [
                    this.genButton(date, true, 'date', this.formatter, true),
                ] : []));
            }
            if (rows.length) {
                children.push(this.genTR(rows));
            }
            return this.$createElement('tbody', children);
        },
        genTR(children) {
            return [this.$createElement('tr', children)];
        },
    },
    render() {
        return this.genTable('v-date-picker-table v-date-picker-table--date', [
            this.genTHead(),
            this.genTBody(),
        ], this.calculateTableDate);
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVkRhdGVQaWNrZXJEYXRlVGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tcG9uZW50cy9WRGF0ZVBpY2tlci9WRGF0ZVBpY2tlckRhdGVUYWJsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTO0FBQ1QsT0FBTyxlQUFlLE1BQU0sNEJBQTRCLENBQUE7QUFFeEQsUUFBUTtBQUNSLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQTtBQUNyRCxPQUFPLEVBQUUsR0FBRyxFQUFFLDJCQUEyQixFQUFFLFdBQVcsRUFBRSxNQUFNLFFBQVEsQ0FBQTtBQUN0RSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFDaEQsT0FBTyxNQUFNLE1BQU0sbUJBQW1CLENBQUE7QUFNdEMsZUFBZSxNQUFNLENBQ25CLGVBQWU7QUFDakIsb0JBQW9CO0NBQ25CLENBQUMsTUFBTSxDQUFDO0lBQ1AsSUFBSSxFQUFFLDBCQUEwQjtJQUVoQyxLQUFLLEVBQUU7UUFDTCxjQUFjLEVBQUU7WUFDZCxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxvQkFBb0IsRUFBRTtZQUNwQixJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxrQkFBa0IsRUFBRSxPQUFPO1FBQzNCLFFBQVEsRUFBRSxPQUFPO1FBQ2pCLGFBQWEsRUFBRSxRQUFxRDtLQUNyRTtJQUVELFFBQVEsRUFBRTtRQUNSLFNBQVM7WUFDUCxPQUFPLElBQUksQ0FBQyxNQUFNLElBQUksMkJBQTJCLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUs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QUFDLCtDQUErQyxFQUFFO1lBQ3BFLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDZixJQUFJLENBQUMsUUFBUSxFQUFFO1NBQ2hCLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUE7SUFDN0IsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIE1peGluc1xuaW1wb3J0IERhdGVQaWNrZXJUYWJsZSBmcm9tICcuL21peGlucy9kYXRlLXBpY2tlci10YWJsZSdcblxuLy8gVXRpbHNcbmltcG9ydCB7IHdlZWtOdW1iZXIgfSBmcm9tICcuLi8uLi91dGlsL2RhdGVUaW1lVXRpbHMnXG5pbXBvcnQgeyBwYWQsIGNyZWF0ZU5hdGl2ZUxvY2FsZUZvcm1hdHRlciwgbW9udGhDaGFuZ2UgfSBmcm9tICcuL3V0aWwnXG5pbXBvcnQgeyBjcmVhdGVSYW5nZSB9IGZyb20gJy4uLy4uL3V0aWwvaGVscGVycydcbmltcG9ydCBtaXhpbnMgZnJvbSAnLi4vLi4vdXRpbC9taXhpbnMnXG5cbi8vIFR5cGVzXG5pbXBvcnQgeyBWTm9kZSwgVk5vZGVDaGlsZHJlbiwgUHJvcFR5cGUgfSBmcm9tICd2dWUnXG5pbXBvcnQgeyBEYXRlUGlja2VyRm9ybWF0dGVyIH0gZnJvbSAndnVldGlmeS90eXBlcydcblxuZXhwb3J0IGRlZmF1bHQgbWl4aW5zKFxuICBEYXRlUGlja2VyVGFibGVcbi8qIEB2dWUvY29tcG9uZW50ICovXG4pLmV4dGVuZCh7XG4gIG5hbWU6ICd2LWRhdGUtcGlja2VyLWRhdGUtdGFibGUnLFxuXG4gIHByb3BzOiB7XG4gICAgZmlyc3REYXlPZldlZWs6IHtcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXG4gICAgICBkZWZhdWx0OiAwLFxuICAgIH0sXG4gICAgbG9jYWxlRmlyc3REYXlPZlllYXI6IHtcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXG4gICAgICBkZWZhdWx0OiAwLFxuICAgIH0sXG4gICAgc2hvd0FkamFjZW50TW9udGhzOiBCb29sZWFuLFxuICAgIHNob3dXZWVrOiBCb29sZWFuLFxuICAgIHdlZWtkYXlGb3JtYXQ6IEZ1bmN0aW9uIGFzIFByb3BUeXBlPERhdGVQaWNrZXJGb3JtYXR0ZXIgfCB1bmRlZmluZWQ+LFxuICB9LFxuXG4gIGNvbXB1dGVkOiB7XG4gICAgZm9ybWF0dGVyICgpOiBEYXRlUGlja2VyRm9ybWF0dGVyIHtcbiAgICAgIHJldHVybiB0aGlzLmZvcm1hdCB8fCBjcmVhdGVOYXRpdmVMb2NhbGVGb3JtYXR0ZXIodGhpcy5jdXJyZW50TG9jYWxlLCB7IGRheTogJ251bWVyaWMnLCB0aW1lWm9uZTogJ1VUQycgfSwgeyBzdGFydDogOCwgbGVuZ3RoOiAyIH0pXG4gICAgfSxcbiAgICB3ZWVrZGF5Rm9ybWF0dGVyICgpOiBEYXRlUGlja2VyRm9ybWF0dGVyIHwgdW5kZWZpbmVkIHtcbiAgICAgIHJldHVybiB0aGlzLndlZWtkYXlGb3JtYXQgfHwgY3JlYXRlTmF0aXZlTG9jYWxlRm9ybWF0dGVyKHRoaXMuY3VycmVudExvY2FsZSwgeyB3ZWVrZGF5OiAnbmFycm93JywgdGltZVpvbmU6ICdVVEMnIH0pXG4gICAgfSxcbiAgICB3ZWVrRGF5cyAoKTogc3RyaW5nW10ge1xuICAgICAgY29uc3QgZmlyc3QgPSBwYXJzZUludCh0aGlzLmZpcnN0RGF5T2ZXZWVrLCAxMClcblxuICAgICAgcmV0dXJuIHRoaXMud2Vla2RheUZvcm1hdHRlclxuICAgICAgICA/IGNyZWF0ZVJhbmdlKDcpLm1hcChpID0+IHRoaXMud2Vla2RheUZvcm1hdHRlciEoYDIwMTctMDEtJHtmaXJzdCArIGkgKyAxNX1gKSkgLy8gMjAxNy0wMS0xNSBpcyBTdW5kYXlcbiAgICAgICAgOiBjcmVhdGVSYW5nZSg3KS5tYXAoaSA9PiBbJ1MnLCAnTScsICdUJywgJ1cnLCAnVCcsICdGJywgJ1MnXVsoaSArIGZpcnN0KSAlIDddKVxuICAgIH0sXG4gIH0sXG5cbiAgbWV0aG9kczoge1xuICAgIGNhbGN1bGF0ZVRhYmxlRGF0ZSAoZGVsdGE6IG51bWJlcikge1xuICAgICAgcmV0dXJuIG1vbnRoQ2hhbmdlKHRoaXMudGFibGVEYXRlLCBNYXRoLnNpZ24oZGVsdGEgfHwgMSkpXG4gICAgfSxcbiAgICBnZW5USGVhZCAoKSB7XG4gICAgICBjb25zdCBkYXlzID0gdGhpcy53ZWVrRGF5cy5tYXAoZGF5ID0+IHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ3RoJywgZGF5KSlcbiAgICAgIGlmICh0aGlzLnNob3dXZWVrKSB7XG4gICAgICAgIGRheXMudW5zaGlmdCh0aGlzLiRjcmVhdGVFbGVtZW50KCd0aCcpKVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy4kY3JlYXRlRWxlbWVudCgndGhlYWQnLCB0aGlzLmdlblRSKGRheXMpKVxuICAgIH0sXG4gICAgLy8gUmV0dXJucyBudW1iZXIgb2YgdGhlIGRheXMgZnJvbSB0aGUgZmlyc3REYXlPZldlZWsgdG8gdGhlIGZpcnN0IGRheSBvZiB0aGUgY3VycmVudCBtb250aFxuICAgIHdlZWtEYXlzQmVmb3JlRmlyc3REYXlPZlRoZU1vbnRoICgpIHtcbiAgICAgIGNvbnN0IGZpcnN0RGF5T2ZUaGVNb250aCA9IG5ldyBEYXRlKGAke3RoaXMuZGlzcGxheWVkWWVhcn0tJHtwYWQodGhpcy5kaXNwbGF5ZWRNb250aCArIDEpfS0wMVQwMDowMDowMCswMDowMGApXG4gICAgICBjb25zdCB3ZWVrRGF5ID0gZmlyc3REYXlPZlRoZU1vbnRoLmdldFVUQ0RheSgpXG5cbiAgICAgIHJldHVybiAod2Vla0RheSAtIHBhcnNlSW50KHRoaXMuZmlyc3REYXlPZldlZWspICsgNykgJSA3XG4gICAgfSxcbiAgICBnZXRXZWVrTnVtYmVyIChkYXlJbk1vbnRoOiBudW1iZXIpIHtcbiAgICAgIHJldHVybiB3ZWVrTnVtYmVyKFxuICAgICAgICB0aGlzLmRpc3BsYXllZFllYXIsXG4gICAgICAgIHRoaXMuZGlzcGxheWVkTW9udGgsXG4gICAgICAgIGRheUluTW9udGgsXG4gICAgICAgIHBhcnNlSW50KHRoaXMuZmlyc3REYXlPZldlZWspLFxuICAgICAgICBwYXJzZUludCh0aGlzLmxvY2FsZUZpcnN0RGF5T2ZZZWFyKVxuICAgICAgKVxuICAgIH0sXG4gICAgZ2VuV2Vla051bWJlciAod2Vla051bWJlcjogbnVtYmVyKSB7XG4gICAgICByZXR1cm4gdGhpcy4kY3JlYXRlRWxlbWVudCgndGQnLCBbXG4gICAgICAgIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ3NtYWxsJywge1xuICAgICAgICAgIHN0YXRpY0NsYXNzOiAndi1kYXRlLXBpY2tlci10YWJsZS0tZGF0ZV9fd2VlaycsXG4gICAgICAgIH0sIFN0cmluZyh3ZWVrTnVtYmVyKS5wYWRTdGFydCgyLCAnMCcpKSxcbiAgICAgIF0pXG4gICAgfSxcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LXN0YXRlbWVudHNcbiAgICBnZW5UQm9keSAoKSB7XG4gICAgICBjb25zdCBjaGlsZHJlbiA9IFtdXG4gICAgICBjb25zdCBkYXlzSW5Nb250aCA9IG5ldyBEYXRlKHRoaXMuZGlzcGxheWVkWWVhciwgdGhpcy5kaXNwbGF5ZWRNb250aCArIDEsIDApLmdldERhdGUoKVxuICAgICAgbGV0IHJvd3MgPSBbXVxuICAgICAgbGV0IGRheSA9IHRoaXMud2Vla0RheXNCZWZvcmVGaXJzdERheU9mVGhlTW9udGgoKVxuXG4gICAgICBpZiAodGhpcy5zaG93V2Vlaykge1xuICAgICAgICByb3dzLnB1c2godGhpcy5nZW5XZWVrTnVtYmVyKHRoaXMuZ2V0V2Vla051bWJlcigxKSkpXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHByZXZNb250aFllYXIgPSB0aGlzLmRpc3BsYXllZE1vbnRoID8gdGhpcy5kaXNwbGF5ZWRZZWFyIDogdGhpcy5kaXNwbGF5ZWRZZWFyIC0gMVxuICAgICAgY29uc3QgcHJldk1vbnRoID0gKHRoaXMuZGlzcGxheWVkTW9udGggKyAxMSkgJSAxMlxuICAgICAgY29uc3QgZmlyc3REYXlGcm9tUHJldmlvdXNNb250aCA9IG5ldyBEYXRlKHRoaXMuZGlzcGxheWVkWWVhciwgdGhpcy5kaXNwbGF5ZWRNb250aCwgMCkuZ2V0RGF0ZSgpXG4gICAgICBjb25zdCBjZWxsc0luUm93ID0gdGhpcy5zaG93V2VlayA/IDggOiA3XG5cbiAgICAgIHdoaWxlIChkYXktLSkge1xuICAgICAgICBjb25zdCBkYXRlID0gYCR7cHJldk1vbnRoWWVhcn0tJHtwYWQocHJldk1vbnRoICsgMSl9LSR7cGFkKGZpcnN0RGF5RnJvbVByZXZpb3VzTW9udGggLSBkYXkpfWBcblxuICAgICAgICByb3dzLnB1c2godGhpcy4kY3JlYXRlRWxlbWVudCgndGQnLCB0aGlzLnNob3dBZGphY2VudE1vbnRocyA/IFtcbiAgICAgICAgICB0aGlzLmdlbkJ1dHRvbihkYXRlLCB0cnVlLCAnZGF0ZScsIHRoaXMuZm9ybWF0dGVyLCB0cnVlKSxcbiAgICAgICAgXSA6IFtdKSlcbiAgICAgIH1cblxuICAgICAgZm9yIChkYXkgPSAxOyBkYXkgPD0gZGF5c0luTW9udGg7IGRheSsrKSB7XG4gICAgICAgIGNvbnN0IGRhdGUgPSBgJHt0aGlzLmRpc3BsYXllZFllYXJ9LSR7cGFkKHRoaXMuZGlzcGxheWVkTW9udGggKyAxKX0tJHtwYWQoZGF5KX1gXG5cbiAgICAgICAgcm93cy5wdXNoKHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ3RkJywgW1xuICAgICAgICAgIHRoaXMuZ2VuQnV0dG9uKGRhdGUsIHRydWUsICdkYXRlJywgdGhpcy5mb3JtYXR0ZXIpLFxuICAgICAgICBdKSlcblxuICAgICAgICBpZiAocm93cy5sZW5ndGggJSBjZWxsc0luUm93ID09PSAwKSB7XG4gICAgICAgICAgY2hpbGRyZW4ucHVzaCh0aGlzLmdlblRSKHJvd3MpKVxuICAgICAgICAgIHJvd3MgPSBbXVxuICAgICAgICAgIGlmICh0aGlzLnNob3dXZWVrICYmIChkYXkgPCBkYXlzSW5Nb250aCB8fCB0aGlzLnNob3dBZGphY2VudE1vbnRocykpIHtcbiAgICAgICAgICAgIHJvd3MucHVzaCh0aGlzLmdlbldlZWtOdW1iZXIodGhpcy5nZXRXZWVrTnVtYmVyKGRheSArIDcpKSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29uc3QgbmV4dE1vbnRoWWVhciA9IHRoaXMuZGlzcGxheWVkTW9udGggPT09IDExID8gdGhpcy5kaXNwbGF5ZWRZZWFyICsgMSA6IHRoaXMuZGlzcGxheWVkWWVhclxuICAgICAgY29uc3QgbmV4dE1vbnRoID0gKHRoaXMuZGlzcGxheWVkTW9udGggKyAxKSAlIDEyXG4gICAgICBsZXQgbmV4dE1vbnRoRGF5ID0gMVxuXG4gICAgICB3aGlsZSAocm93cy5sZW5ndGggPCBjZWxsc0luUm93KSB7XG4gICAgICAgIGNvbnN0IGRhdGUgPSBgJHtuZXh0TW9udGhZZWFyfS0ke3BhZChuZXh0TW9udGggKyAxKX0tJHtwYWQobmV4dE1vbnRoRGF5KyspfWBcblxuICAgICAgICByb3dzLnB1c2godGhpcy4kY3JlYXRlRWxlbWVudCgndGQnLCB0aGlzLnNob3dBZGphY2VudE1vbnRocyA/IFtcbiAgICAgICAgICB0aGlzLmdlbkJ1dHRvbihkYXRlLCB0cnVlLCAnZGF0ZScsIHRoaXMuZm9ybWF0dGVyLCB0cnVlKSxcbiAgICAgICAgXSA6IFtdKSlcbiAgICAgIH1cblxuICAgICAgaWYgKHJvd3MubGVuZ3RoKSB7XG4gICAgICAgIGNoaWxkcmVuLnB1c2godGhpcy5nZW5UUihyb3dzKSlcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ3Rib2R5JywgY2hpbGRyZW4pXG4gICAgfSxcbiAgICBnZW5UUiAoY2hpbGRyZW46IFZOb2RlQ2hpbGRyZW4pIHtcbiAgICAgIHJldHVybiBbdGhpcy4kY3JlYXRlRWxlbWVudCgndHInLCBjaGlsZHJlbildXG4gICAgfSxcbiAgfSxcblxuICByZW5kZXIgKCk6IFZOb2RlIHtcbiAgICByZXR1cm4gdGhpcy5nZW5UYWJsZSgndi1kYXRlLXBpY2tlci10YWJsZSB2LWRhdGUtcGlja2VyLXRhYmxlLS1kYXRlJywgW1xuICAgICAgdGhpcy5nZW5USGVhZCgpLFxuICAgICAgdGhpcy5nZW5UQm9keSgpLFxuICAgIF0sIHRoaXMuY2FsY3VsYXRlVGFibGVEYXRlKVxuICB9LFxufSlcbiJdfQ==