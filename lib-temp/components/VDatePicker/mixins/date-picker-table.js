import '../VDatePickerTable.sass';
// Directives
import Touch from '../../../directives/touch';
// Mixins
import Colorable from '../../../mixins/colorable';
import Localable from '../../../mixins/localable';
import Themeable from '../../../mixins/themeable';
// Utils
import { createItemTypeNativeListeners, sanitizeDateString } from '../util';
import isDateAllowed from '../util/isDateAllowed';
import { mergeListeners } from '../../../util/mergeData';
import mixins from '../../../util/mixins';
import { throttle } from '../../../util/helpers';
export default mixins(Colorable, Localable, Themeable
/* @vue/component */
).extend({
    directives: { Touch },
    props: {
        allowedDates: Function,
        current: String,
        disabled: Boolean,
        format: Function,
        events: {
            type: [Array, Function, Object],
            default: () => null,
        },
        eventColor: {
            type: [Array, Function, Object, String],
            default: () => 'warning',
        },
        min: String,
        max: String,
        range: Boolean,
        readonly: Boolean,
        scrollable: Boolean,
        tableDate: {
            type: String,
            required: true,
        },
        value: [String, Array],
    },
    data: () => ({
        isReversing: false,
        wheelThrottle: null,
    }),
    computed: {
        computedTransition() {
            return (this.isReversing === !this.$vuetify.rtl) ? 'tab-reverse-transition' : 'tab-transition';
        },
        displayedMonth() {
            return Number(this.tableDate.split('-')[1]) - 1;
        },
        displayedYear() {
            return Number(this.tableDate.split('-')[0]);
        },
    },
    watch: {
        tableDate(newVal, oldVal) {
            this.isReversing = newVal < oldVal;
        },
    },
    mounted() {
        this.wheelThrottle = throttle(this.wheel, 250);
    },
    methods: {
        genButtonClasses(isAllowed, isFloating, isSelected, isCurrent, isFirst, isLast) {
            return {
                'v-size--default': !isFloating,
                'v-date-picker-table__current': isCurrent,
                'v-btn--active': isSelected,
                'v-btn--flat': !isAllowed || this.disabled,
                'v-btn--text': isSelected === isCurrent,
                'v-btn--rounded': isFloating,
                'v-btn--disabled': !isAllowed || this.disabled,
                'v-btn--outlined': isCurrent && !isSelected,
                'v-date-picker--first-in-range': isFirst,
                'v-date-picker--last-in-range': isLast,
                ...this.themeClasses,
            };
        },
        genButtonEvents(value, isAllowed, mouseEventType) {
            if (this.disabled)
                return undefined;
            return mergeListeners({
                click: () => {
                    if (isAllowed && !this.readonly)
                        this.$emit('input', value);
                },
            }, createItemTypeNativeListeners(this, `:${mouseEventType}`, value));
        },
        genButton(value, isFloating, mouseEventType, formatter, isOtherMonth = false) {
            const isAllowed = isDateAllowed(value, this.min, this.max, this.allowedDates);
            const isSelected = this.isSelected(value) && isAllowed;
            const isCurrent = value === this.current;
            const setColor = isSelected ? this.setBackgroundColor : this.setTextColor;
            const color = (isSelected || isCurrent) && (this.color || 'accent');
            let isFirst = false;
            let isLast = false;
            if (this.range && !!this.value && Array.isArray(this.value)) {
                isFirst = value === this.value[0];
                isLast = value === this.value[this.value.length - 1];
            }
            return this.$createElement('button', setColor(color, {
                staticClass: 'v-btn',
                class: this.genButtonClasses(isAllowed && !isOtherMonth, isFloating, isSelected, isCurrent, isFirst, isLast),
                attrs: {
                    type: 'button',
                },
                domProps: {
                    disabled: this.disabled || !isAllowed || isOtherMonth,
                },
                on: this.genButtonEvents(value, isAllowed, mouseEventType),
            }), [
                this.$createElement('div', {
                    staticClass: 'v-btn__content',
                }, [formatter(value)]),
                this.genEvents(value),
            ]);
        },
        getEventColors(date) {
            const arrayize = (v) => Array.isArray(v) ? v : [v];
            let eventData;
            let eventColors = [];
            if (Array.isArray(this.events)) {
                eventData = this.events.includes(date);
            }
            else if (this.events instanceof Function) {
                eventData = this.events(date) || false;
            }
            else if (this.events) {
                eventData = this.events[date] || false;
            }
            else {
                eventData = false;
            }
            if (!eventData) {
                return [];
            }
            else if (eventData !== true) {
                eventColors = arrayize(eventData);
            }
            else if (typeof this.eventColor === 'string') {
                eventColors = [this.eventColor];
            }
            else if (typeof this.eventColor === 'function') {
                eventColors = arrayize(this.eventColor(date));
            }
            else if (Array.isArray(this.eventColor)) {
                eventColors = this.eventColor;
            }
            else {
                eventColors = arrayize(this.eventColor[date]);
            }
            return eventColors.filter(v => v);
        },
        genEvents(date) {
            const eventColors = this.getEventColors(date);
            return eventColors.length ? this.$createElement('div', {
                staticClass: 'v-date-picker-table__events',
            }, eventColors.map(color => this.$createElement('div', this.setBackgroundColor(color)))) : null;
        },
        isValidScroll(value, calculateTableDate) {
            const tableDate = calculateTableDate(value);
            // tableDate is 'YYYY-MM' for DateTable and 'YYYY' for MonthTable
            const sanitizeType = tableDate.split('-').length === 1 ? 'year' : 'month';
            return (value < 0 && (this.min ? tableDate >= sanitizeDateString(this.min, sanitizeType) : true)) ||
                (value > 0 && (this.max ? tableDate <= sanitizeDateString(this.max, sanitizeType) : true));
        },
        wheel(e, calculateTableDate) {
            this.$emit('update:table-date', calculateTableDate(e.deltaY));
        },
        touch(value, calculateTableDate) {
            this.$emit('update:table-date', calculateTableDate(value));
        },
        genTable(staticClass, children, calculateTableDate) {
            const transition = this.$createElement('transition', {
                props: { name: this.computedTransition },
            }, [this.$createElement('table', { key: this.tableDate }, children)]);
            const touchDirective = {
                name: 'touch',
                value: {
                    left: (e) => (e.offsetX < -15) &&
                        (this.isValidScroll(1, calculateTableDate) && this.touch(1, calculateTableDate)),
                    right: (e) => (e.offsetX > 15) &&
                        (this.isValidScroll(-1, calculateTableDate) && this.touch(-1, calculateTableDate)),
                },
            };
            return this.$createElement('div', {
                staticClass,
                class: {
                    'v-date-picker-table--disabled': this.disabled,
                    ...this.themeClasses,
                },
                on: (!this.disabled && this.scrollable) ? {
                    wheel: (e) => {
                        e.preventDefault();
                        if (this.isValidScroll(e.deltaY, calculateTableDate)) {
                            this.wheelThrottle(e, calculateTableDate);
                        }
                    },
                } : undefined,
                directives: [touchDirective],
            }, [transition]);
        },
        isSelected(value) {
            if (Array.isArray(this.value)) {
                if (this.range && this.value.length === 2) {
                    const [from, to] = [...this.value].sort();
                    return from <= value && value <= to;
                }
                else {
                    return this.value.indexOf(value) !== -1;
                }
            }
            return value === this.value;
        },
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS1waWNrZXItdGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9WRGF0ZVBpY2tlci9taXhpbnMvZGF0ZS1waWNrZXItdGFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTywwQkFBMEIsQ0FBQTtBQUVqQyxhQUFhO0FBQ2IsT0FBTyxLQUFLLE1BQU0sMkJBQTJCLENBQUE7QUFFN0MsU0FBUztBQUNULE9BQU8sU0FBUyxNQUFNLDJCQUEyQixDQUFBO0FBQ2pELE9BQU8sU0FBUyxNQUFNLDJCQUEyQixDQUFBO0FBQ2pELE9BQU8sU0FBUyxNQUFNLDJCQUEyQixDQUFBO0FBRWpELFFBQVE7QUFDUixPQUFPLEVBQUUsNkJBQTZCLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxTQUFTLENBQUE7QUFDM0UsT0FBTyxhQUFhLE1BQU0sdUJBQXVCLENBQUE7QUFDakQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHlCQUF5QixDQUFBO0FBQ3hELE9BQU8sTUFBTSxNQUFNLHNCQUFzQixDQUFBO0FBQ3pDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQTtBQW1CaEQsZUFBZSxNQUFNLENBQ25CLFNBQVMsRUFDVCxTQUFTLEVBQ1QsU0FBUztBQUNYLG9CQUFvQjtDQUNuQixDQUFDLE1BQU0sQ0FBQztJQUNQLFVBQVUsRUFBRSxFQUFFLEtBQUssRUFBRTtJQUVyQixLQUFLLEVBQUU7UUFDTCxZQUFZLEVBQUUsUUFBZ0U7UUFDOUUsT0FBTyxFQUFFLE1BQU07UUFDZixRQUFRLEVBQUUsT0FBTztRQUNqQixNQUFNLEVBQUUsUUFBcUQ7UUFDN0QsTUFBTSxFQUFFO1lBQ04sSUFBSSxFQUFFLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUM7WUFDL0IsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUk7U0FDc0I7UUFDM0MsVUFBVSxFQUFFO1lBQ1YsSUFBSSxF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QUMsUUFBUSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3hDLEtBQUssRUFBRSxDQUFDLENBQWEsRUFBRSxFQUFFO3dCQUN2QixDQUFDLENBQUMsY0FBYyxFQUFFLENBQUE7d0JBQ2xCLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLGtCQUFrQixDQUFDLEVBQUU7NEJBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLEVBQUUsa0JBQWtCLENBQUMsQ0FBQTt5QkFBRTtvQkFDckcsQ0FBQztpQkFDRixDQUFDLENBQUMsQ0FBQyxTQUFTO2dCQUNiLFVBQVUsRUFBRSxDQUFDLGNBQWMsQ0FBQzthQUM3QixFQUFFLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQTtRQUNsQixDQUFDO1FBQ0QsVUFBVSxDQUFFLEtBQWE7WUFDdkIsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDN0IsSUFBSSxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtvQkFDekMsTUFBTSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFBO29CQUN6QyxPQUFPLElBQUksSUFBSSxLQUFLLElBQUksS0FBSyxJQUFJLEVBQUUsQ0FBQTtpQkFDcEM7cUJBQU07b0JBQ0wsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtpQkFDeEM7YUFDRjtZQUVELE9BQU8sS0FBSyxLQUFLLElBQUksQ0FBQyxLQUFLLENBQUE7UUFDN0IsQ0FBQztLQUNGO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICcuLi9WRGF0ZVBpY2tlclRhYmxlLnNhc3MnXG5cbi8vIERpcmVjdGl2ZXNcbmltcG9ydCBUb3VjaCBmcm9tICcuLi8uLi8uLi9kaXJlY3RpdmVzL3RvdWNoJ1xuXG4vLyBNaXhpbnNcbmltcG9ydCBDb2xvcmFibGUgZnJvbSAnLi4vLi4vLi4vbWl4aW5zL2NvbG9yYWJsZSdcbmltcG9ydCBMb2NhbGFibGUgZnJvbSAnLi4vLi4vLi4vbWl4aW5zL2xvY2FsYWJsZSdcbmltcG9ydCBUaGVtZWFibGUgZnJvbSAnLi4vLi4vLi4vbWl4aW5zL3RoZW1lYWJsZSdcblxuLy8gVXRpbHNcbmltcG9ydCB7IGNyZWF0ZUl0ZW1UeXBlTmF0aXZlTGlzdGVuZXJzLCBzYW5pdGl6ZURhdGVTdHJpbmcgfSBmcm9tICcuLi91dGlsJ1xuaW1wb3J0IGlzRGF0ZUFsbG93ZWQgZnJvbSAnLi4vdXRpbC9pc0RhdGVBbGxvd2VkJ1xuaW1wb3J0IHsgbWVyZ2VMaXN0ZW5lcnMgfSBmcm9tICcuLi8uLi8uLi91dGlsL21lcmdlRGF0YSdcbmltcG9ydCBtaXhpbnMgZnJvbSAnLi4vLi4vLi4vdXRpbC9taXhpbnMnXG5pbXBvcnQgeyB0aHJvdHRsZSB9IGZyb20gJy4uLy4uLy4uL3V0aWwvaGVscGVycydcblxuLy8gVHlwZXNcbmltcG9ydCB7XG4gIFByb3BUeXBlLFxuICBWTm9kZUNoaWxkcmVuLFxufSBmcm9tICd2dWUnXG5pbXBvcnQgeyBQcm9wVmFsaWRhdG9yIH0gZnJvbSAndnVlL3R5cGVzL29wdGlvbnMnXG5pbXBvcnQge1xuICBEYXRlUGlja2VyQWxsb3dlZERhdGVzRnVuY3Rpb24sXG4gIERhdGVQaWNrZXJFdmVudENvbG9ycyxcbiAgRGF0ZVBpY2tlckV2ZW50Q29sb3JWYWx1ZSxcbiAgRGF0ZVBpY2tlckV2ZW50cyxcbiAgRGF0ZVBpY2tlckZvcm1hdHRlcixcbiAgVG91Y2hXcmFwcGVyLFxufSBmcm9tICd2dWV0aWZ5L3R5cGVzJ1xuXG50eXBlIENhbGN1bGF0ZVRhYmxlRGF0ZUZ1bmN0aW9uID0gKHY6IG51bWJlcikgPT4gc3RyaW5nXG5cbmV4cG9ydCBkZWZhdWx0IG1peGlucyhcbiAgQ29sb3JhYmxlLFxuICBMb2NhbGFibGUsXG4gIFRoZW1lYWJsZVxuLyogQHZ1ZS9jb21wb25lbnQgKi9cbikuZXh0ZW5kKHtcbiAgZGlyZWN0aXZlczogeyBUb3VjaCB9LFxuXG4gIHByb3BzOiB7XG4gICAgYWxsb3dlZERhdGVzOiBGdW5jdGlvbiBhcyBQcm9wVHlwZTxEYXRlUGlja2VyQWxsb3dlZERhdGVzRnVuY3Rpb24gfCB1bmRlZmluZWQ+LFxuICAgIGN1cnJlbnQ6IFN0cmluZyxcbiAgICBkaXNhYmxlZDogQm9vbGVhbixcbiAgICBmb3JtYXQ6IEZ1bmN0aW9uIGFzIFByb3BUeXBlPERhdGVQaWNrZXJGb3JtYXR0ZXIgfCB1bmRlZmluZWQ+LFxuICAgIGV2ZW50czoge1xuICAgICAgdHlwZTogW0FycmF5LCBGdW5jdGlvbiwgT2JqZWN0XSxcbiAgICAgIGRlZmF1bHQ6ICgpID0+IG51bGwsXG4gICAgfSBhcyBQcm9wVmFsaWRhdG9yPERhdGVQaWNrZXJFdmVudHMgfCBudWxsPixcbiAgICBldmVudENvbG9yOiB7XG4gICAgICB0eXBlOiBbQXJyYXksIEZ1bmN0aW9uLCBPYmplY3QsIFN0cmluZ10sXG4gICAgICBkZWZhdWx0OiAoKSA9PiAnd2FybmluZycsXG4gICAgfSBhcyBQcm9wVmFsaWRhdG9yPERhdGVQaWNrZXJFdmVudENvbG9ycz4sXG4gICAgbWluOiBTdHJpbmcsXG4gICAgbWF4OiBTdHJpbmcsXG4gICAgcmFuZ2U6IEJvb2xlYW4sXG4gICAgcmVhZG9ubHk6IEJvb2xlYW4sXG4gICAgc2Nyb2xsYWJsZTogQm9vbGVhbixcbiAgICB0YWJsZURhdGU6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgIH0sXG4gICAgdmFsdWU6IFtTdHJpbmcsIEFycmF5XSBhcyBQcm9wVHlwZTxzdHJpbmcgfCBzdHJpbmdbXT4sXG4gIH0sXG5cbiAgZGF0YTogKCkgPT4gKHtcbiAgICBpc1JldmVyc2luZzogZmFsc2UsXG4gICAgd2hlZWxUaHJvdHRsZTogbnVsbCBhcyBhbnksXG4gIH0pLFxuXG4gIGNvbXB1dGVkOiB7XG4gICAgY29tcHV0ZWRUcmFuc2l0aW9uICgpOiBzdHJpbmcge1xuICAgICAgcmV0dXJuICh0aGlzLmlzUmV2ZXJzaW5nID09PSAhdGhpcy4kdnVldGlmeS5ydGwpID8gJ3RhYi1yZXZlcnNlLXRyYW5zaXRpb24nIDogJ3RhYi10cmFuc2l0aW9uJ1xuICAgIH0sXG4gICAgZGlzcGxheWVkTW9udGggKCk6IG51bWJlciB7XG4gICAgICByZXR1cm4gTnVtYmVyKHRoaXMudGFibGVEYXRlLnNwbGl0KCctJylbMV0pIC0gMVxuICAgIH0sXG4gICAgZGlzcGxheWVkWWVhciAoKTogbnVtYmVyIHtcbiAgICAgIHJldHVybiBOdW1iZXIodGhpcy50YWJsZURhdGUuc3BsaXQoJy0nKVswXSlcbiAgICB9LFxuICB9LFxuXG4gIHdhdGNoOiB7XG4gICAgdGFibGVEYXRlIChuZXdWYWw6IHN0cmluZywgb2xkVmFsOiBzdHJpbmcpIHtcbiAgICAgIHRoaXMuaXNSZXZlcnNpbmcgPSBuZXdWYWwgPCBvbGRWYWxcbiAgICB9LFxuICB9LFxuXG4gIG1vdW50ZWQgKCkge1xuICAgIHRoaXMud2hlZWxUaHJvdHRsZSA9IHRocm90dGxlKHRoaXMud2hlZWwsIDI1MClcbiAgfSxcblxuICBtZXRob2RzOiB7XG4gICAgZ2VuQnV0dG9uQ2xhc3NlcyAoXG4gICAgICBpc0FsbG93ZWQ6IGJvb2xlYW4sXG4gICAgICBpc0Zsb2F0aW5nOiBib29sZWFuLFxuICAgICAgaXNTZWxlY3RlZDogYm9vbGVhbixcbiAgICAgIGlzQ3VycmVudDogYm9vbGVhbixcbiAgICAgIGlzRmlyc3Q6IGJvb2xlYW4sXG4gICAgICBpc0xhc3Q6IGJvb2xlYW4sXG4gICAgKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAndi1zaXplLS1kZWZhdWx0JzogIWlzRmxvYXRpbmcsXG4gICAgICAgICd2LWRhdGUtcGlja2VyLXRhYmxlX19jdXJyZW50JzogaXNDdXJyZW50LFxuICAgICAgICAndi1idG4tLWFjdGl2ZSc6IGlzU2VsZWN0ZWQsXG4gICAgICAgICd2LWJ0bi0tZmxhdCc6ICFpc0FsbG93ZWQgfHwgdGhpcy5kaXNhYmxlZCxcbiAgICAgICAgJ3YtYnRuLS10ZXh0JzogaXNTZWxlY3RlZCA9PT0gaXNDdXJyZW50LFxuICAgICAgICAndi1idG4tLXJvdW5kZWQnOiBpc0Zsb2F0aW5nLFxuICAgICAgICAndi1idG4tLWRpc2FibGVkJzogIWlzQWxsb3dlZCB8fCB0aGlzLmRpc2FibGVkLFxuICAgICAgICAndi1idG4tLW91dGxpbmVkJzogaXNDdXJyZW50ICYmICFpc1NlbGVjdGVkLFxuICAgICAgICAndi1kYXRlLXBpY2tlci0tZmlyc3QtaW4tcmFuZ2UnOiBpc0ZpcnN0LFxuICAgICAgICAndi1kYXRlLXBpY2tlci0tbGFzdC1pbi1yYW5nZSc6IGlzTGFzdCxcbiAgICAgICAgLi4udGhpcy50aGVtZUNsYXNzZXMsXG4gICAgICB9XG4gICAgfSxcbiAgICBnZW5CdXR0b25FdmVudHMgKHZhbHVlOiBzdHJpbmcsIGlzQWxsb3dlZDogYm9vbGVhbiwgbW91c2VFdmVudFR5cGU6IHN0cmluZykge1xuICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHJldHVybiB1bmRlZmluZWRcblxuICAgICAgcmV0dXJuIG1lcmdlTGlzdGVuZXJzKHtcbiAgICAgICAgY2xpY2s6ICgpID0+IHtcbiAgICAgICAgICBpZiAoaXNBbGxvd2VkICYmICF0aGlzLnJlYWRvbmx5KSB0aGlzLiRlbWl0KCdpbnB1dCcsIHZhbHVlKVxuICAgICAgICB9LFxuICAgICAgfSwgY3JlYXRlSXRlbVR5cGVOYXRpdmVMaXN0ZW5lcnModGhpcywgYDoke21vdXNlRXZlbnRUeXBlfWAsIHZhbHVlKSlcbiAgICB9LFxuICAgIGdlbkJ1dHRvbiAodmFsdWU6IHN0cmluZywgaXNGbG9hdGluZzogYm9vbGVhbiwgbW91c2VFdmVudFR5cGU6IHN0cmluZywgZm9ybWF0dGVyOiBEYXRlUGlja2VyRm9ybWF0dGVyLCBpc090aGVyTW9udGggPSBmYWxzZSkge1xuICAgICAgY29uc3QgaXNBbGxvd2VkID0gaXNEYXRlQWxsb3dlZCh2YWx1ZSwgdGhpcy5taW4sIHRoaXMubWF4LCB0aGlzLmFsbG93ZWREYXRlcylcbiAgICAgIGNvbnN0IGlzU2VsZWN0ZWQgPSB0aGlzLmlzU2VsZWN0ZWQodmFsdWUpICYmIGlzQWxsb3dlZFxuICAgICAgY29uc3QgaXNDdXJyZW50ID0gdmFsdWUgPT09IHRoaXMuY3VycmVudFxuICAgICAgY29uc3Qgc2V0Q29sb3IgPSBpc1NlbGVjdGVkID8gdGhpcy5zZXRCYWNrZ3JvdW5kQ29sb3IgOiB0aGlzLnNldFRleHRDb2xvclxuICAgICAgY29uc3QgY29sb3IgPSAoaXNTZWxlY3RlZCB8fCBpc0N1cnJlbnQpICYmICh0aGlzLmNvbG9yIHx8ICdhY2NlbnQnKVxuICAgICAgbGV0IGlzRmlyc3QgPSBmYWxzZVxuICAgICAgbGV0IGlzTGFzdCA9IGZhbHNlXG4gICAgICBpZiAodGhpcy5yYW5nZSAmJiAhIXRoaXMudmFsdWUgJiYgQXJyYXkuaXNBcnJheSh0aGlzLnZhbHVlKSkge1xuICAgICAgICBpc0ZpcnN0ID0gdmFsdWUgPT09IHRoaXMudmFsdWVbMF1cbiAgICAgICAgaXNMYXN0ID0gdmFsdWUgPT09IHRoaXMudmFsdWVbdGhpcy52YWx1ZS5sZW5ndGggLSAxXVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy4kY3JlYXRlRWxlbWVudCgnYnV0dG9uJywgc2V0Q29sb3IoY29sb3IsIHtcbiAgICAgICAgc3RhdGljQ2xhc3M6ICd2LWJ0bicsXG4gICAgICAgIGNsYXNzOiB0aGlzLmdlbkJ1dHRvbkNsYXNzZXMoXG4gICAgICAgICAgaXNBbGxvd2VkICYmICFpc090aGVyTW9udGgsXG4gICAgICAgICAgaXNGbG9hdGluZyxcbiAgICAgICAgICBpc1NlbGVjdGVkLFxuICAgICAgICAgIGlzQ3VycmVudCxcbiAgICAgICAgICBpc0ZpcnN0LFxuICAgICAgICAgIGlzTGFzdCxcbiAgICAgICAgKSxcbiAgICAgICAgYXR0cnM6IHtcbiAgICAgICAgICB0eXBlOiAnYnV0dG9uJyxcbiAgICAgICAgfSxcbiAgICAgICAgZG9tUHJvcHM6IHtcbiAgICAgICAgICBkaXNhYmxlZDogdGhpcy5kaXNhYmxlZCB8fCAhaXNBbGxvd2VkIHx8IGlzT3RoZXJNb250aCxcbiAgICAgICAgfSxcbiAgICAgICAgb246IHRoaXMuZ2VuQnV0dG9uRXZlbnRzKHZhbHVlLCBpc0FsbG93ZWQsIG1vdXNlRXZlbnRUeXBlKSxcbiAgICAgIH0pLCBbXG4gICAgICAgIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ2RpdicsIHtcbiAgICAgICAgICBzdGF0aWNDbGFzczogJ3YtYnRuX19jb250ZW50JyxcbiAgICAgICAgfSwgW2Zvcm1hdHRlcih2YWx1ZSldKSxcbiAgICAgICAgdGhpcy5nZW5FdmVudHModmFsdWUpLFxuICAgICAgXSlcbiAgICB9LFxuICAgIGdldEV2ZW50Q29sb3JzIChkYXRlOiBzdHJpbmcpIHtcbiAgICAgIGNvbnN0IGFycmF5aXplID0gKHY6IHN0cmluZyB8IHN0cmluZ1tdKSA9PiBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XVxuICAgICAgbGV0IGV2ZW50RGF0YTogYm9vbGVhbiB8IERhdGVQaWNrZXJFdmVudENvbG9yVmFsdWVcbiAgICAgIGxldCBldmVudENvbG9yczogc3RyaW5nW10gPSBbXVxuXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmV2ZW50cykpIHtcbiAgICAgICAgZXZlbnREYXRhID0gdGhpcy5ldmVudHMuaW5jbHVkZXMoZGF0ZSlcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5ldmVudHMgaW5zdGFuY2VvZiBGdW5jdGlvbikge1xuICAgICAgICBldmVudERhdGEgPSB0aGlzLmV2ZW50cyhkYXRlKSB8fCBmYWxzZVxuICAgICAgfSBlbHNlIGlmICh0aGlzLmV2ZW50cykge1xuICAgICAgICBldmVudERhdGEgPSB0aGlzLmV2ZW50c1tkYXRlXSB8fCBmYWxzZVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZXZlbnREYXRhID0gZmFsc2VcbiAgICAgIH1cblxuICAgICAgaWYgKCFldmVudERhdGEpIHtcbiAgICAgICAgcmV0dXJuIFtdXG4gICAgICB9IGVsc2UgaWYgKGV2ZW50RGF0YSAhPT0gdHJ1ZSkge1xuICAgICAgICBldmVudENvbG9ycyA9IGFycmF5aXplKGV2ZW50RGF0YSlcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHRoaXMuZXZlbnRDb2xvciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgZXZlbnRDb2xvcnMgPSBbdGhpcy5ldmVudENvbG9yXVxuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdGhpcy5ldmVudENvbG9yID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGV2ZW50Q29sb3JzID0gYXJyYXlpemUodGhpcy5ldmVudENvbG9yKGRhdGUpKVxuICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHRoaXMuZXZlbnRDb2xvcikpIHtcbiAgICAgICAgZXZlbnRDb2xvcnMgPSB0aGlzLmV2ZW50Q29sb3JcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGV2ZW50Q29sb3JzID0gYXJyYXlpemUodGhpcy5ldmVudENvbG9yW2RhdGVdKVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gZXZlbnRDb2xvcnMuZmlsdGVyKHYgPT4gdilcbiAgICB9LFxuICAgIGdlbkV2ZW50cyAoZGF0ZTogc3RyaW5nKSB7XG4gICAgICBjb25zdCBldmVudENvbG9ycyA9IHRoaXMuZ2V0RXZlbnRDb2xvcnMoZGF0ZSlcblxuICAgICAgcmV0dXJuIGV2ZW50Q29sb3JzLmxlbmd0aCA/IHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ2RpdicsIHtcbiAgICAgICAgc3RhdGljQ2xhc3M6ICd2LWRhdGUtcGlja2VyLXRhYmxlX19ldmVudHMnLFxuICAgICAgfSwgZXZlbnRDb2xvcnMubWFwKGNvbG9yID0+IHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ2RpdicsIHRoaXMuc2V0QmFja2dyb3VuZENvbG9yKGNvbG9yKSkpKSA6IG51bGxcbiAgICB9LFxuICAgIGlzVmFsaWRTY3JvbGwgKHZhbHVlOiBudW1iZXIsIGNhbGN1bGF0ZVRhYmxlRGF0ZTogQ2FsY3VsYXRlVGFibGVEYXRlRnVuY3Rpb24pIHtcbiAgICAgIGNvbnN0IHRhYmxlRGF0ZSA9IGNhbGN1bGF0ZVRhYmxlRGF0ZSh2YWx1ZSlcbiAgICAgIC8vIHRhYmxlRGF0ZSBpcyAnWVlZWS1NTScgZm9yIERhdGVUYWJsZSBhbmQgJ1lZWVknIGZvciBNb250aFRhYmxlXG4gICAgICBjb25zdCBzYW5pdGl6ZVR5cGUgPSB0YWJsZURhdGUuc3BsaXQoJy0nKS5sZW5ndGggPT09IDEgPyAneWVhcicgOiAnbW9udGgnXG4gICAgICByZXR1cm4gKHZhbHVlIDwgMCAmJiAodGhpcy5taW4gPyB0YWJsZURhdGUgPj0gc2FuaXRpemVEYXRlU3RyaW5nKHRoaXMubWluLCBzYW5pdGl6ZVR5cGUpIDogdHJ1ZSkpIHx8XG4gICAgICAgICh2YWx1ZSA+IDAgJiYgKHRoaXMubWF4ID8gdGFibGVEYXRlIDw9IHNhbml0aXplRGF0ZVN0cmluZyh0aGlzLm1heCwgc2FuaXRpemVUeXBlKSA6IHRydWUpKVxuICAgIH0sXG4gICAgd2hlZWwgKGU6IFdoZWVsRXZlbnQsIGNhbGN1bGF0ZVRhYmxlRGF0ZTogQ2FsY3VsYXRlVGFibGVEYXRlRnVuY3Rpb24pIHtcbiAgICAgIHRoaXMuJGVtaXQoJ3VwZGF0ZTp0YWJsZS1kYXRlJywgY2FsY3VsYXRlVGFibGVEYXRlKGUuZGVsdGFZKSlcbiAgICB9LFxuICAgIHRvdWNoICh2YWx1ZTogbnVtYmVyLCBjYWxjdWxhdGVUYWJsZURhdGU6IENhbGN1bGF0ZVRhYmxlRGF0ZUZ1bmN0aW9uKSB7XG4gICAgICB0aGlzLiRlbWl0KCd1cGRhdGU6dGFibGUtZGF0ZScsIGNhbGN1bGF0ZVRhYmxlRGF0ZSh2YWx1ZSkpXG4gICAgfSxcbiAgICBnZW5UYWJsZSAoc3RhdGljQ2xhc3M6IHN0cmluZywgY2hpbGRyZW46IFZOb2RlQ2hpbGRyZW4sIGNhbGN1bGF0ZVRhYmxlRGF0ZTogQ2FsY3VsYXRlVGFibGVEYXRlRnVuY3Rpb24pIHtcbiAgICAgIGNvbnN0IHRyYW5zaXRpb24gPSB0aGlzLiRjcmVhdGVFbGVtZW50KCd0cmFuc2l0aW9uJywge1xuICAgICAgICBwcm9wczogeyBuYW1lOiB0aGlzLmNvbXB1dGVkVHJhbnNpdGlvbiB9LFxuICAgICAgfSwgW3RoaXMuJGNyZWF0ZUVsZW1lbnQoJ3RhYmxlJywgeyBrZXk6IHRoaXMudGFibGVEYXRlIH0sIGNoaWxkcmVuKV0pXG5cbiAgICAgIGNvbnN0IHRvdWNoRGlyZWN0aXZlID0ge1xuICAgICAgICBuYW1lOiAndG91Y2gnLFxuICAgICAgICB2YWx1ZToge1xuICAgICAgICAgIGxlZnQ6IChlOiBUb3VjaFdyYXBwZXIpID0+IChlLm9mZnNldFggPCAtMTUpICYmXG4gICAgICAgICAgICAodGhpcy5pc1ZhbGlkU2Nyb2xsKDEsIGNhbGN1bGF0ZVRhYmxlRGF0ZSkgJiYgdGhpcy50b3VjaCgxLCBjYWxjdWxhdGVUYWJsZURhdGUpKSxcbiAgICAgICAgICByaWdodDogKGU6IFRvdWNoV3JhcHBlcikgPT4gKGUub2Zmc2V0WCA+IDE1KSAmJlxuICAgICAgICAgICAgKHRoaXMuaXNWYWxpZFNjcm9sbCgtMSwgY2FsY3VsYXRlVGFibGVEYXRlKSAmJiB0aGlzLnRvdWNoKC0xLCBjYWxjdWxhdGVUYWJsZURhdGUpKSxcbiAgICAgICAgfSxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ2RpdicsIHtcbiAgICAgICAgc3RhdGljQ2xhc3MsXG4gICAgICAgIGNsYXNzOiB7XG4gICAgICAgICAgJ3YtZGF0ZS1waWNrZXItdGFibGUtLWRpc2FibGVkJzogdGhpcy5kaXNhYmxlZCxcbiAgICAgICAgICAuLi50aGlzLnRoZW1lQ2xhc3NlcyxcbiAgICAgICAgfSxcbiAgICAgICAgb246ICghdGhpcy5kaXNhYmxlZCAmJiB0aGlzLnNjcm9sbGFibGUpID8ge1xuICAgICAgICAgIHdoZWVsOiAoZTogV2hlZWxFdmVudCkgPT4ge1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpXG4gICAgICAgICAgICBpZiAodGhpcy5pc1ZhbGlkU2Nyb2xsKGUuZGVsdGFZLCBjYWxjdWxhdGVUYWJsZURhdGUpKSB7IHRoaXMud2hlZWxUaHJvdHRsZShlLCBjYWxjdWxhdGVUYWJsZURhdGUpIH1cbiAgICAgICAgICB9LFxuICAgICAgICB9IDogdW5kZWZpbmVkLFxuICAgICAgICBkaXJlY3RpdmVzOiBbdG91Y2hEaXJlY3RpdmVdLFxuICAgICAgfSwgW3RyYW5zaXRpb25dKVxuICAgIH0sXG4gICAgaXNTZWxlY3RlZCAodmFsdWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy52YWx1ZSkpIHtcbiAgICAgICAgaWYgKHRoaXMucmFuZ2UgJiYgdGhpcy52YWx1ZS5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICBjb25zdCBbZnJvbSwgdG9dID0gWy4uLnRoaXMudmFsdWVdLnNvcnQoKVxuICAgICAgICAgIHJldHVybiBmcm9tIDw9IHZhbHVlICYmIHZhbHVlIDw9IHRvXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMudmFsdWUuaW5kZXhPZih2YWx1ZSkgIT09IC0xXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHZhbHVlID09PSB0aGlzLnZhbHVlXG4gICAgfSxcbiAgfSxcbn0pXG4iXX0=