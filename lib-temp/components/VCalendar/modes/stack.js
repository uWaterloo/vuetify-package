import { getOverlapGroupHandler, getVisuals, hasOverlap, getNormalizedRange } from './common';
import { getTimestampIdentifier } from '../util/timestamp';
const FULL_WIDTH = 100;
const DEFAULT_OFFSET = 5;
const WIDTH_MULTIPLIER = 1.7;
/**
 * Variation of column mode where events can be stacked. The priority of this
 * mode is to stack events together taking up the least amount of space while
 * trying to ensure the content of the event is always visible as well as its
 * start and end. A sibling column has intersecting event content and must be
 * placed beside each other. Non-sibling columns are offset by 5% from the
 * previous column. The width is scaled by 1.7 so the events overlap and
 * whitespace is reduced. If there is a hole in columns the event width is
 * scaled up so it intersects with the next column. The columns have equal
 * width in the space they are given. If the event doesn't have any to the
 * right of it that intersect with it's content it's right side is extended
 * to the right side.
 */
export const stack = (events, firstWeekday, overlapThreshold) => {
    const handler = getOverlapGroupHandler(firstWeekday);
    // eslint-disable-next-line max-statements
    return (day, dayEvents, timed, reset) => {
        if (!timed) {
            return handler.getVisuals(day, dayEvents, timed, reset);
        }
        const dayStart = getTimestampIdentifier(day);
        const visuals = getVisuals(dayEvents, dayStart);
        const groups = getGroups(visuals, dayStart);
        for (const group of groups) {
            const nodes = [];
            for (const visual of group.visuals) {
                const child = getNode(visual, dayStart);
                const index = getNextIndex(child, nodes);
                if (index === false) {
                    const parent = getParent(child, nodes);
                    if (parent) {
                        child.parent = parent;
                        child.sibling = hasOverlap(child.start, child.end, parent.start, addTime(parent.start, overlapThreshold));
                        child.index = parent.index + 1;
                        parent.children.push(child);
                    }
                }
                else {
                    const [parent] = getOverlappingRange(child, nodes, index - 1, index - 1);
                    const children = getOverlappingRange(child, nodes, index + 1, index + nodes.length, true);
                    child.children = children;
                    child.index = index;
                    if (parent) {
                        child.parent = parent;
                        child.sibling = hasOverlap(child.start, child.end, parent.start, addTime(parent.start, overlapThreshold));
                        parent.children.push(child);
                    }
                    for (const grand of children) {
                        if (grand.parent === parent) {
                            grand.parent = child;
                        }
                        const grandNext = grand.index - child.index <= 1;
                        if (grandNext && child.sibling &&
                            hasOverlap(child.start, addTime(child.start, overlapThreshold), grand.start, grand.end)) {
                            grand.sibling = true;
                        }
                    }
                }
                nodes.push(child);
            }
            calculateBounds(nodes, overlapThreshold);
        }
        visuals.sort((a, b) => (a.left - b.left) || (a.event.startTimestampIdentifier - b.event.startTimestampIdentifier));
        return visuals;
    };
};
function calculateBounds(nodes, overlapThreshold) {
    for (const node of nodes) {
        const { visual, parent } = node;
        const columns = getMaxChildIndex(node) + 1;
        const spaceLeft = parent ? parent.visual.left : 0;
        const spaceWidth = FULL_WIDTH - spaceLeft;
        const offset = Math.min(DEFAULT_OFFSET, FULL_WIDTH / columns);
        const columnWidthMultiplier = getColumnWidthMultiplier(node, nodes);
        const columnOffset = spaceWidth / (columns - node.index + 1);
        const columnWidth = spaceWidth / (columns - node.index + (node.sibling ? 1 : 0)) * columnWidthMultiplier;
        if (parent) {
            visual.left = node.sibling
                ? spaceLeft + columnOffset
                : spaceLeft + offset;
        }
        visual.width = hasFullWidth(node, nodes, overlapThreshold)
            ? FULL_WIDTH - visual.left
            : Math.min(FULL_WIDTH - visual.left, columnWidth * WIDTH_MULTIPLIER);
    }
}
function getColumnWidthMultiplier(node, nodes) {
    if (!node.children.length) {
        return 1;
    }
    const maxColumn = node.index + nodes.length;
    const minColumn = node.children.reduce((min, c) => Math.min(min, c.index), maxColumn);
    return minColumn - node.index;
}
function getOverlappingIndices(node, nodes) {
    const indices = [];
    for (const other of nodes) {
        if (hasOverlap(node.start, node.end, other.start, other.end)) {
            indices.push(other.index);
        }
    }
    return indices;
}
function getNextIndex(node, nodes) {
    const indices = getOverlappingIndices(node, nodes);
    indices.sort();
    for (let i = 0; i < indices.length; i++) {
        if (i < indices[i]) {
            return i;
        }
    }
    return false;
}
function getOverlappingRange(node, nodes, indexMin, indexMax, returnFirstColumn = false) {
    const overlapping = [];
    for (const other of nodes) {
        if (other.index >= indexMin && other.index <= indexMax && hasOverlap(node.start, node.end, other.start, other.end)) {
            overlapping.push(other);
        }
    }
    if (returnFirstColumn && overlapping.length > 0) {
        const first = overlapping.reduce((min, n) => Math.min(min, n.index), overlapping[0].index);
        return overlapping.filter(n => n.index === first);
    }
    return overlapping;
}
function getParent(node, nodes) {
    let parent = null;
    for (const other of nodes) {
        if (hasOverlap(node.start, node.end, other.start, other.end) && (parent === null || other.index > parent.index)) {
            parent = other;
        }
    }
    return parent;
}
function hasFullWidth(node, nodes, overlapThreshold) {
    for (const other of nodes) {
        if (other !== node &&
            other.index > node.index &&
            hasOverlap(node.start, addTime(node.start, overlapThreshold), other.start, other.end)) {
            return false;
        }
    }
    return true;
}
function getGroups(visuals, dayStart) {
    const groups = [];
    for (const visual of visuals) {
        const [start, end] = getNormalizedRange(visual.event, dayStart);
        let added = false;
        for (const group of groups) {
            if (hasOverlap(start, end, group.start, group.end)) {
                group.visuals.push(visual);
                group.end = Math.max(group.end, end);
                added = true;
                break;
            }
        }
        if (!added) {
            groups.push({ start, end, visuals: [visual] });
        }
    }
    return groups;
}
function getNode(visual, dayStart) {
    const [start, end] = getNormalizedRange(visual.event, dayStart);
    return {
        parent: null,
        sibling: true,
        index: 0,
        visual,
        start,
        end,
        children: [],
    };
}
function getMaxChildIndex(node) {
    let max = node.index;
    for (const child of node.children) {
        const childMax = getMaxChildIndex(child);
        if (childMax > max) {
            max = childMax;
        }
    }
    return max;
}
function addTime(identifier, minutes) {
    const removeMinutes = identifier % 100;
    const totalMinutes = removeMinutes + minutes;
    const addHours = Math.floor(totalMinutes / 60);
    const addMinutes = totalMinutes % 60;
    return identifier - removeMinutes + addHours * 100 + addMinutes;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9WQ2FsZW5kYXIvbW9kZXMvc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLHNCQUFzQixFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxVQUFVLENBQUE7QUFDN0YsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sbUJBQW1CLENBQUE7QUFrQjFELE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQTtBQUV0QixNQUFNLGNBQWMsR0FBRyxDQUFDLENBQUE7QUFFeEIsTUFBTSxnQkFBZ0IsR0FBRyxHQUFHLENBQUE7QUFFNUI7Ozs7Ozs7Ozs7OztHQVlHO0FBRUgsTUFBTSxDQUFDLE1BQU0sS0FBSyxHQUE2QixDQUFDLE1BQU0sRUFBRSxZQUFZLEVBQUUsZ0JBQWdCLEVBQUUsRUFBRTtJQUN4RixNQUFNLE9BQU8sR0FBRyxzQkFBc0IsQ0FBQyxZQUFZLENBQUMsQ0FBQTtJQUVwRCwwQ0FBMEM7SUFDMUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFO1FBQ3RDLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDVixPQUFPLE9BQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUE7U0FDeEQ7UUFFRCxNQUFNLFFBQVEsR0FBRyxzQkFBc0IsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUM1QyxNQUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFBO1FBQy9DLE1BQU0sTUFBTSxHQUFHLFNBQVMsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUE7UUFFM0MsS0FBSyxNQUFNLEtBQUssSUFBSSxNQUFNLEVBQUU7WUFDMUIsTUFBTSxLQUFLLEdBQVcsRUFBRSxDQUFB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QVU7SUFDbkMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQTtJQUNwQixLQUFLLE1BQU0sS0FBSyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7UUFDakMsTUFBTSxRQUFRLEdBQUcsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDeEMsSUFBSSxRQUFRLEdBQUcsR0FBRyxFQUFFO1lBQ2xCLEdBQUcsR0FBRyxRQUFRLENBQUE7U0FDZjtLQUNGO0lBQ0QsT0FBTyxHQUFHLENBQUE7QUFDWixDQUFDO0FBRUQsU0FBUyxPQUFPLENBQUUsVUFBa0IsRUFBRSxPQUFlO0lBQ25ELE1BQU0sYUFBYSxHQUFHLFVBQVUsR0FBRyxHQUFHLENBQUE7SUFDdEMsTUFBTSxZQUFZLEdBQUcsYUFBYSxHQUFHLE9BQU8sQ0FBQTtJQUM1QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUMsQ0FBQTtJQUM5QyxNQUFNLFVBQVUsR0FBRyxZQUFZLEdBQUcsRUFBRSxDQUFBO0lBRXBDLE9BQU8sVUFBVSxHQUFHLGFBQWEsR0FBRyxRQUFRLEdBQUcsR0FBRyxHQUFHLFVBQVUsQ0FBQTtBQUNqRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2FsZW5kYXJFdmVudE92ZXJsYXBNb2RlLCBDYWxlbmRhckV2ZW50VmlzdWFsIH0gZnJvbSAndnVldGlmeS90eXBlcydcbmltcG9ydCB7IGdldE92ZXJsYXBHcm91cEhhbmRsZXIsIGdldFZpc3VhbHMsIGhhc092ZXJsYXAsIGdldE5vcm1hbGl6ZWRSYW5nZSB9IGZyb20gJy4vY29tbW9uJ1xuaW1wb3J0IHsgZ2V0VGltZXN0YW1wSWRlbnRpZmllciB9IGZyb20gJy4uL3V0aWwvdGltZXN0YW1wJ1xuXG5pbnRlcmZhY2UgR3JvdXAge1xuICBzdGFydDogbnVtYmVyXG4gIGVuZDogbnVtYmVyXG4gIHZpc3VhbHM6IENhbGVuZGFyRXZlbnRWaXN1YWxbXVxufVxuXG5pbnRlcmZhY2UgTm9kZSB7XG4gIHBhcmVudDogTm9kZSB8IG51bGxcbiAgc2libGluZzogYm9vbGVhblxuICBpbmRleDogbnVtYmVyXG4gIHZpc3VhbDogQ2FsZW5kYXJFdmVudFZpc3VhbFxuICBzdGFydDogbnVtYmVyXG4gIGVuZDogbnVtYmVyXG4gIGNoaWxkcmVuOiBOb2RlW11cbn1cblxuY29uc3QgRlVMTF9XSURUSCA9IDEwMFxuXG5jb25zdCBERUZBVUxUX09GRlNFVCA9IDVcblxuY29uc3QgV0lEVEhfTVVMVElQTElFUiA9IDEuN1xuXG4vKipcbiAqIFZhcmlhdGlvbiBvZiBjb2x1bW4gbW9kZSB3aGVyZSBldmVudHMgY2FuIGJlIHN0YWNrZWQuIFRoZSBwcmlvcml0eSBvZiB0aGlzXG4gKiBtb2RlIGlzIHRvIHN0YWNrIGV2ZW50cyB0b2dldGhlciB0YWtpbmcgdXAgdGhlIGxlYXN0IGFtb3VudCBvZiBzcGFjZSB3aGlsZVxuICogdHJ5aW5nIHRvIGVuc3VyZSB0aGUgY29udGVudCBvZiB0aGUgZXZlbnQgaXMgYWx3YXlzIHZpc2libGUgYXMgd2VsbCBhcyBpdHNcbiAqIHN0YXJ0IGFuZCBlbmQuIEEgc2libGluZyBjb2x1bW4gaGFzIGludGVyc2VjdGluZyBldmVudCBjb250ZW50IGFuZCBtdXN0IGJlXG4gKiBwbGFjZWQgYmVzaWRlIGVhY2ggb3RoZXIuIE5vbi1zaWJsaW5nIGNvbHVtbnMgYXJlIG9mZnNldCBieSA1JSBmcm9tIHRoZVxuICogcHJldmlvdXMgY29sdW1uLiBUaGUgd2lkdGggaXMgc2NhbGVkIGJ5IDEuNyBzbyB0aGUgZXZlbnRzIG92ZXJsYXAgYW5kXG4gKiB3aGl0ZXNwYWNlIGlzIHJlZHVjZWQuIElmIHRoZXJlIGlzIGEgaG9sZSBpbiBjb2x1bW5zIHRoZSBldmVudCB3aWR0aCBpc1xuICogc2NhbGVkIHVwIHNvIGl0IGludGVyc2VjdHMgd2l0aCB0aGUgbmV4dCBjb2x1bW4uIFRoZSBjb2x1bW5zIGhhdmUgZXF1YWxcbiAqIHdpZHRoIGluIHRoZSBzcGFjZSB0aGV5IGFyZSBnaXZlbi4gSWYgdGhlIGV2ZW50IGRvZXNuJ3QgaGF2ZSBhbnkgdG8gdGhlXG4gKiByaWdodCBvZiBpdCB0aGF0IGludGVyc2VjdCB3aXRoIGl0J3MgY29udGVudCBpdCdzIHJpZ2h0IHNpZGUgaXMgZXh0ZW5kZWRcbiAqIHRvIHRoZSByaWdodCBzaWRlLlxuICovXG5cbmV4cG9ydCBjb25zdCBzdGFjazogQ2FsZW5kYXJFdmVudE92ZXJsYXBNb2RlID0gKGV2ZW50cywgZmlyc3RXZWVrZGF5LCBvdmVybGFwVGhyZXNob2xkKSA9PiB7XG4gIGNvbnN0IGhhbmRsZXIgPSBnZXRPdmVybGFwR3JvdXBIYW5kbGVyKGZpcnN0V2Vla2RheSlcblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LXN0YXRlbWVudHNcbiAgcmV0dXJuIChkYXksIGRheUV2ZW50cywgdGltZWQsIHJlc2V0KSA9PiB7XG4gICAgaWYgKCF0aW1lZCkge1xuICAgICAgcmV0dXJuIGhhbmRsZXIuZ2V0VmlzdWFscyhkYXksIGRheUV2ZW50cywgdGltZWQsIHJlc2V0KVxuICAgIH1cblxuICAgIGNvbnN0IGRheVN0YXJ0ID0gZ2V0VGltZXN0YW1wSWRlbnRpZmllcihkYXkpXG4gICAgY29uc3QgdmlzdWFscyA9IGdldFZpc3VhbHMoZGF5RXZlbnRzLCBkYXlTdGFydClcbiAgICBjb25zdCBncm91cHMgPSBnZXRHcm91cHModmlzdWFscywgZGF5U3RhcnQpXG5cbiAgICBmb3IgKGNvbnN0IGdyb3VwIG9mIGdyb3Vwcykge1xuICAgICAgY29uc3Qgbm9kZXM6IE5vZGVbXSA9IFtdXG5cbiAgICAgIGZvciAoY29uc3QgdmlzdWFsIG9mIGdyb3VwLnZpc3VhbHMpIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBnZXROb2RlKHZpc3VhbCwgZGF5U3RhcnQpXG4gICAgICAgIGNvbnN0IGluZGV4ID0gZ2V0TmV4dEluZGV4KGNoaWxkLCBub2RlcylcblxuICAgICAgICBpZiAoaW5kZXggPT09IGZhbHNlKSB7XG4gICAgICAgICAgY29uc3QgcGFyZW50ID0gZ2V0UGFyZW50KGNoaWxkLCBub2RlcylcbiAgICAgICAgICBpZiAocGFyZW50KSB7XG4gICAgICAgICAgICBjaGlsZC5wYXJlbnQgPSBwYXJlbnRcbiAgICAgICAgICAgIGNoaWxkLnNpYmxpbmcgPSBoYXNPdmVybGFwKGNoaWxkLnN0YXJ0LCBjaGlsZC5lbmQsIHBhcmVudC5zdGFydCwgYWRkVGltZShwYXJlbnQuc3RhcnQsIG92ZXJsYXBUaHJlc2hvbGQpKVxuICAgICAgICAgICAgY2hpbGQuaW5kZXggPSBwYXJlbnQuaW5kZXggKyAxXG4gICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChjaGlsZClcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgW3BhcmVudF0gPSBnZXRPdmVybGFwcGluZ1JhbmdlKGNoaWxkLCBub2RlcywgaW5kZXggLSAxLCBpbmRleCAtIDEpXG4gICAgICAgICAgY29uc3QgY2hpbGRyZW4gPSBnZXRPdmVybGFwcGluZ1JhbmdlKGNoaWxkLCBub2RlcywgaW5kZXggKyAxLCBpbmRleCArIG5vZGVzLmxlbmd0aCwgdHJ1ZSlcblxuICAgICAgICAgIGNoaWxkLmNoaWxkcmVuID0gY2hpbGRyZW5cbiAgICAgICAgICBjaGlsZC5pbmRleCA9IGluZGV4XG5cbiAgICAgICAgICBpZiAocGFyZW50KSB7XG4gICAgICAgICAgICBjaGlsZC5wYXJlbnQgPSBwYXJlbnRcbiAgICAgICAgICAgIGNoaWxkLnNpYmxpbmcgPSBoYXNPdmVybGFwKGNoaWxkLnN0YXJ0LCBjaGlsZC5lbmQsIHBhcmVudC5zdGFydCwgYWRkVGltZShwYXJlbnQuc3RhcnQsIG92ZXJsYXBUaHJlc2hvbGQpKVxuICAgICAgICAgICAgcGFyZW50LmNoaWxkcmVuLnB1c2goY2hpbGQpXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZm9yIChjb25zdCBncmFuZCBvZiBjaGlsZHJlbikge1xuICAgICAgICAgICAgaWYgKGdyYW5kLnBhcmVudCA9PT0gcGFyZW50KSB7XG4gICAgICAgICAgICAgIGdyYW5kLnBhcmVudCA9IGNoaWxkXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGdyYW5kTmV4dCA9IGdyYW5kLmluZGV4IC0gY2hpbGQuaW5kZXggPD0gMVxuICAgICAgICAgICAgaWYgKGdyYW5kTmV4dCAmJiBjaGlsZC5zaWJsaW5nICYmXG4gICAgICAgICAgICAgIGhhc092ZXJsYXAoY2hpbGQuc3RhcnQsIGFkZFRpbWUoY2hpbGQuc3RhcnQsIG92ZXJsYXBUaHJlc2hvbGQpLCBncmFuZC5zdGFydCwgZ3JhbmQuZW5kKSkge1xuICAgICAgICAgICAgICBncmFuZC5zaWJsaW5nID0gdHJ1ZVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIG5vZGVzLnB1c2goY2hpbGQpXG4gICAgICB9XG5cbiAgICAgIGNhbGN1bGF0ZUJvdW5kcyhub2Rlcywgb3ZlcmxhcFRocmVzaG9sZClcbiAgICB9XG5cbiAgICB2aXN1YWxzLnNvcnQoKGEsIGIpID0+IChhLmxlZnQgLSBiLmxlZnQpIHx8IChhLmV2ZW50LnN0YXJ0VGltZXN0YW1wSWRlbnRpZmllciAtIGIuZXZlbnQuc3RhcnRUaW1lc3RhbXBJZGVudGlmaWVyKSlcblxuICAgIHJldHVybiB2aXN1YWxzXG4gIH1cbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlQm91bmRzIChub2RlczogTm9kZVtdLCBvdmVybGFwVGhyZXNob2xkOiBudW1iZXIpIHtcbiAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSB7XG4gICAgY29uc3QgeyB2aXN1YWwsIHBhcmVudCB9ID0gbm9kZVxuICAgIGNvbnN0IGNvbHVtbnMgPSBnZXRNYXhDaGlsZEluZGV4KG5vZGUpICsgMVxuICAgIGNvbnN0IHNwYWNlTGVmdCA9IHBhcmVudCA/IHBhcmVudC52aXN1YWwubGVmdCA6IDBcbiAgICBjb25zdCBzcGFjZVdpZHRoID0gRlVMTF9XSURUSCAtIHNwYWNlTGVmdFxuICAgIGNvbnN0IG9mZnNldCA9IE1hdGgubWluKERFRkFVTFRfT0ZGU0VULCBGVUxMX1dJRFRIIC8gY29sdW1ucylcbiAgICBjb25zdCBjb2x1bW5XaWR0aE11bHRpcGxpZXIgPSBnZXRDb2x1bW5XaWR0aE11bHRpcGxpZXIobm9kZSwgbm9kZXMpXG4gICAgY29uc3QgY29sdW1uT2Zmc2V0ID0gc3BhY2VXaWR0aCAvIChjb2x1bW5zIC0gbm9kZS5pbmRleCArIDEpXG4gICAgY29uc3QgY29sdW1uV2lkdGggPSBzcGFjZVdpZHRoIC8gKGNvbHVtbnMgLSBub2RlLmluZGV4ICsgKG5vZGUuc2libGluZyA/IDEgOiAwKSkgKiBjb2x1bW5XaWR0aE11bHRpcGxpZXJcblxuICAgIGlmIChwYXJlbnQpIHtcbiAgICAgIHZpc3VhbC5sZWZ0ID0gbm9kZS5zaWJsaW5nXG4gICAgICAgID8gc3BhY2VMZWZ0ICsgY29sdW1uT2Zmc2V0XG4gICAgICAgIDogc3BhY2VMZWZ0ICsgb2Zmc2V0XG4gICAgfVxuXG4gICAgdmlzdWFsLndpZHRoID0gaGFzRnVsbFdpZHRoKG5vZGUsIG5vZGVzLCBvdmVybGFwVGhyZXNob2xkKVxuICAgICAgPyBGVUxMX1dJRFRIIC0gdmlzdWFsLmxlZnRcbiAgICAgIDogTWF0aC5taW4oRlVMTF9XSURUSCAtIHZpc3VhbC5sZWZ0LCBjb2x1bW5XaWR0aCAqIFdJRFRIX01VTFRJUExJRVIpXG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0Q29sdW1uV2lkdGhNdWx0aXBsaWVyIChub2RlOiBOb2RlLCBub2RlczogTm9kZVtdKTogbnVtYmVyIHtcbiAgaWYgKCFub2RlLmNoaWxkcmVuLmxlbmd0aCkge1xuICAgIHJldHVybiAxXG4gIH1cblxuICBjb25zdCBtYXhDb2x1bW4gPSBub2RlLmluZGV4ICsgbm9kZXMubGVuZ3RoXG4gIGNvbnN0IG1pbkNvbHVtbiA9IG5vZGUuY2hpbGRyZW4ucmVkdWNlKChtaW4sIGMpID0+IE1hdGgubWluKG1pbiwgYy5pbmRleCksIG1heENvbHVtbilcblxuICByZXR1cm4gbWluQ29sdW1uIC0gbm9kZS5pbmRleFxufVxuXG5mdW5jdGlvbiBnZXRPdmVybGFwcGluZ0luZGljZXMgKG5vZGU6IE5vZGUsIG5vZGVzOiBOb2RlW10pOiBudW1iZXJbXSB7XG4gIGNvbnN0IGluZGljZXM6IG51bWJlcltdID0gW11cbiAgZm9yIChjb25zdCBvdGhlciBvZiBub2Rlcykge1xuICAgIGlmIChoYXNPdmVybGFwKG5vZGUuc3RhcnQsIG5vZGUuZW5kLCBvdGhlci5zdGFydCwgb3RoZXIuZW5kKSkge1xuICAgICAgaW5kaWNlcy5wdXNoKG90aGVyLmluZGV4KVxuICAgIH1cbiAgfVxuICByZXR1cm4gaW5kaWNlc1xufVxuXG5mdW5jdGlvbiBnZXROZXh0SW5kZXggKG5vZGU6IE5vZGUsIG5vZGVzOiBOb2RlW10pOiBudW1iZXIgfCBmYWxzZSB7XG4gIGNvbnN0IGluZGljZXMgPSBnZXRPdmVybGFwcGluZ0luZGljZXMobm9kZSwgbm9kZXMpXG4gIGluZGljZXMuc29ydCgpXG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRpY2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgaWYgKGkgPCBpbmRpY2VzW2ldKSB7XG4gICAgICByZXR1cm4gaVxuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2Vcbn1cblxuZnVuY3Rpb24gZ2V0T3ZlcmxhcHBpbmdSYW5nZSAobm9kZTogTm9kZSwgbm9kZXM6IE5vZGVbXSwgaW5kZXhNaW46IG51bWJlciwgaW5kZXhNYXg6IG51bWJlciwgcmV0dXJuRmlyc3RDb2x1bW4gPSBmYWxzZSk6IE5vZGVbXSB7XG4gIGNvbnN0IG92ZXJsYXBwaW5nOiBOb2RlW10gPSBbXVxuICBmb3IgKGNvbnN0IG90aGVyIG9mIG5vZGVzKSB7XG4gICAgaWYgKG90aGVyLmluZGV4ID49IGluZGV4TWluICYmIG90aGVyLmluZGV4IDw9IGluZGV4TWF4ICYmIGhhc092ZXJsYXAobm9kZS5zdGFydCwgbm9kZS5lbmQsIG90aGVyLnN0YXJ0LCBvdGhlci5lbmQpKSB7XG4gICAgICBvdmVybGFwcGluZy5wdXNoKG90aGVyKVxuICAgIH1cbiAgfVxuICBpZiAocmV0dXJuRmlyc3RDb2x1bW4gJiYgb3ZlcmxhcHBpbmcubGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IGZpcnN0ID0gb3ZlcmxhcHBpbmcucmVkdWNlKChtaW4sIG4pID0+IE1hdGgubWluKG1pbiwgbi5pbmRleCksIG92ZXJsYXBwaW5nWzBdLmluZGV4KVxuICAgIHJldHVybiBvdmVybGFwcGluZy5maWx0ZXIobiA9PiBuLmluZGV4ID09PSBmaXJzdClcbiAgfVxuICByZXR1cm4gb3ZlcmxhcHBpbmdcbn1cblxuZnVuY3Rpb24gZ2V0UGFyZW50IChub2RlOiBOb2RlLCBub2RlczogTm9kZVtdKTogTm9kZSB8IG51bGwge1xuICBsZXQgcGFyZW50OiBOb2RlIHwgbnVsbCA9IG51bGxcbiAgZm9yIChjb25zdCBvdGhlciBvZiBub2Rlcykge1xuICAgIGlmIChoYXNPdmVybGFwKG5vZGUuc3RhcnQsIG5vZGUuZW5kLCBvdGhlci5zdGFydCwgb3RoZXIuZW5kKSAmJiAocGFyZW50ID09PSBudWxsIHx8IG90aGVyLmluZGV4ID4gcGFyZW50LmluZGV4KSkge1xuICAgICAgcGFyZW50ID0gb3RoZXJcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHBhcmVudFxufVxuXG5mdW5jdGlvbiBoYXNGdWxsV2lkdGggKG5vZGU6IE5vZGUsIG5vZGVzOiBOb2RlW10sIG92ZXJsYXBUaHJlc2hvbGQ6IG51bWJlcik6IGJvb2xlYW4ge1xuICBmb3IgKGNvbnN0IG90aGVyIG9mIG5vZGVzKSB7XG4gICAgaWYgKG90aGVyICE9PSBub2RlICYmXG4gICAgICBvdGhlci5pbmRleCA+IG5vZGUuaW5kZXggJiZcbiAgICAgIGhhc092ZXJsYXAobm9kZS5zdGFydCwgYWRkVGltZShub2RlLnN0YXJ0LCBvdmVybGFwVGhyZXNob2xkKSwgb3RoZXIuc3RhcnQsIG90aGVyLmVuZCkpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB0cnVlXG59XG5cbmZ1bmN0aW9uIGdldEdyb3VwcyAodmlzdWFsczogQ2FsZW5kYXJFdmVudFZpc3VhbFtdLCBkYXlTdGFydDogbnVtYmVyKTogR3JvdXBbXSB7XG4gIGNvbnN0IGdyb3VwczogR3JvdXBbXSA9IFtdXG5cbiAgZm9yIChjb25zdCB2aXN1YWwgb2YgdmlzdWFscykge1xuICAgIGNvbnN0IFtzdGFydCwgZW5kXSA9IGdldE5vcm1hbGl6ZWRSYW5nZSh2aXN1YWwuZXZlbnQsIGRheVN0YXJ0KVxuICAgIGxldCBhZGRlZCA9IGZhbHNlXG5cbiAgICBmb3IgKGNvbnN0IGdyb3VwIG9mIGdyb3Vwcykge1xuICAgICAgaWYgKGhhc092ZXJsYXAoc3RhcnQsIGVuZCwgZ3JvdXAuc3RhcnQsIGdyb3VwLmVuZCkpIHtcbiAgICAgICAgZ3JvdXAudmlzdWFscy5wdXNoKHZpc3VhbClcbiAgICAgICAgZ3JvdXAuZW5kID0gTWF0aC5tYXgoZ3JvdXAuZW5kLCBlbmQpXG4gICAgICAgIGFkZGVkID0gdHJ1ZVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghYWRkZWQpIHtcbiAgICAgIGdyb3Vwcy5wdXNoKHsgc3RhcnQsIGVuZCwgdmlzdWFsczogW3Zpc3VhbF0gfSlcbiAgICB9XG4gIH1cblxuICByZXR1cm4gZ3JvdXBzXG59XG5cbmZ1bmN0aW9uIGdldE5vZGUgKHZpc3VhbDogQ2FsZW5kYXJFdmVudFZpc3VhbCwgZGF5U3RhcnQ6IG51bWJlcik6IE5vZGUge1xuICBjb25zdCBbc3RhcnQsIGVuZF0gPSBnZXROb3JtYWxpemVkUmFuZ2UodmlzdWFsLmV2ZW50LCBkYXlTdGFydClcblxuICByZXR1cm4ge1xuICAgIHBhcmVudDogbnVsbCxcbiAgICBzaWJsaW5nOiB0cnVlLFxuICAgIGluZGV4OiAwLFxuICAgIHZpc3VhbCxcbiAgICBzdGFydCxcbiAgICBlbmQsXG4gICAgY2hpbGRyZW46IFtdLFxuICB9XG59XG5cbmZ1bmN0aW9uIGdldE1heENoaWxkSW5kZXggKG5vZGU6IE5vZGUpOiBudW1iZXIge1xuICBsZXQgbWF4ID0gbm9kZS5pbmRleFxuICBmb3IgKGNvbnN0IGNoaWxkIG9mIG5vZGUuY2hpbGRyZW4pIHtcbiAgICBjb25zdCBjaGlsZE1heCA9IGdldE1heENoaWxkSW5kZXgoY2hpbGQpXG4gICAgaWYgKGNoaWxkTWF4ID4gbWF4KSB7XG4gICAgICBtYXggPSBjaGlsZE1heFxuICAgIH1cbiAgfVxuICByZXR1cm4gbWF4XG59XG5cbmZ1bmN0aW9uIGFkZFRpbWUgKGlkZW50aWZpZXI6IG51bWJlciwgbWludXRlczogbnVtYmVyKTogbnVtYmVyIHtcbiAgY29uc3QgcmVtb3ZlTWludXRlcyA9IGlkZW50aWZpZXIgJSAxMDBcbiAgY29uc3QgdG90YWxNaW51dGVzID0gcmVtb3ZlTWludXRlcyArIG1pbnV0ZXNcbiAgY29uc3QgYWRkSG91cnMgPSBNYXRoLmZsb29yKHRvdGFsTWludXRlcyAvIDYwKVxuICBjb25zdCBhZGRNaW51dGVzID0gdG90YWxNaW51dGVzICUgNjBcblxuICByZXR1cm4gaWRlbnRpZmllciAtIHJlbW92ZU1pbnV0ZXMgKyBhZGRIb3VycyAqIDEwMCArIGFkZE1pbnV0ZXNcbn1cbiJdfQ==