import { getTimestampIdentifier } from '../util/timestamp';
const MILLIS_IN_DAY = 86400000;
export function getVisuals(events, minStart = 0) {
    const visuals = events.map(event => ({
        event,
        columnCount: 0,
        column: 0,
        left: 0,
        width: 100,
    }));
    visuals.sort((a, b) => {
        return (Math.max(minStart, a.event.startTimestampIdentifier) - Math.max(minStart, b.event.startTimestampIdentifier)) ||
            (b.event.endTimestampIdentifier - a.event.endTimestampIdentifier);
    });
    return visuals;
}
export function hasOverlap(s0, e0, s1, e1, exclude = true) {
    return exclude ? !(s0 >= e1 || e0 <= s1) : !(s0 > e1 || e0 < s1);
}
export function setColumnCount(groups) {
    groups.forEach(group => {
        group.visuals.forEach(groupVisual => {
            groupVisual.columnCount = groups.length;
        });
    });
}
export function getRange(event) {
    return [event.startTimestampIdentifier, event.endTimestampIdentifier];
}
export function getDayRange(event) {
    return [event.startIdentifier, event.endIdentifier];
}
export function getNormalizedRange(event, dayStart) {
    return [Math.max(dayStart, event.startTimestampIdentifier), Math.min(dayStart + MILLIS_IN_DAY, event.endTimestampIdentifier)];
}
export function getOpenGroup(groups, start, end, timed) {
    for (let i = 0; i < groups.length; i++) {
        const group = groups[i];
        let intersected = false;
        if (hasOverlap(start, end, group.start, group.end, timed)) {
            for (let k = 0; k < group.visuals.length; k++) {
                const groupVisual = group.visuals[k];
                const [groupStart, groupEnd] = timed ? getRange(groupVisual.event) : getDayRange(groupVisual.event);
                if (hasOverlap(start, end, groupStart, groupEnd, timed)) {
                    intersected = true;
                    break;
                }
            }
        }
        if (!intersected) {
            return i;
        }
    }
    return -1;
}
export function getOverlapGroupHandler(firstWeekday) {
    const handler = {
        groups: [],
        min: -1,
        max: -1,
        reset: () => {
            handler.groups = [];
            handler.min = handler.max = -1;
        },
        getVisuals: (day, dayEvents, timed, reset = false) => {
            if (day.weekday === firstWeekday || reset) {
                handler.reset();
            }
            const dayStart = getTimestampIdentifier(day);
            const visuals = getVisuals(dayEvents, dayStart);
            visuals.forEach(visual => {
                const [start, end] = timed ? getRange(visual.event) : getDayRange(visual.event);
                if (handler.groups.length > 0 && !hasOverlap(start, end, handler.min, handler.max, timed)) {
                    setColumnCount(handler.groups);
                    handler.reset();
                }
                let targetGroup = getOpenGroup(handler.groups, start, end, timed);
                if (targetGroup === -1) {
                    targetGroup = handler.groups.length;
                    handler.groups.push({ start, end, visuals: [] });
                }
                const target = handler.groups[targetGroup];
                target.visuals.push(visual);
                target.start = Math.min(target.start, start);
                target.end = Math.max(target.end, end);
                visual.column = targetGroup;
                if (handler.min === -1) {
                    handler.min = start;
                    handler.max = end;
                }
                else {
                    handler.min = Math.min(handler.min, start);
                    handler.max = Math.max(handler.max, end);
                }
            });
            setColumnCount(handler.groups);
            if (timed) {
                handler.reset();
            }
            return visuals;
        },
    };
    return handler;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvVkNhbGVuZGFyL21vZGVzL2NvbW1vbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQTtBQUUxRCxNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUE7QUFJOUIsTUFBTSxVQUFVLFVBQVUsQ0FBRSxNQUE2QixFQUFFLFFBQVEsR0FBRyxDQUFDO0lBQ3JFLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ25DLEtBQUs7UUFDTCxXQUFXLEVBQUUsQ0FBQztRQUNkLE1BQU0sRUFBRSxDQUFDO1FBQ1QsSUFBSSxFQUFFLENBQUM7UUFDUCxLQUFLLEVBQUUsR0FBRztLQUNYLENBQUMsQ0FBQyxDQUFBO0lBRUgsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUNwQixPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQztZQUM3RyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsc0JBQXNCLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFBO0lBQzFFLENBQUMsQ0FBQyxDQUFBO0lBRUYsT0FBTyxPQUFPLENBQUE7QUFDaEIsQ0FBQztBQVFELE1BQU0sVUFBVSxVQUFVLENBQUUsRUFBVSxFQUFFLEVBQVUsRUFBRSxFQUFVLEVBQUUsRUFBVSxFQUFFLE9BQU8sR0FBRyxJQUFJO0lBQ3hGLE9BQU8sT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMs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IjpbImltcG9ydCB7IENhbGVuZGFyRXZlbnRQYXJzZWQsIENhbGVuZGFyRXZlbnRWaXN1YWwsIENhbGVuZGFyVGltZXN0YW1wIH0gZnJvbSAndnVldGlmeS90eXBlcydcbmltcG9ydCB7IGdldFRpbWVzdGFtcElkZW50aWZpZXIgfSBmcm9tICcuLi91dGlsL3RpbWVzdGFtcCdcblxuY29uc3QgTUlMTElTX0lOX0RBWSA9IDg2NDAwMDAwXG5cbmV4cG9ydCB0eXBlIEdldFJhbmdlID0gKGV2ZW50OiBDYWxlbmRhckV2ZW50UGFyc2VkKSA9PiBbbnVtYmVyLCBudW1iZXJdXG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRWaXN1YWxzIChldmVudHM6IENhbGVuZGFyRXZlbnRQYXJzZWRbXSwgbWluU3RhcnQgPSAwKTogQ2FsZW5kYXJFdmVudFZpc3VhbFtdIHtcbiAgY29uc3QgdmlzdWFscyA9IGV2ZW50cy5tYXAoZXZlbnQgPT4gKHtcbiAgICBldmVudCxcbiAgICBjb2x1bW5Db3VudDogMCxcbiAgICBjb2x1bW46IDAsXG4gICAgbGVmdDogMCxcbiAgICB3aWR0aDogMTAwLFxuICB9KSlcblxuICB2aXN1YWxzLnNvcnQoKGEsIGIpID0+IHtcbiAgICByZXR1cm4gKE1hdGgubWF4KG1pblN0YXJ0LCBhLmV2ZW50LnN0YXJ0VGltZXN0YW1wSWRlbnRpZmllcikgLSBNYXRoLm1heChtaW5TdGFydCwgYi5ldmVudC5zdGFydFRpbWVzdGFtcElkZW50aWZpZXIpKSB8fFxuICAgICAgICAgICAoYi5ldmVudC5lbmRUaW1lc3RhbXBJZGVudGlmaWVyIC0gYS5ldmVudC5lbmRUaW1lc3RhbXBJZGVudGlmaWVyKVxuICB9KVxuXG4gIHJldHVybiB2aXN1YWxzXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29sdW1uR3JvdXAge1xuICBzdGFydDogbnVtYmVyXG4gIGVuZDogbnVtYmVyXG4gIHZpc3VhbHM6IENhbGVuZGFyRXZlbnRWaXN1YWxbXVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzT3ZlcmxhcCAoczA6IG51bWJlciwgZTA6IG51bWJlciwgczE6IG51bWJlciwgZTE6IG51bWJlciwgZXhjbHVkZSA9IHRydWUpOiBib29sZWFuIHtcbiAgcmV0dXJuIGV4Y2x1ZGUgPyAhKHMwID49IGUxIHx8IGUwIDw9IHMxKSA6ICEoczAgPiBlMSB8fCBlMCA8IHMxKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0Q29sdW1uQ291bnQgKGdyb3VwczogQ29sdW1uR3JvdXBbXSkge1xuICBncm91cHMuZm9yRWFjaChncm91cCA9PiB7XG4gICAgZ3JvdXAudmlzdWFscy5mb3JFYWNoKGdyb3VwVmlzdWFsID0+IHtcbiAgICAgIGdyb3VwVmlzdWFsLmNvbHVtbkNvdW50ID0gZ3JvdXBzLmxlbmd0aFxuICAgIH0pXG4gIH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRSYW5nZSAoZXZlbnQ6IENhbGVuZGFyRXZlbnRQYXJzZWQpOiBbbnVtYmVyLCBudW1iZXJdIHtcbiAgcmV0dXJuIFtldmVudC5zdGFydFRpbWVzdGFtcElkZW50aWZpZXIsIGV2ZW50LmVuZFRpbWVzdGFtcElkZW50aWZpZXJdXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREYXlSYW5nZSAoZXZlbnQ6IENhbGVuZGFyRXZlbnRQYXJzZWQpOiBbbnVtYmVyLCBudW1iZXJdIHtcbiAgcmV0dXJuIFtldmVudC5zdGFydElkZW50aWZpZXIsIGV2ZW50LmVuZElkZW50aWZpZXJdXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXROb3JtYWxpemVkUmFuZ2UgKGV2ZW50OiBDYWxlbmRhckV2ZW50UGFyc2VkLCBkYXlTdGFydDogbnVtYmVyKTogW251bWJlciwgbnVtYmVyXSB7XG4gIHJldHVybiBbTWF0aC5tYXgoZGF5U3RhcnQsIGV2ZW50LnN0YXJ0VGltZXN0YW1wSWRlbnRpZmllciksIE1hdGgubWluKGRheVN0YXJ0ICsgTUlMTElTX0lOX0RBWSwgZXZlbnQuZW5kVGltZXN0YW1wSWRlbnRpZmllcildXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRPcGVuR3JvdXAgKGdyb3VwczogQ29sdW1uR3JvdXBbXSwgc3RhcnQ6IG51bWJlciwgZW5kOiBudW1iZXIsIHRpbWVkOiBib29sZWFuKSB7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgZ3JvdXBzLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgZ3JvdXAgPSBncm91cHNbaV1cbiAgICBsZXQgaW50ZXJzZWN0ZWQgPSBmYWxzZVxuXG4gICAgaWYgKGhhc092ZXJsYXAoc3RhcnQsIGVuZCwgZ3JvdXAuc3RhcnQsIGdyb3VwLmVuZCwgdGltZWQpKSB7XG4gICAgICBmb3IgKGxldCBrID0gMDsgayA8IGdyb3VwLnZpc3VhbHMubGVuZ3RoOyBrKyspIHtcbiAgICAgICAgY29uc3QgZ3JvdXBWaXN1YWwgPSBncm91cC52aXN1YWxzW2tdXG4gICAgICAgIGNvbnN0IFtncm91cFN0YXJ0LCBncm91cEVuZF0gPSB0aW1lZCA/IGdldFJhbmdlKGdyb3VwVmlzdWFsLmV2ZW50KSA6IGdldERheVJhbmdlKGdyb3VwVmlzdWFsLmV2ZW50KVxuXG4gICAgICAgIGlmIChoYXNPdmVybGFwKHN0YXJ0LCBlbmQsIGdyb3VwU3RhcnQsIGdyb3VwRW5kLCB0aW1lZCkpIHtcbiAgICAgICAgICBpbnRlcnNlY3RlZCA9IHRydWVcbiAgICAgICAgICBicmVha1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFpbnRlcnNlY3RlZCkge1xuICAgICAgcmV0dXJuIGlcbiAgICB9XG4gIH1cblxuICByZXR1cm4gLTFcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE92ZXJsYXBHcm91cEhhbmRsZXIgKGZpcnN0V2Vla2RheTogbnVtYmVyKSB7XG4gIGNvbnN0IGhhbmRsZXIgPSB7XG4gICAgZ3JvdXBzOiBbXSBhcyBDb2x1bW5Hcm91cFtdLFxuICAgIG1pbjogLTEsXG4gICAgbWF4OiAtMSxcbiAgICByZXNldDogKCkgPT4ge1xuICAgICAgaGFuZGxlci5ncm91cHMgPSBbXVxuICAgICAgaGFuZGxlci5taW4gPSBoYW5kbGVyLm1heCA9IC0xXG4gICAgfSxcbiAgICBnZXRWaXN1YWxzOiAoZGF5OiBDYWxlbmRhclRpbWVzdGFtcCwgZGF5RXZlbnRzOiBDYWxlbmRhckV2ZW50UGFyc2VkW10sIHRpbWVkOiBib29sZWFuLCByZXNldCA9IGZhbHNlKSA9PiB7XG4gICAgICBpZiAoZGF5LndlZWtkYXkgPT09IGZpcnN0V2Vla2RheSB8fCByZXNldCkge1xuICAgICAgICBoYW5kbGVyLnJlc2V0KClcbiAgICAgIH1cblxuICAgICAgY29uc3QgZGF5U3RhcnQgPSBnZXRUaW1lc3RhbXBJZGVudGlmaWVyKGRheSlcbiAgICAgIGNvbnN0IHZpc3VhbHMgPSBnZXRWaXN1YWxzKGRheUV2ZW50cywgZGF5U3RhcnQpXG5cbiAgICAgIHZpc3VhbHMuZm9yRWFjaCh2aXN1YWwgPT4ge1xuICAgICAgICBjb25zdCBbc3RhcnQsIGVuZF0gPSB0aW1lZCA/IGdldFJhbmdlKHZpc3VhbC5ldmVudCkgOiBnZXREYXlSYW5nZSh2aXN1YWwuZXZlbnQpXG5cbiAgICAgICAgaWYgKGhhbmRsZXIuZ3JvdXBzLmxlbmd0aCA+IDAgJiYgIWhhc092ZXJsYXAoc3RhcnQsIGVuZCwgaGFuZGxlci5taW4sIGhhbmRsZXIubWF4LCB0aW1lZCkpIHtcbiAgICAgICAgICBzZXRDb2x1bW5Db3VudChoYW5kbGVyLmdyb3VwcylcbiAgICAgICAgICBoYW5kbGVyLnJlc2V0KClcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB0YXJnZXRHcm91cCA9IGdldE9wZW5Hcm91cChoYW5kbGVyLmdyb3Vwcywgc3RhcnQsIGVuZCwgdGltZWQpXG5cbiAgICAgICAgaWYgKHRhcmdldEdyb3VwID09PSAtMSkge1xuICAgICAgICAgIHRhcmdldEdyb3VwID0gaGFuZGxlci5ncm91cHMubGVuZ3RoXG5cbiAgICAgICAgICBoYW5kbGVyLmdyb3Vwcy5wdXNoKHsgc3RhcnQsIGVuZCwgdmlzdWFsczogW10gfSlcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHRhcmdldCA9IGhhbmRsZXIuZ3JvdXBzW3RhcmdldEdyb3VwXVxuICAgICAgICB0YXJnZXQudmlzdWFscy5wdXNoKHZpc3VhbClcbiAgICAgICAgdGFyZ2V0LnN0YXJ0ID0gTWF0aC5taW4odGFyZ2V0LnN0YXJ0LCBzdGFydClcbiAgICAgICAgdGFyZ2V0LmVuZCA9IE1hdGgubWF4KHRhcmdldC5lbmQsIGVuZClcblxuICAgICAgICB2aXN1YWwuY29sdW1uID0gdGFyZ2V0R3JvdXBcblxuICAgICAgICBpZiAoaGFuZGxlci5taW4gPT09IC0xKSB7XG4gICAgICAgICAgaGFuZGxlci5taW4gPSBzdGFydFxuICAgICAgICAgIGhhbmRsZXIubWF4ID0gZW5kXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaGFuZGxlci5taW4gPSBNYXRoLm1pbihoYW5kbGVyLm1pbiwgc3RhcnQpXG4gICAgICAgICAgaGFuZGxlci5tYXggPSBNYXRoLm1heChoYW5kbGVyLm1heCwgZW5kKVxuICAgICAgICB9XG4gICAgICB9KVxuXG4gICAgICBzZXRDb2x1bW5Db3VudChoYW5kbGVyLmdyb3VwcylcblxuICAgICAgaWYgKHRpbWVkKSB7XG4gICAgICAgIGhhbmRsZXIucmVzZXQoKVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gdmlzdWFsc1xuICAgIH0sXG4gIH1cblxuICByZXR1cm4gaGFuZGxlclxufVxuIl19