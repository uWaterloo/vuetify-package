// Styles
import './VCalendarCategory.sass';
// Mixins
import VCalendarDaily from './VCalendarDaily';
// Util
import { convertToUnit, getSlot } from '../../util/helpers';
import props from './util/props';
import { getParsedCategories } from './util/parser';
/* @vue/component */
export default VCalendarDaily.extend({
    name: 'v-calendar-category',
    props: props.category,
    computed: {
        classes() {
            return {
                'v-calendar-daily': true,
                'v-calendar-category': true,
                ...this.themeClasses,
            };
        },
        parsedCategories() {
            return getParsedCategories(this.categories, this.categoryText);
        },
    },
    methods: {
        genDayHeader(day, index) {
            const data = {
                staticClass: 'v-calendar-category__columns',
            };
            const scope = {
                week: this.days, ...day, index,
            };
            const children = this.parsedCategories.map(category => {
                return this.genDayHeaderCategory(day, this.getCategoryScope(scope, category));
            });
            return [this.$createElement('div', data, children)];
        },
        getCategoryScope(scope, category) {
            const cat = typeof category === 'object' && category &&
                category.categoryName === this.categoryForInvalid ? null : category;
            return {
                ...scope,
                category: cat,
            };
        },
        genDayHeaderCategory(day, scope) {
            const headerTitle = typeof scope.category === 'object' ? scope.category.categoryName : scope.category;
            return this.$createElement('div', {
                staticClass: 'v-calendar-category__column-header',
                on: this.getDefaultMouseEventHandlers(':day-category', e => {
                    return this.getCategoryScope(this.getSlotScope(day), scope.category);
                }),
            }, [
                getSlot(this, 'category', scope) || this.genDayHeaderCategoryTitle(headerTitle),
                getSlot(this, 'day-header', scope),
            ]);
        },
        genDayHeaderCategoryTitle(categoryName) {
            return this.$createElement('div', {
                staticClass: 'v-calendar-category__category',
            }, categoryName === null ? this.categoryForInvalid : categoryName);
        },
        genDays() {
            const days = [];
            this.days.forEach((d, j) => {
                const day = new Array(this.parsedCategories.length || 1);
                day.fill(d);
                days.push(...day.map((v, i) => this.genDay(v, j, i)));
            });
            return days;
        },
        genDay(day, index, categoryIndex) {
            const category = this.parsedCategories[categoryIndex];
            return this.$createElement('div', {
                key: day.date + '-' + categoryIndex,
                staticClass: 'v-calendar-daily__day',
                class: this.getRelativeClasses(day),
                on: this.getDefaultMouseEventHandlers(':time', e => {
                    return this.getSlotScope(this.getTimestampAtEvent(e, day));
                }),
            }, [
                ...this.genDayIntervals(index, category),
                ...this.genDayBody(day, category),
            ]);
        },
        genDayIntervals(index, category) {
            return this.intervals[index].map(v => this.genDayInterval(v, category));
        },
        genDayInterval(interval, category) {
            const height = convertToUnit(this.intervalHeight);
            const styler = this.intervalStyle || this.intervalStyleDefault;
            const data = {
                key: interval.time,
                staticClass: 'v-calendar-daily__day-interval',
                style: {
                    height,
                    ...styler({ ...interval, category }),
                },
            };
            const children = getSlot(this, 'interval', () => this.getCategoryScope(this.getSlotScope(interval), category));
            return this.$createElement('div', data, children);
        },
        genDayBody(day, category) {
            const data = {
                staticClass: 'v-calendar-category__columns',
            };
            const children = [this.genDayBodyCategory(day, category)];
            return [this.$createElement('div', data, children)];
        },
        genDayBodyCategory(day, category) {
            const data = {
                staticClass: 'v-calendar-category__column',
                on: this.getDefaultMouseEventHandlers(':time-category', e => {
                    return this.getCategoryScope(this.getSlotScope(this.getTimestampAtEvent(e, day)), category);
                }),
            };
            const children = getSlot(this, 'day-body', () => this.getCategoryScope(this.getSlotScope(day), category));
            return this.$createElement('div', data, children);
        },
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVkNhbGVuZGFyQ2F0ZWdvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tcG9uZW50cy9WQ2FsZW5kYXIvVkNhbGVuZGFyQ2F0ZWdvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsU0FBUztBQUNULE9BQU8sMEJBQTBCLENBQUE7QUFLakMsU0FBUztBQUNULE9BQU8sY0FBYyxNQUFNLGtCQUFrQixDQUFBO0FBRTdDLE9BQU87QUFDUCxPQUFPLEVBQUUsYUFBYSxFQUFFLE9BQU8sRUFBRSxNQUFNLG9CQUFvQixDQUFBO0FBRTNELE9BQU8sS0FBSyxNQUFNLGNBQWMsQ0FBQTtBQUNoQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFFbkQsb0JBQW9CO0FBQ3BCLGVBQWUsY0FBYyxDQUFDLE1BQU0sQ0FBQztJQUNuQyxJQUFJLEVBQUUscUJBQXFCO0lBRTNCLEtBQUssRUFBRSxLQUFLLENBQUMsUUFBUTtJQUVyQixRQUFRLEVBQUU7UUFDUixPQUFPO1lBQ0wsT0FBTztnQkFDTCxrQkFBa0IsRUFBRSxJQUFJO2dCQUN4QixxQkFBcUIsRUFBRSxJQUFJO2dCQUMzQixHQUFHLElBQUksQ0FBQyxZQUFZO2FBQ3JCLENBQUE7UUFDSCxDQUFDO1FBQ0QsZ0JBQWdCO1lBQ2QsT0FBTyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQTtRQUNoRSxDQUFDO0tBQ0Y7SUFDRCxPQUFPLEVBQUU7UUFDUCxZQUFZLENBQUUsR0FBc0IsRUFBRSxLQUFhO1lBQ2pELE1BQU0sSUFBSSxHQUFHO2dCQUNYLFdBQVcsRUFBRSw4QkFBOEI7YUFDNUMsQ0FBQTtZQUNELE1BQU0sS0FBSyxHQUFHO2dCQUNaLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsR0FBRyxFQUFFLEtBQUs7YUFDL0IsQ0FBQTtZQUVELE1BQU0sUUFBUSxHQUFHLElBQUks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QUFZLENBQUMsR0FBRyxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQTtZQUV6RyxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQTtRQUNuRCxDQUFDO0tBQ0Y7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTdHlsZXNcbmltcG9ydCAnLi9WQ2FsZW5kYXJDYXRlZ29yeS5zYXNzJ1xuXG4vLyBUeXBlc1xuaW1wb3J0IHsgVk5vZGUgfSBmcm9tICd2dWUnXG5cbi8vIE1peGluc1xuaW1wb3J0IFZDYWxlbmRhckRhaWx5IGZyb20gJy4vVkNhbGVuZGFyRGFpbHknXG5cbi8vIFV0aWxcbmltcG9ydCB7IGNvbnZlcnRUb1VuaXQsIGdldFNsb3QgfSBmcm9tICcuLi8uLi91dGlsL2hlbHBlcnMnXG5pbXBvcnQgeyBDYWxlbmRhckNhdGVnb3J5LCBDYWxlbmRhclRpbWVzdGFtcCB9IGZyb20gJ3R5cGVzJ1xuaW1wb3J0IHByb3BzIGZyb20gJy4vdXRpbC9wcm9wcydcbmltcG9ydCB7IGdldFBhcnNlZENhdGVnb3JpZXMgfSBmcm9tICcuL3V0aWwvcGFyc2VyJ1xuXG4vKiBAdnVlL2NvbXBvbmVudCAqL1xuZXhwb3J0IGRlZmF1bHQgVkNhbGVuZGFyRGFpbHkuZXh0ZW5kKHtcbiAgbmFtZTogJ3YtY2FsZW5kYXItY2F0ZWdvcnknLFxuXG4gIHByb3BzOiBwcm9wcy5jYXRlZ29yeSxcblxuICBjb21wdXRlZDoge1xuICAgIGNsYXNzZXMgKCk6IG9iamVjdCB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAndi1jYWxlbmRhci1kYWlseSc6IHRydWUsXG4gICAgICAgICd2LWNhbGVuZGFyLWNhdGVnb3J5JzogdHJ1ZSxcbiAgICAgICAgLi4udGhpcy50aGVtZUNsYXNzZXMsXG4gICAgICB9XG4gICAgfSxcbiAgICBwYXJzZWRDYXRlZ29yaWVzICgpOiBDYWxlbmRhckNhdGVnb3J5W10ge1xuICAgICAgcmV0dXJuIGdldFBhcnNlZENhdGVnb3JpZXModGhpcy5jYXRlZ29yaWVzLCB0aGlzLmNhdGVnb3J5VGV4dClcbiAgICB9LFxuICB9LFxuICBtZXRob2RzOiB7XG4gICAgZ2VuRGF5SGVhZGVyIChkYXk6IENhbGVuZGFyVGltZXN0YW1wLCBpbmRleDogbnVtYmVyKTogVk5vZGVbXSB7XG4gICAgICBjb25zdCBkYXRhID0ge1xuICAgICAgICBzdGF0aWNDbGFzczogJ3YtY2FsZW5kYXItY2F0ZWdvcnlfX2NvbHVtbnMnLFxuICAgICAgfVxuICAgICAgY29uc3Qgc2NvcGUgPSB7XG4gICAgICAgIHdlZWs6IHRoaXMuZGF5cywgLi4uZGF5LCBpbmRleCxcbiAgICAgIH1cblxuICAgICAgY29uc3QgY2hpbGRyZW4gPSB0aGlzLnBhcnNlZENhdGVnb3JpZXMubWFwKGNhdGVnb3J5ID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2VuRGF5SGVhZGVyQ2F0ZWdvcnkoZGF5LCB0aGlzLmdldENhdGVnb3J5U2NvcGUoc2NvcGUsIGNhdGVnb3J5KSlcbiAgICAgIH0pXG5cbiAgICAgIHJldHVybiBbdGhpcy4kY3JlYXRlRWxlbWVudCgnZGl2JywgZGF0YSwgY2hpbGRyZW4pXVxuICAgIH0sXG4gICAgZ2V0Q2F0ZWdvcnlTY29wZSAoc2NvcGU6IGFueSwgY2F0ZWdvcnk6IENhbGVuZGFyQ2F0ZWdvcnkpIHtcbiAgICAgIGNvbnN0IGNhdCA9IHR5cGVvZiBjYXRlZ29yeSA9PT0gJ29iamVjdCcgJiYgY2F0ZWdvcnkgJiZcbiAgICAgICAgICBjYXRlZ29yeS5jYXRlZ29yeU5hbWUgPT09IHRoaXMuY2F0ZWdvcnlGb3JJbnZhbGlkID8gbnVsbCA6IGNhdGVnb3J5XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5zY29wZSxcbiAgICAgICAgY2F0ZWdvcnk6IGNhdCxcbiAgICAgIH1cbiAgICB9LFxuICAgIGdlbkRheUhlYWRlckNhdGVnb3J5IChkYXk6IENhbGVuZGFyVGltZXN0YW1wLCBzY29wZTogYW55KTogVk5vZGUge1xuICAgICAgY29uc3QgaGVhZGVyVGl0bGUgPSB0eXBlb2Ygc2NvcGUuY2F0ZWdvcnkgPT09ICdvYmplY3QnID8gc2NvcGUuY2F0ZWdvcnkuY2F0ZWdvcnlOYW1lIDogc2NvcGUuY2F0ZWdvcnlcbiAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCdkaXYnLCB7XG4gICAgICAgIHN0YXRpY0NsYXNzOiAndi1jYWxlbmRhci1jYXRlZ29yeV9fY29sdW1uLWhlYWRlcicsXG4gICAgICAgIG9uOiB0aGlzLmdldERlZmF1bHRNb3VzZUV2ZW50SGFuZGxlcnMoJzpkYXktY2F0ZWdvcnknLCBlID0+IHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDYXRlZ29yeVNjb3BlKHRoaXMuZ2V0U2xvdFNjb3BlKGRheSksIHNjb3BlLmNhdGVnb3J5KVxuICAgICAgICB9KSxcbiAgICAgIH0sIFtcbiAgICAgICAgZ2V0U2xvdCh0aGlzLCAnY2F0ZWdvcnknLCBzY29wZSkgfHwgdGhpcy5nZW5EYXlIZWFkZXJDYXRlZ29yeVRpdGxlKGhlYWRlclRpdGxlKSxcbiAgICAgICAgZ2V0U2xvdCh0aGlzLCAnZGF5LWhlYWRlcicsIHNjb3BlKSxcbiAgICAgIF0pXG4gICAgfSxcbiAgICBnZW5EYXlIZWFkZXJDYXRlZ29yeVRpdGxlIChjYXRlZ29yeU5hbWU6IHN0cmluZyB8IG51bGwpIHtcbiAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCdkaXYnLCB7XG4gICAgICAgIHN0YXRpY0NsYXNzOiAndi1jYWxlbmRhci1jYXRlZ29yeV9fY2F0ZWdvcnknLFxuICAgICAgfSwgY2F0ZWdvcnlOYW1lID09PSBudWxsID8gdGhpcy5jYXRlZ29yeUZvckludmFsaWQgOiBjYXRlZ29yeU5hbWUpXG4gICAgfSxcbiAgICBnZW5EYXlzICgpOiBWTm9kZVtdIHtcbiAgICAgIGNvbnN0IGRheXM6IFZOb2RlW10gPSBbXVxuICAgICAgdGhpcy5kYXlzLmZvckVhY2goKGQsIGopID0+IHtcbiAgICAgICAgY29uc3QgZGF5ID0gbmV3IEFycmF5KHRoaXMucGFyc2VkQ2F0ZWdvcmllcy5sZW5ndGggfHwgMSlcbiAgICAgICAgZGF5LmZpbGwoZClcbiAgICAgICAgZGF5cy5wdXNoKC4uLmRheS5tYXAoKHYsIGkpID0+IHRoaXMuZ2VuRGF5KHYsIGosIGkpKSlcbiAgICAgIH0pXG4gICAgICByZXR1cm4gZGF5c1xuICAgIH0sXG4gICAgZ2VuRGF5IChkYXk6IENhbGVuZGFyVGltZXN0YW1wLCBpbmRleDogbnVtYmVyLCBjYXRlZ29yeUluZGV4OiBudW1iZXIpOiBWTm9kZSB7XG4gICAgICBjb25zdCBjYXRlZ29yeSA9IHRoaXMucGFyc2VkQ2F0ZWdvcmllc1tjYXRlZ29yeUluZGV4XVxuICAgICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ2RpdicsIHtcbiAgICAgICAga2V5OiBkYXkuZGF0ZSArICctJyArIGNhdGVnb3J5SW5kZXgsXG4gICAgICAgIHN0YXRpY0NsYXNzOiAndi1jYWxlbmRhci1kYWlseV9fZGF5JyxcbiAgICAgICAgY2xhc3M6IHRoaXMuZ2V0UmVsYXRpdmVDbGFzc2VzKGRheSksXG4gICAgICAgIG9uOiB0aGlzLmdldERlZmF1bHRNb3VzZUV2ZW50SGFuZGxlcnMoJzp0aW1lJywgZSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2xvdFNjb3BlKHRoaXMuZ2V0VGltZXN0YW1wQXRFdmVudChlLCBkYXkpKVxuICAgICAgICB9KSxcbiAgICAgIH0sIFtcbiAgICAgICAgLi4udGhpcy5nZW5EYXlJbnRlcnZhbHMoaW5kZXgsIGNhdGVnb3J5KSxcbiAgICAgICAgLi4udGhpcy5nZW5EYXlCb2R5KGRheSwgY2F0ZWdvcnkpLFxuICAgICAgXSlcbiAgICB9LFxuICAgIGdlbkRheUludGVydmFscyAoaW5kZXg6IG51bWJlciwgY2F0ZWdvcnk6IENhbGVuZGFyQ2F0ZWdvcnkpOiBWTm9kZVtdIHtcbiAgICAgIHJldHVybiB0aGlzLmludGVydmFsc1tpbmRleF0ubWFwKHYgPT4gdGhpcy5nZW5EYXlJbnRlcnZhbCh2LCBjYXRlZ29yeSkpXG4gICAgfSxcbiAgICBnZW5EYXlJbnRlcnZhbCAoaW50ZXJ2YWw6IENhbGVuZGFyVGltZXN0YW1wLCBjYXRlZ29yeTogQ2FsZW5kYXJDYXRlZ29yeSk6IFZOb2RlIHtcbiAgICAgIGNvbnN0IGhlaWdodDogc3RyaW5nIHwgdW5kZWZpbmVkID0gY29udmVydFRvVW5pdCh0aGlzLmludGVydmFsSGVpZ2h0KVxuICAgICAgY29uc3Qgc3R5bGVyID0gdGhpcy5pbnRlcnZhbFN0eWxlIHx8IHRoaXMuaW50ZXJ2YWxTdHlsZURlZmF1bHRcblxuICAgICAgY29uc3QgZGF0YSA9IHtcbiAgICAgICAga2V5OiBpbnRlcnZhbC50aW1lLFxuICAgICAgICBzdGF0aWNDbGFzczogJ3YtY2FsZW5kYXItZGFpbHlfX2RheS1pbnRlcnZhbCcsXG4gICAgICAgIHN0eWxlOiB7XG4gICAgICAgICAgaGVpZ2h0LFxuICAgICAgICAgIC4uLnN0eWxlcih7IC4uLmludGVydmFsLCBjYXRlZ29yeSB9KSxcbiAgICAgICAgfSxcbiAgICAgIH1cblxuICAgICAgY29uc3QgY2hpbGRyZW4gPSBnZXRTbG90KHRoaXMsICdpbnRlcnZhbCcsICgpID0+XG4gICAgICAgIHRoaXMuZ2V0Q2F0ZWdvcnlTY29wZSh0aGlzLmdldFNsb3RTY29wZShpbnRlcnZhbCksIGNhdGVnb3J5KVxuICAgICAgKVxuXG4gICAgICByZXR1cm4gdGhpcy4kY3JlYXRlRWxlbWVudCgnZGl2JywgZGF0YSwgY2hpbGRyZW4pXG4gICAgfSxcbiAgICBnZW5EYXlCb2R5IChkYXk6IENhbGVuZGFyVGltZXN0YW1wLCBjYXRlZ29yeTogQ2FsZW5kYXJDYXRlZ29yeSk6IFZOb2RlW10ge1xuICAgICAgY29uc3QgZGF0YSA9IHtcbiAgICAgICAgc3RhdGljQ2xhc3M6ICd2LWNhbGVuZGFyLWNhdGVnb3J5X19jb2x1bW5zJyxcbiAgICAgIH1cblxuICAgICAgY29uc3QgY2hpbGRyZW4gPSBbdGhpcy5nZW5EYXlCb2R5Q2F0ZWdvcnkoZGF5LCBjYXRlZ29yeSldXG5cbiAgICAgIHJldHVybiBbdGhpcy4kY3JlYXRlRWxlbWVudCgnZGl2JywgZGF0YSwgY2hpbGRyZW4pXVxuICAgIH0sXG4gICAgZ2VuRGF5Qm9keUNhdGVnb3J5IChkYXk6IENhbGVuZGFyVGltZXN0YW1wLCBjYXRlZ29yeTogQ2FsZW5kYXJDYXRlZ29yeSk6IFZOb2RlIHtcbiAgICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgIHN0YXRpY0NsYXNzOiAndi1jYWxlbmRhci1jYXRlZ29yeV9fY29sdW1uJyxcbiAgICAgICAgb246IHRoaXMuZ2V0RGVmYXVsdE1vdXNlRXZlbnRIYW5kbGVycygnOnRpbWUtY2F0ZWdvcnknLCBlID0+IHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDYXRlZ29yeVNjb3BlKHRoaXMuZ2V0U2xvdFNjb3BlKHRoaXMuZ2V0VGltZXN0YW1wQXRFdmVudChlLCBkYXkpKSwgY2F0ZWdvcnkpXG4gICAgICAgIH0pLFxuICAgICAgfVxuXG4gICAgICBjb25zdCBjaGlsZHJlbiA9IGdldFNsb3QodGhpcywgJ2RheS1ib2R5JywgKCkgPT4gdGhpcy5nZXRDYXRlZ29yeVNjb3BlKHRoaXMuZ2V0U2xvdFNjb3BlKGRheSksIGNhdGVnb3J5KSlcblxuICAgICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ2RpdicsIGRhdGEsIGNoaWxkcmVuKVxuICAgIH0sXG4gIH0sXG59KVxuIl19