// Components
import VOverlay from '../../components/VOverlay';
// Utilities
import { keyCodes, addOnceEventListener, addPassiveEventListener, getZIndex, composedPath, } from '../../util/helpers';
// Types
import Vue from 'vue';
/* @vue/component */
export default Vue.extend().extend({
    name: 'overlayable',
    props: {
        hideOverlay: Boolean,
        overlayColor: String,
        overlayOpacity: [Number, String],
    },
    data() {
        return {
            animationFrame: 0,
            overlay: null,
        };
    },
    watch: {
        hideOverlay(value) {
            if (!this.isActive)
                return;
            if (value)
                this.removeOverlay();
            else
                this.genOverlay();
        },
    },
    beforeDestroy() {
        this.removeOverlay();
    },
    methods: {
        createOverlay() {
            const overlay = new VOverlay({
                propsData: {
                    absolute: this.absolute,
                    value: false,
                    color: this.overlayColor,
                    opacity: this.overlayOpacity,
                },
            });
            overlay.$mount();
            const parent = this.absolute
                ? this.$el.parentNode
                : document.querySelector('[data-app]');
            parent && parent.insertBefore(overlay.$el, parent.firstChild);
            this.overlay = overlay;
        },
        genOverlay() {
            this.hideScroll();
            if (this.hideOverlay)
                return;
            if (!this.overlay)
                this.createOverlay();
            this.animationFrame = requestAnimationFrame(() => {
                if (!this.overlay)
                    return;
                if (this.activeZIndex !== undefined) {
                    this.overlay.zIndex = String(this.activeZIndex - 1);
                }
                else if (this.$el) {
                    this.overlay.zIndex = getZIndex(this.$el);
                }
                this.overlay.value = true;
            });
            return true;
        },
        /** removeOverlay(false) will not restore the scollbar afterwards */
        removeOverlay(showScroll = true) {
            if (this.overlay) {
                addOnceEventListener(this.overlay.$el, 'transitionend', () => {
                    if (!this.overlay ||
                        !this.overlay.$el ||
                        !this.overlay.$el.parentNode ||
                        this.overlay.value ||
                        this.isActive)
                        return;
                    this.overlay.$el.parentNode.removeChild(this.overlay.$el);
                    this.overlay.$destroy();
                    this.overlay = null;
                });
                // Cancel animation frame in case
                // overlay is removed before it
                // has finished its animation
                cancelAnimationFrame(this.animationFrame);
                this.overlay.value = false;
            }
            showScroll && this.showScroll();
        },
        scrollListener(e) {
            if (e.type === 'keydown') {
                if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName) ||
                    // https://github.com/vuetifyjs/vuetify/issues/4715
                    e.target.isContentEditable)
                    return;
                const up = [keyCodes.up, keyCodes.pageup];
                const down = [keyCodes.down, keyCodes.pagedown];
                if (up.includes(e.keyCode)) {
                    e.deltaY = -1;
                }
                else if (down.includes(e.keyCode)) {
                    e.deltaY = 1;
                }
                else {
                    return;
                }
            }
            if (e.target === this.overlay ||
                (e.type !== 'keydown' && e.target === document.body) ||
                this.checkPath(e))
                e.preventDefault();
        },
        hasScrollbar(el) {
            if (!el || el.nodeType !== Node.ELEMENT_NODE)
                return false;
            const style = window.getComputedStyle(el);
            return ((['auto', 'scroll'].includes(style.overflowY) || el.tagName === 'SELECT') && el.scrollHeight > el.clientHeight) ||
                ((['auto', 'scroll'].includes(style.overflowX)) && el.scrollWidth > el.clientWidth);
        },
        shouldScroll(el, e) {
            if (el.hasAttribute('data-app'))
                return false;
            const dir = e.shiftKey || e.deltaX ? 'x' : 'y';
            const delta = dir === 'y' ? e.deltaY : e.deltaX || e.deltaY;
            let alreadyAtStart;
            let alreadyAtEnd;
            if (dir === 'y') {
                alreadyAtStart = el.scrollTop === 0;
                alreadyAtEnd = el.scrollTop + el.clientHeight === el.scrollHeight;
            }
            else {
                alreadyAtStart = el.scrollLeft === 0;
                alreadyAtEnd = el.scrollLeft + el.clientWidth === el.scrollWidth;
            }
            const scrollingUp = delta < 0;
            const scrollingDown = delta > 0;
            if (!alreadyAtStart && scrollingUp)
                return true;
            if (!alreadyAtEnd && scrollingDown)
                return true;
            if ((alreadyAtStart || alreadyAtEnd)) {
                return this.shouldScroll(el.parentNode, e);
            }
            return false;
        },
        isInside(el, parent) {
            if (el === parent) {
                return true;
            }
            else if (el === null || el === document.body) {
                return false;
            }
            else {
                return this.isInside(el.parentNode, parent);
            }
        },
        checkPath(e) {
            const path = composedPath(e);
            if (e.type === 'keydown' && path[0] === document.body) {
                const dialog = this.$refs.dialog;
                // getSelection returns null in firefox in some edge cases, can be ignored
                const selected = window.getSelection().anchorNode;
                if (dialog && this.hasScrollbar(dialog) && this.isInside(selected, dialog)) {
                    return !this.shouldScroll(dialog, e);
                }
                return true;
            }
            for (let index = 0; index < path.length; index++) {
                const el = path[index];
                if (el === document)
                    return true;
                if (el === document.documentElement)
                    return true;
                if (el === this.$refs.content)
                    return true;
                if (this.hasScrollbar(el))
                    return !this.shouldScroll(el, e);
            }
            return true;
        },
        hideScroll() {
            if (this.$vuetify.breakpoint.smAndDown) {
                document.documentElement.classList.add('overflow-y-hidden');
            }
            else {
                addPassiveEventListener(window, 'wheel', this.scrollListener, { passive: false });
                window.addEventListener('keydown', this.scrollListener);
            }
        },
        showScroll() {
            document.documentElement.classList.remove('overflow-y-hidden');
            window.removeEventListener('wheel', this.scrollListener);
            window.removeEventListener('keydown', this.scrollListener);
        },
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbWl4aW5zL292ZXJsYXlhYmxlL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLGFBQWE7QUFDYixPQUFPLFFBQVEsTUFBTSwyQkFBMkIsQ0FBQTtBQUVoRCxZQUFZO0FBQ1osT0FBTyxFQUNMLFFBQVEsRUFDUixvQkFBb0IsRUFDcEIsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFDVCxZQUFZLEdBQ2IsTUFBTSxvQkFBb0IsQ0FBQTtBQUUzQixRQUFRO0FBQ1IsT0FBTyxHQUFHLE1BQU0sS0FBSyxDQUFBO0FBa0JyQixvQkFBb0I7QUFDcEIsZUFBZSxHQUFHLENBQUMsTUFBTSxFQUEwQyxDQUFDLE1BQU0sQ0FBQztJQUN6RSxJQUFJLEVBQUUsYUFBYTtJQUVuQixLQUFLLEVBQUU7UUFDTCxXQUFXLEVBQUUsT0FBTztRQUNwQixZQUFZLEVBQUUsTUFBTTtRQUNwQixjQUFjLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO0tBQ2pDO0lBRUQsSUFBSTtRQUNGLE9BQU87WUFDTCxjQUFjLEVBQUUsQ0FBQztZQUNqQixPQUFPLEVBQUUsSUFBNEM7U0FDdEQsQ0FBQTtJQUNILENBQUM7SUFFRCxLQUFLLEVBQUU7UUFDTCxXQUFXLENBQUUsS0FBSztZQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVE7Z0JBQUUsT0FBTTtZQUUxQixJQUFJLEtBQUs7Z0JBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFBOztnQkFDMUIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFBO1FBQ3hCLENBQUM7S0FDRjtJQUVELGFBQWE7UUFDWCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7SUFDdEIsQ0FBQztJQUVELE9BQU8sRUFBRTtRQUNQLGFBQWE7WUFDWCxNQUFNLE9BQU8sR0FBRyxJQUFJLFFBQVEsQ0FBQztnQkFDM0IsU0FBUyxFQUFFO29CQUNULFFBQVEsRUFBRSxJQUFJLENB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O1FBQ0gsQ0FBQztRQUNELFVBQVU7WUFDUixRQUFRLENBQUMsZUFBZ0IsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUE7WUFDL0QsTUFBTSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsY0FBcUMsQ0FBQyxDQUFBO1lBQy9FLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLGNBQXFDLENBQUMsQ0FBQTtRQUNuRixDQUFDO0tBQ0Y7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb21wb25lbnRzXG5pbXBvcnQgVk92ZXJsYXkgZnJvbSAnLi4vLi4vY29tcG9uZW50cy9WT3ZlcmxheSdcblxuLy8gVXRpbGl0aWVzXG5pbXBvcnQge1xuICBrZXlDb2RlcyxcbiAgYWRkT25jZUV2ZW50TGlzdGVuZXIsXG4gIGFkZFBhc3NpdmVFdmVudExpc3RlbmVyLFxuICBnZXRaSW5kZXgsXG4gIGNvbXBvc2VkUGF0aCxcbn0gZnJvbSAnLi4vLi4vdXRpbC9oZWxwZXJzJ1xuXG4vLyBUeXBlc1xuaW1wb3J0IFZ1ZSBmcm9tICd2dWUnXG5cbmludGVyZmFjZSBUb2dnbGVhYmxlIGV4dGVuZHMgVnVlIHtcbiAgaXNBY3RpdmU/OiBib29sZWFuXG59XG5cbmludGVyZmFjZSBTdGFja2FibGUgZXh0ZW5kcyBWdWUge1xuICBhY3RpdmVaSW5kZXg6IG51bWJlclxufVxuXG5pbnRlcmZhY2Ugb3B0aW9ucyB7XG4gIGFic29sdXRlPzogYm9vbGVhblxuICAkcmVmczoge1xuICAgIGRpYWxvZz86IEhUTUxFbGVtZW50XG4gICAgY29udGVudD86IEhUTUxFbGVtZW50XG4gIH1cbn1cblxuLyogQHZ1ZS9jb21wb25lbnQgKi9cbmV4cG9ydCBkZWZhdWx0IFZ1ZS5leHRlbmQ8VnVlICYgVG9nZ2xlYWJsZSAmIFN0YWNrYWJsZSAmIG9wdGlvbnM+KCkuZXh0ZW5kKHtcbiAgbmFtZTogJ292ZXJsYXlhYmxlJyxcblxuICBwcm9wczoge1xuICAgIGhpZGVPdmVybGF5OiBCb29sZWFuLFxuICAgIG92ZXJsYXlDb2xvcjogU3RyaW5nLFxuICAgIG92ZXJsYXlPcGFjaXR5OiBbTnVtYmVyLCBTdHJpbmddLFxuICB9LFxuXG4gIGRhdGEgKCkge1xuICAgIHJldHVybiB7XG4gICAgICBhbmltYXRpb25GcmFtZTogMCxcbiAgICAgIG92ZXJsYXk6IG51bGwgYXMgSW5zdGFuY2VUeXBlPHR5cGVvZiBWT3ZlcmxheT4gfCBudWxsLFxuICAgIH1cbiAgfSxcblxuICB3YXRjaDoge1xuICAgIGhpZGVPdmVybGF5ICh2YWx1ZSkge1xuICAgICAgaWYgKCF0aGlzLmlzQWN0aXZlKSByZXR1cm5cblxuICAgICAgaWYgKHZhbHVlKSB0aGlzLnJlbW92ZU92ZXJsYXkoKVxuICAgICAgZWxzZSB0aGlzLmdlbk92ZXJsYXkoKVxuICAgIH0sXG4gIH0sXG5cbiAgYmVmb3JlRGVzdHJveSAoKSB7XG4gICAgdGhpcy5yZW1vdmVPdmVybGF5KClcbiAgfSxcblxuICBtZXRob2RzOiB7XG4gICAgY3JlYXRlT3ZlcmxheSAoKSB7XG4gICAgICBjb25zdCBvdmVybGF5ID0gbmV3IFZPdmVybGF5KHtcbiAgICAgICAgcHJvcHNEYXRhOiB7XG4gICAgICAgICAgYWJzb2x1dGU6IHRoaXMuYWJzb2x1dGUsXG4gICAgICAgICAgdmFsdWU6IGZhbHNlLFxuICAgICAgICAgIGNvbG9yOiB0aGlzLm92ZXJsYXlDb2xvcixcbiAgICAgICAgICBvcGFjaXR5OiB0aGlzLm92ZXJsYXlPcGFjaXR5LFxuICAgICAgICB9LFxuICAgICAgfSlcblxuICAgICAgb3ZlcmxheS4kbW91bnQoKVxuXG4gICAgICBjb25zdCBwYXJlbnQgPSB0aGlzLmFic29sdXRlXG4gICAgICAgID8gdGhpcy4kZWwucGFyZW50Tm9kZVxuICAgICAgICA6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWFwcF0nKVxuXG4gICAgICBwYXJlbnQgJiYgcGFyZW50Lmluc2VydEJlZm9yZShvdmVybGF5LiRlbCwgcGFyZW50LmZpcnN0Q2hpbGQpXG5cbiAgICAgIHRoaXMub3ZlcmxheSA9IG92ZXJsYXlcbiAgICB9LFxuICAgIGdlbk92ZXJsYXkgKCkge1xuICAgICAgdGhpcy5oaWRlU2Nyb2xsKClcblxuICAgICAgaWYgKHRoaXMuaGlkZU92ZXJsYXkpIHJldHVyblxuXG4gICAgICBpZiAoIXRoaXMub3ZlcmxheSkgdGhpcy5jcmVhdGVPdmVybGF5KClcblxuICAgICAgdGhpcy5hbmltYXRpb25GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5vdmVybGF5KSByZXR1cm5cblxuICAgICAgICBpZiAodGhpcy5hY3RpdmVaSW5kZXggIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHRoaXMub3ZlcmxheS56SW5kZXggPSBTdHJpbmcodGhpcy5hY3RpdmVaSW5kZXggLSAxKVxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuJGVsKSB7XG4gICAgICAgICAgdGhpcy5vdmVybGF5LnpJbmRleCA9IGdldFpJbmRleCh0aGlzLiRlbClcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMub3ZlcmxheS52YWx1ZSA9IHRydWVcbiAgICAgIH0pXG5cbiAgICAgIHJldHVybiB0cnVlXG4gICAgfSxcbiAgICAvKiogcmVtb3ZlT3ZlcmxheShmYWxzZSkgd2lsbCBub3QgcmVzdG9yZSB0aGUgc2NvbGxiYXIgYWZ0ZXJ3YXJkcyAqL1xuICAgIHJlbW92ZU92ZXJsYXkgKHNob3dTY3JvbGwgPSB0cnVlKSB7XG4gICAgICBpZiAodGhpcy5vdmVybGF5KSB7XG4gICAgICAgIGFkZE9uY2VFdmVudExpc3RlbmVyKHRoaXMub3ZlcmxheS4kZWwsICd0cmFuc2l0aW9uZW5kJywgKCkgPT4ge1xuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICF0aGlzLm92ZXJsYXkgfHxcbiAgICAgICAgICAgICF0aGlzLm92ZXJsYXkuJGVsIHx8XG4gICAgICAgICAgICAhdGhpcy5vdmVybGF5LiRlbC5wYXJlbnROb2RlIHx8XG4gICAgICAgICAgICB0aGlzLm92ZXJsYXkudmFsdWUgfHxcbiAgICAgICAgICAgIHRoaXMuaXNBY3RpdmVcbiAgICAgICAgICApIHJldHVyblxuXG4gICAgICAgICAgdGhpcy5vdmVybGF5LiRlbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMub3ZlcmxheS4kZWwpXG4gICAgICAgICAgdGhpcy5vdmVybGF5LiRkZXN0cm95KClcbiAgICAgICAgICB0aGlzLm92ZXJsYXkgPSBudWxsXG4gICAgICAgIH0pXG5cbiAgICAgICAgLy8gQ2FuY2VsIGFuaW1hdGlvbiBmcmFtZSBpbiBjYXNlXG4gICAgICAgIC8vIG92ZXJsYXkgaXMgcmVtb3ZlZCBiZWZvcmUgaXRcbiAgICAgICAgLy8gaGFzIGZpbmlzaGVkIGl0cyBhbmltYXRpb25cbiAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5hbmltYXRpb25GcmFtZSlcblxuICAgICAgICB0aGlzLm92ZXJsYXkudmFsdWUgPSBmYWxzZVxuICAgICAgfVxuXG4gICAgICBzaG93U2Nyb2xsICYmIHRoaXMuc2hvd1Njcm9sbCgpXG4gICAgfSxcbiAgICBzY3JvbGxMaXN0ZW5lciAoZTogV2hlZWxFdmVudCAmIEtleWJvYXJkRXZlbnQpIHtcbiAgICAgIGlmIChlLnR5cGUgPT09ICdrZXlkb3duJykge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgWydJTlBVVCcsICdURVhUQVJFQScsICdTRUxFQ1QnXS5pbmNsdWRlcygoZS50YXJnZXQgYXMgRWxlbWVudCkudGFnTmFtZSkgfHxcbiAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vdnVldGlmeWpzL3Z1ZXRpZnkvaXNzdWVzLzQ3MTVcbiAgICAgICAgICAoZS50YXJnZXQgYXMgSFRNTEVsZW1lbnQpLmlzQ29udGVudEVkaXRhYmxlXG4gICAgICAgICkgcmV0dXJuXG5cbiAgICAgICAgY29uc3QgdXAgPSBba2V5Q29kZXMudXAsIGtleUNvZGVzLnBhZ2V1cF1cbiAgICAgICAgY29uc3QgZG93biA9IFtrZXlDb2Rlcy5kb3duLCBrZXlDb2Rlcy5wYWdlZG93bl1cblxuICAgICAgICBpZiAodXAuaW5jbHVkZXMoZS5rZXlDb2RlKSkge1xuICAgICAgICAgIChlIGFzIGFueSkuZGVsdGFZID0gLTFcbiAgICAgICAgfSBlbHNlIGlmIChkb3duLmluY2x1ZGVzKGUua2V5Q29kZSkpIHtcbiAgICAgICAgICAoZSBhcyBhbnkpLmRlbHRhWSA9IDFcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoZS50YXJnZXQgPT09IHRoaXMub3ZlcmxheSB8fFxuICAgICAgICAoZS50eXBlICE9PSAna2V5ZG93bicgJiYgZS50YXJnZXQgPT09IGRvY3VtZW50LmJvZHkpIHx8XG4gICAgICAgIHRoaXMuY2hlY2tQYXRoKGUpKSBlLnByZXZlbnREZWZhdWx0KClcbiAgICB9LFxuICAgIGhhc1Njcm9sbGJhciAoZWw/OiBFbGVtZW50KSB7XG4gICAgICBpZiAoIWVsIHx8IGVsLm5vZGVUeXBlICE9PSBOb2RlLkVMRU1FTlRfTk9ERSkgcmV0dXJuIGZhbHNlXG5cbiAgICAgIGNvbnN0IHN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwpXG4gICAgICByZXR1cm4gKChbJ2F1dG8nLCAnc2Nyb2xsJ10uaW5jbHVkZXMoc3R5bGUub3ZlcmZsb3dZISkgfHwgZWwudGFnTmFtZSA9PT0gJ1NFTEVDVCcpICYmIGVsLnNjcm9sbEhlaWdodCA+IGVsLmNsaWVudEhlaWdodCkgfHxcbiAgICAgICgoWydhdXRvJywgJ3Njcm9sbCddLmluY2x1ZGVzKHN0eWxlLm92ZXJmbG93WCEpKSAmJiBlbC5zY3JvbGxXaWR0aCA+IGVsLmNsaWVudFdpZHRoKVxuICAgIH0sXG4gICAgc2hvdWxkU2Nyb2xsIChlbDogRWxlbWVudCwgZTogV2hlZWxFdmVudCk6IGJvb2xlYW4ge1xuICAgICAgaWYgKGVsLmhhc0F0dHJpYnV0ZSgnZGF0YS1hcHAnKSkgcmV0dXJuIGZhbHNlXG5cbiAgICAgIGNvbnN0IGRpciA9IGUuc2hpZnRLZXkgfHwgZS5kZWx0YVggPyAneCcgOiAneSdcbiAgICAgIGNvbnN0IGRlbHRhID0gZGlyID09PSAneScgPyBlLmRlbHRhWSA6IGUuZGVsdGFYIHx8IGUuZGVsdGFZXG5cbiAgICAgIGxldCBhbHJlYWR5QXRTdGFydDogYm9vbGVhblxuICAgICAgbGV0IGFscmVhZHlBdEVuZDogYm9vbGVhblxuICAgICAgaWYgKGRpciA9PT0gJ3knKSB7XG4gICAgICAgIGFscmVhZHlBdFN0YXJ0ID0gZWwuc2Nyb2xsVG9wID09PSAwXG4gICAgICAgIGFscmVhZHlBdEVuZCA9IGVsLnNjcm9sbFRvcCArIGVsLmNsaWVudEhlaWdodCA9PT0gZWwuc2Nyb2xsSGVpZ2h0XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhbHJlYWR5QXRTdGFydCA9IGVsLnNjcm9sbExlZnQgPT09IDBcbiAgICAgICAgYWxyZWFkeUF0RW5kID0gZWwuc2Nyb2xsTGVmdCArIGVsLmNsaWVudFdpZHRoID09PSBlbC5zY3JvbGxXaWR0aFxuICAgICAgfVxuXG4gICAgICBjb25zdCBzY3JvbGxpbmdVcCA9IGRlbHRhIDwgMFxuICAgICAgY29uc3Qgc2Nyb2xsaW5nRG93biA9IGRlbHRhID4gMFxuXG4gICAgICBpZiAoIWFscmVhZHlBdFN0YXJ0ICYmIHNjcm9sbGluZ1VwKSByZXR1cm4gdHJ1ZVxuICAgICAgaWYgKCFhbHJlYWR5QXRFbmQgJiYgc2Nyb2xsaW5nRG93bikgcmV0dXJuIHRydWVcbiAgICAgIGlmICgoYWxyZWFkeUF0U3RhcnQgfHwgYWxyZWFkeUF0RW5kKSkge1xuICAgICAgICByZXR1cm4gdGhpcy5zaG91bGRTY3JvbGwoZWwucGFyZW50Tm9kZSBhcyBFbGVtZW50LCBlKVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9LFxuICAgIGlzSW5zaWRlIChlbDogRWxlbWVudCwgcGFyZW50OiBFbGVtZW50KTogYm9vbGVhbiB7XG4gICAgICBpZiAoZWwgPT09IHBhcmVudCkge1xuICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgfSBlbHNlIGlmIChlbCA9PT0gbnVsbCB8fCBlbCA9PT0gZG9jdW1lbnQuYm9keSkge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLmlzSW5zaWRlKGVsLnBhcmVudE5vZGUgYXMgRWxlbWVudCwgcGFyZW50KVxuICAgICAgfVxuICAgIH0sXG4gICAgY2hlY2tQYXRoIChlOiBXaGVlbEV2ZW50KSB7XG4gICAgICBjb25zdCBwYXRoID0gY29tcG9zZWRQYXRoKGUpXG5cbiAgICAgIGlmIChlLnR5cGUgPT09ICdrZXlkb3duJyAmJiBwYXRoWzBdID09PSBkb2N1bWVudC5ib2R5KSB7XG4gICAgICAgIGNvbnN0IGRpYWxvZyA9IHRoaXMuJHJlZnMuZGlhbG9nXG4gICAgICAgIC8vIGdldFNlbGVjdGlvbiByZXR1cm5zIG51bGwgaW4gZmlyZWZveCBpbiBzb21lIGVkZ2UgY2FzZXMsIGNhbiBiZSBpZ25vcmVkXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkID0gd2luZG93LmdldFNlbGVjdGlvbigpIS5hbmNob3JOb2RlIGFzIEVsZW1lbnRcbiAgICAgICAgaWYgKGRpYWxvZyAmJiB0aGlzLmhhc1Njcm9sbGJhcihkaWFsb2cpICYmIHRoaXMuaXNJbnNpZGUoc2VsZWN0ZWQsIGRpYWxvZykpIHtcbiAgICAgICAgICByZXR1cm4gIXRoaXMuc2hvdWxkU2Nyb2xsKGRpYWxvZywgZSlcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgfVxuXG4gICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcGF0aC5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgICAgY29uc3QgZWwgPSBwYXRoW2luZGV4XVxuXG4gICAgICAgIGlmIChlbCA9PT0gZG9jdW1lbnQpIHJldHVybiB0cnVlXG4gICAgICAgIGlmIChlbCA9PT0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KSByZXR1cm4gdHJ1ZVxuICAgICAgICBpZiAoZWwgPT09IHRoaXMuJHJlZnMuY29udGVudCkgcmV0dXJuIHRydWVcblxuICAgICAgICBpZiAodGhpcy5oYXNTY3JvbGxiYXIoZWwgYXMgRWxlbWVudCkpIHJldHVybiAhdGhpcy5zaG91bGRTY3JvbGwoZWwgYXMgRWxlbWVudCwgZSlcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRydWVcbiAgICB9LFxuICAgIGhpZGVTY3JvbGwgKCkge1xuICAgICAgaWYgKHRoaXMuJHZ1ZXRpZnkuYnJlYWtwb2ludC5zbUFuZERvd24pIHtcbiAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IS5jbGFzc0xpc3QuYWRkKCdvdmVyZmxvdy15LWhpZGRlbicpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhZGRQYXNzaXZlRXZlbnRMaXN0ZW5lcih3aW5kb3csICd3aGVlbCcsIHRoaXMuc2Nyb2xsTGlzdGVuZXIgYXMgRXZlbnRIYW5kbGVyTm9uTnVsbCwgeyBwYXNzaXZlOiBmYWxzZSB9KVxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMuc2Nyb2xsTGlzdGVuZXIgYXMgRXZlbnRIYW5kbGVyTm9uTnVsbClcbiAgICAgIH1cbiAgICB9LFxuICAgIHNob3dTY3JvbGwgKCkge1xuICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IS5jbGFzc0xpc3QucmVtb3ZlKCdvdmVyZmxvdy15LWhpZGRlbicpXG4gICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignd2hlZWwnLCB0aGlzLnNjcm9sbExpc3RlbmVyIGFzIEV2ZW50SGFuZGxlck5vbk51bGwpXG4gICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMuc2Nyb2xsTGlzdGVuZXIgYXMgRXZlbnRIYW5kbGVyTm9uTnVsbClcbiAgICB9LFxuICB9LFxufSlcbiJdfQ==