import Vue from 'vue';
// Directives
import Ripple from '../../directives/ripple';
// Utilities
import { getObjectValueByPath } from '../../util/helpers';
export default Vue.extend({
    name: 'routable',
    directives: {
        Ripple,
    },
    props: {
        activeClass: String,
        append: Boolean,
        disabled: Boolean,
        exact: {
            type: Boolean,
            default: undefined,
        },
        exactPath: Boolean,
        exactActiveClass: String,
        link: Boolean,
        href: [String, Object],
        to: [String, Object],
        nuxt: Boolean,
        replace: Boolean,
        ripple: {
            type: [Boolean, Object],
            default: null,
        },
        tag: String,
        target: String,
    },
    data: () => ({
        isActive: false,
        proxyClass: '',
    }),
    computed: {
        classes() {
            const classes = {};
            if (this.to)
                return classes;
            if (this.activeClass)
                classes[this.activeClass] = this.isActive;
            if (this.proxyClass)
                classes[this.proxyClass] = this.isActive;
            return classes;
        },
        computedRipple() {
            return this.ripple ?? (!this.disabled && this.isClickable);
        },
        isClickable() {
            if (this.disabled)
                return false;
            return Boolean(this.isLink ||
                this.$listeners.click ||
                this.$listeners['!click'] ||
                this.$attrs.tabindex);
        },
        isLink() {
            return this.to || this.href || this.link;
        },
        styles: () => ({}),
    },
    watch: {
        $route: 'onRouteChange',
    },
    mounted() {
        this.onRouteChange();
    },
    methods: {
        generateRouteLink() {
            let exact = this.exact;
            let tag;
            const data = {
                attrs: {
                    tabindex: 'tabindex' in this.$attrs ? this.$attrs.tabindex : undefined,
                },
                class: this.classes,
                style: this.styles,
                props: {},
                directives: [{
                        name: 'ripple',
                        value: this.computedRipple,
                    }],
                [this.to ? 'nativeOn' : 'on']: {
                    ...this.$listeners,
                    ...('click' in this ? { click: this.click } : undefined),
                },
                ref: 'link',
            };
            if (typeof this.exact === 'undefined') {
                exact = this.to === '/' ||
                    (this.to === Object(this.to) && this.to.path === '/');
            }
            if (this.to) {
                // Add a special activeClass hook
                // for component level styles
                let activeClass = this.activeClass;
                let exactActiveClass = this.exactActiveClass || activeClass;
                if (this.proxyClass) {
                    activeClass = `${activeClass} ${this.proxyClass}`.trim();
                    exactActiveClass = `${exactActiveClass} ${this.proxyClass}`.trim();
                }
                tag = this.nuxt ? 'nuxt-link' : 'router-link';
                Object.assign(data.props, {
                    to: this.to,
                    exact,
                    exactPath: this.exactPath,
                    activeClass,
                    exactActiveClass,
                    append: this.append,
                    replace: this.replace,
                });
            }
            else {
                tag = (this.href && 'a') || this.tag || 'div';
                if (tag === 'a' && this.href)
                    data.attrs.href = this.href;
            }
            if (this.target)
                data.attrs.target = this.target;
            return { tag, data };
        },
        onRouteChange() {
            if (!this.to || !this.$refs.link || !this.$route)
                return;
            const activeClass = `${this.activeClass || ''} ${this.proxyClass || ''}`.trim();
            const exactActiveClass = `${this.exactActiveClass || ''} ${this.proxyClass || ''}`.trim() || activeClass;
            const path = '_vnode.data.class.' + (this.exact ? exactActiveClass : activeClass);
            this.$nextTick(() => {
                /* istanbul ignore else */
                if (!getObjectValueByPath(this.$refs.link, path) === this.isActive) {
                    this.toggle();
                }
            });
        },
        toggle() {
            this.isActive = !this.isActive;
        },
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbWl4aW5zL3JvdXRhYmxlL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sR0FBNEIsTUFBTSxLQUFLLENBQUE7QUFFOUMsYUFBYTtBQUNiLE9BQU8sTUFBeUIsTUFBTSx5QkFBeUIsQ0FBQTtBQUUvRCxZQUFZO0FBQ1osT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFFekQsZUFBZSxHQUFHLENBQUMsTUFBTSxDQUFDO0lBQ3hCLElBQUksRUFBRSxVQUFVO0lBRWhCLFVBQVUsRUFBRTtRQUNWLE1BQU07S0FDUDtJQUVELEtBQUssRUFBRTtRQUNMLFdBQVcsRUFBRSxNQUFNO1FBQ25CLE1BQU0sRUFBRSxPQUFPO1FBQ2YsUUFBUSxFQUFFLE9BQU87UUFDakIsS0FBSyxFQUFFO1lBQ0wsSUFBSSxFQUFFLE9BQXdDO1lBQzlDLE9BQU8sRUFBRSxTQUFTO1NBQ25CO1FBQ0QsU0FBUyxFQUFFLE9BQU87UUFDbEIsZ0JBQWdCLEVBQUUsTUFBTTtRQUN4QixJQUFJLEVBQUUsT0FBTztRQUNiLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUM7UUFDdEIsRUFBRSxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztRQUNwQixJQUFJLEVBQUUsT0FBTztRQUNiLE9BQU8sRUFBRSxPQUFPO1FBQ2hCLE1BQU0sRUFBRTtZQUNOLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUM7WUFDdkIsT0FBTyxFQUFFLElBQUk7U0FDZDtRQUNELEdBQUcsRUFBRSxNQUFNO1FBQ1gsTUFBTSxFQUFFLE1BQU07S0FDZjtJQUVELElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ1gsUUFBUSxFQUFFLEtBQUs7UUFDZixVQUFVLEVBQUUsRUFBRTtLQUNmLENBQUM7SUFFRixRQUFRLEVBQUU7UUFDUixPQUFPO1lB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SUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU07Z0JBQUUsT0FBTTtZQUN4RCxNQUFNLFdBQVcsR0FBRyxHQUFHLElBQUksQ0FBQyxXQUFXLElBQUksRUFBRSxJQUFJLElBQUksQ0FBQyxVQUFVLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUE7WUFDL0UsTUFBTSxnQkFBZ0IsR0FBRyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxFQUFFLElBQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxXQUFXLENBQUE7WUFFeEcsTUFBTSxJQUFJLEdBQUcsb0JBQW9CLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUE7WUFFakYsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2xCLDBCQUEwQjtnQkFDMUIsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxRQUFRLEVBQUU7b0JBQ2xFLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQTtpQkFDZDtZQUNILENBQUMsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUNELE1BQU07WUFDSixJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQTtRQUNoQyxDQUFDO0tBQ0Y7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgVnVlLCB7IFZOb2RlRGF0YSwgUHJvcFR5cGUgfSBmcm9tICd2dWUnXG5cbi8vIERpcmVjdGl2ZXNcbmltcG9ydCBSaXBwbGUsIHsgUmlwcGxlT3B0aW9ucyB9IGZyb20gJy4uLy4uL2RpcmVjdGl2ZXMvcmlwcGxlJ1xuXG4vLyBVdGlsaXRpZXNcbmltcG9ydCB7IGdldE9iamVjdFZhbHVlQnlQYXRoIH0gZnJvbSAnLi4vLi4vdXRpbC9oZWxwZXJzJ1xuXG5leHBvcnQgZGVmYXVsdCBWdWUuZXh0ZW5kKHtcbiAgbmFtZTogJ3JvdXRhYmxlJyxcblxuICBkaXJlY3RpdmVzOiB7XG4gICAgUmlwcGxlLFxuICB9LFxuXG4gIHByb3BzOiB7XG4gICAgYWN0aXZlQ2xhc3M6IFN0cmluZyxcbiAgICBhcHBlbmQ6IEJvb2xlYW4sXG4gICAgZGlzYWJsZWQ6IEJvb2xlYW4sXG4gICAgZXhhY3Q6IHtcbiAgICAgIHR5cGU6IEJvb2xlYW4gYXMgUHJvcFR5cGU8Ym9vbGVhbiB8IHVuZGVmaW5lZD4sXG4gICAgICBkZWZhdWx0OiB1bmRlZmluZWQsXG4gICAgfSxcbiAgICBleGFjdFBhdGg6IEJvb2xlYW4sXG4gICAgZXhhY3RBY3RpdmVDbGFzczogU3RyaW5nLFxuICAgIGxpbms6IEJvb2xlYW4sXG4gICAgaHJlZjogW1N0cmluZywgT2JqZWN0XSxcbiAgICB0bzogW1N0cmluZywgT2JqZWN0XSxcbiAgICBudXh0OiBCb29sZWFuLFxuICAgIHJlcGxhY2U6IEJvb2xlYW4sXG4gICAgcmlwcGxlOiB7XG4gICAgICB0eXBlOiBbQm9vbGVhbiwgT2JqZWN0XSxcbiAgICAgIGRlZmF1bHQ6IG51bGwsXG4gICAgfSxcbiAgICB0YWc6IFN0cmluZyxcbiAgICB0YXJnZXQ6IFN0cmluZyxcbiAgfSxcblxuICBkYXRhOiAoKSA9PiAoe1xuICAgIGlzQWN0aXZlOiBmYWxzZSxcbiAgICBwcm94eUNsYXNzOiAnJyxcbiAgfSksXG5cbiAgY29tcHV0ZWQ6IHtcbiAgICBjbGFzc2VzICgpOiBvYmplY3Qge1xuICAgICAgY29uc3QgY2xhc3NlczogUmVjb3JkPHN0cmluZywgYm9vbGVhbj4gPSB7fVxuXG4gICAgICBpZiAodGhpcy50bykgcmV0dXJuIGNsYXNzZXNcblxuICAgICAgaWYgKHRoaXMuYWN0aXZlQ2xhc3MpIGNsYXNzZXNbdGhpcy5hY3RpdmVDbGFzc10gPSB0aGlzLmlzQWN0aXZlXG4gICAgICBpZiAodGhpcy5wcm94eUNsYXNzKSBjbGFzc2VzW3RoaXMucHJveHlDbGFzc10gPSB0aGlzLmlzQWN0aXZlXG5cbiAgICAgIHJldHVybiBjbGFzc2VzXG4gICAgfSxcbiAgICBjb21wdXRlZFJpcHBsZSAoKTogUmlwcGxlT3B0aW9ucyB8IGJvb2xlYW4ge1xuICAgICAgcmV0dXJuIHRoaXMucmlwcGxlID8/ICghdGhpcy5kaXNhYmxlZCAmJiB0aGlzLmlzQ2xpY2thYmxlKVxuICAgIH0sXG4gICAgaXNDbGlja2FibGUgKCk6IGJvb2xlYW4ge1xuICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHJldHVybiBmYWxzZVxuXG4gICAgICByZXR1cm4gQm9vbGVhbihcbiAgICAgICAgdGhpcy5pc0xpbmsgfHxcbiAgICAgICAgdGhpcy4kbGlzdGVuZXJzLmNsaWNrIHx8XG4gICAgICAgIHRoaXMuJGxpc3RlbmVyc1snIWNsaWNrJ10gfHxcbiAgICAgICAgdGhpcy4kYXR0cnMudGFiaW5kZXhcbiAgICAgIClcbiAgICB9LFxuICAgIGlzTGluayAoKTogYm9vbGVhbiB7XG4gICAgICByZXR1cm4gdGhpcy50byB8fCB0aGlzLmhyZWYgfHwgdGhpcy5saW5rXG4gICAgfSxcbiAgICBzdHlsZXM6ICgpID0+ICh7fSksXG4gIH0sXG5cbiAgd2F0Y2g6IHtcbiAgICAkcm91dGU6ICdvblJvdXRlQ2hhbmdlJyxcbiAgfSxcblxuICBtb3VudGVkICgpIHtcbiAgICB0aGlzLm9uUm91dGVDaGFuZ2UoKVxuICB9LFxuXG4gIG1ldGhvZHM6IHtcbiAgICBnZW5lcmF0ZVJvdXRlTGluayAoKSB7XG4gICAgICBsZXQgZXhhY3QgPSB0aGlzLmV4YWN0XG4gICAgICBsZXQgdGFnXG5cbiAgICAgIGNvbnN0IGRhdGE6IFZOb2RlRGF0YSA9IHtcbiAgICAgICAgYXR0cnM6IHtcbiAgICAgICAgICB0YWJpbmRleDogJ3RhYmluZGV4JyBpbiB0aGlzLiRhdHRycyA/IHRoaXMuJGF0dHJzLnRhYmluZGV4IDogdW5kZWZpbmVkLFxuICAgICAgICB9LFxuICAgICAgICBjbGFzczogdGhpcy5jbGFzc2VzLFxuICAgICAgICBzdHlsZTogdGhpcy5zdHlsZXMsXG4gICAgICAgIHByb3BzOiB7fSxcbiAgICAgICAgZGlyZWN0aXZlczogW3tcbiAgICAgICAgICBuYW1lOiAncmlwcGxlJyxcbiAgICAgICAgICB2YWx1ZTogdGhpcy5jb21wdXRlZFJpcHBsZSxcbiAgICAgICAgfV0sXG4gICAgICAgIFt0aGlzLnRvID8gJ25hdGl2ZU9uJyA6ICdvbiddOiB7XG4gICAgICAgICAgLi4udGhpcy4kbGlzdGVuZXJzLFxuICAgICAgICAgIC4uLignY2xpY2snIGluIHRoaXMgPyB7IGNsaWNrOiAodGhpcyBhcyBhbnkpLmNsaWNrIH0gOiB1bmRlZmluZWQpLCAvLyAjMTQ0NDdcbiAgICAgICAgfSxcbiAgICAgICAgcmVmOiAnbGluaycsXG4gICAgICB9XG5cbiAgICAgIGlmICh0eXBlb2YgdGhpcy5leGFjdCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgZXhhY3QgPSB0aGlzLnRvID09PSAnLycgfHxcbiAgICAgICAgICAodGhpcy50byA9PT0gT2JqZWN0KHRoaXMudG8pICYmIHRoaXMudG8ucGF0aCA9PT0gJy8nKVxuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy50bykge1xuICAgICAgICAvLyBBZGQgYSBzcGVjaWFsIGFjdGl2ZUNsYXNzIGhvb2tcbiAgICAgICAgLy8gZm9yIGNvbXBvbmVudCBsZXZlbCBzdHlsZXNcbiAgICAgICAgbGV0IGFjdGl2ZUNsYXNzID0gdGhpcy5hY3RpdmVDbGFzc1xuICAgICAgICBsZXQgZXhhY3RBY3RpdmVDbGFzcyA9IHRoaXMuZXhhY3RBY3RpdmVDbGFzcyB8fCBhY3RpdmVDbGFzc1xuXG4gICAgICAgIGlmICh0aGlzLnByb3h5Q2xhc3MpIHtcbiAgICAgICAgICBhY3RpdmVDbGFzcyA9IGAke2FjdGl2ZUNsYXNzfSAke3RoaXMucHJveHlDbGFzc31gLnRyaW0oKVxuICAgICAgICAgIGV4YWN0QWN0aXZlQ2xhc3MgPSBgJHtleGFjdEFjdGl2ZUNsYXNzfSAke3RoaXMucHJveHlDbGFzc31gLnRyaW0oKVxuICAgICAgICB9XG5cbiAgICAgICAgdGFnID0gdGhpcy5udXh0ID8gJ251eHQtbGluaycgOiAncm91dGVyLWxpbmsnXG4gICAgICAgIE9iamVjdC5hc3NpZ24oZGF0YS5wcm9wcywge1xuICAgICAgICAgIHRvOiB0aGlzLnRvLFxuICAgICAgICAgIGV4YWN0LFxuICAgICAgICAgIGV4YWN0UGF0aDogdGhpcy5leGFjdFBhdGgsXG4gICAgICAgICAgYWN0aXZlQ2xhc3MsXG4gICAgICAgICAgZXhhY3RBY3RpdmVDbGFzcyxcbiAgICAgICAgICBhcHBlbmQ6IHRoaXMuYXBwZW5kLFxuICAgICAgICAgIHJlcGxhY2U6IHRoaXMucmVwbGFjZSxcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRhZyA9ICh0aGlzLmhyZWYgJiYgJ2EnKSB8fCB0aGlzLnRhZyB8fCAnZGl2J1xuXG4gICAgICAgIGlmICh0YWcgPT09ICdhJyAmJiB0aGlzLmhyZWYpIGRhdGEuYXR0cnMhLmhyZWYgPSB0aGlzLmhyZWZcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMudGFyZ2V0KSBkYXRhLmF0dHJzIS50YXJnZXQgPSB0aGlzLnRhcmdldFxuXG4gICAgICByZXR1cm4geyB0YWcsIGRhdGEgfVxuICAgIH0sXG4gICAgb25Sb3V0ZUNoYW5nZSAoKSB7XG4gICAgICBpZiAoIXRoaXMudG8gfHwgIXRoaXMuJHJlZnMubGluayB8fCAhdGhpcy4kcm91dGUpIHJldHVyblxuICAgICAgY29uc3QgYWN0aXZlQ2xhc3MgPSBgJHt0aGlzLmFjdGl2ZUNsYXNzIHx8ICcnfSAke3RoaXMucHJveHlDbGFzcyB8fCAnJ31gLnRyaW0oKVxuICAgICAgY29uc3QgZXhhY3RBY3RpdmVDbGFzcyA9IGAke3RoaXMuZXhhY3RBY3RpdmVDbGFzcyB8fCAnJ30gJHt0aGlzLnByb3h5Q2xhc3MgfHwgJyd9YC50cmltKCkgfHwgYWN0aXZlQ2xhc3NcblxuICAgICAgY29uc3QgcGF0aCA9ICdfdm5vZGUuZGF0YS5jbGFzcy4nICsgKHRoaXMuZXhhY3QgPyBleGFjdEFjdGl2ZUNsYXNzIDogYWN0aXZlQ2xhc3MpXG5cbiAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi9cbiAgICAgICAgaWYgKCFnZXRPYmplY3RWYWx1ZUJ5UGF0aCh0aGlzLiRyZWZzLmxpbmssIHBhdGgpID09PSB0aGlzLmlzQWN0aXZlKSB7XG4gICAgICAgICAgdGhpcy50b2dnbGUoKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0sXG4gICAgdG9nZ2xlICgpIHtcbiAgICAgIHRoaXMuaXNBY3RpdmUgPSAhdGhpcy5pc0FjdGl2ZVxuICAgIH0sXG4gIH0sXG59KVxuIl19